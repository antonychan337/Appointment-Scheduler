<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Haircut</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration (must load before bridge) -->
    <script src="supabase-config.js"></script>
    <!-- Supabase Bridge (replaces shared-data.js) -->
    <script src="supabase-bridge.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            // Initialize EmailJS with the configured public key
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            if (emailConfig.publicKey) {
                emailjs.init(emailConfig.publicKey);
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .phone-container {
            max-width: 375px;
            margin: 20px auto;
            background: white;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 812px;
            position: relative;
        }
        .header {
            background: #2C3E50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 18px;
        }
        .lang-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .content {
            padding: 20px;
            height: calc(100% - 60px);
            overflow-y: auto;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .service-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .service-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .service-card.selected {
            background: #E3F2FD;
            border-color: #2C3E50;
        }
        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .checkbox.checked {
            background: #2C3E50;
            border-color: #2C3E50;
            color: white;
        }
        .next-button {
            background: #2C3E50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            cursor: pointer;
            border: none;
            width: 100%;
            font-size: 16px;
        }
        .next-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        /* Date picker styles now handled inline */
        .date-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
        }
        .date-card.selected {
            background: #E3F2FD;
            border-color: #2C3E50;
        }
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .time-slot {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        .time-slot.selected {
            background: #2C3E50;
            color: white;
        }
        .time-slot.unavailable {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
        }
        .summary-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .success-icon {
            width: 60px;
            height: 60px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            margin: 20px auto;
        }
        .back-button {
            background: white;
            color: #2C3E50;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #2C3E50;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            position: relative;
            margin-bottom: 20px;
        }
        .progress-fill {
            height: 100%;
            background: #2C3E50;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="header">
            <h1 id="app-title">Book Service</h1>
            <button class="lang-toggle" onclick="toggleLang()">中文</button>
        </div>

        <div class="content">
            <!-- Time Off Notice -->
            <div id="time-off-notice" style="display: none; background: #fff3cd; color: #856404; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
                <div style="display: flex; align-items: start;">
                    <span style="margin-right: 8px;">⚠️</span>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;" id="time-off-title">Owner Unavailable</div>
                        <div id="time-off-message" style="font-size: 14px;"></div>
                    </div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>

            <!-- Screen 1: Barber Selection -->
            <div id="barber-screen" class="screen active">
                <h2 id="select-barber">Select Your Barber</h2>
                <div style="margin-top: 20px;" id="barber-container">
                    <!-- Barbers will be loaded dynamically -->
                </div>
            </div>

            <!-- Screen 2: Service Selection -->
            <div id="service-screen" class="screen">
                <button class="back-button" onclick="goBack('barber-screen')" id="service-back" style="display: none;">← Back</button>
                <h2 id="select-service">Select Service</h2>
                <div style="margin-top: 20px;" id="services-container">
                    <!-- Services will be loaded dynamically -->
                </div>
                <button class="next-button" onclick="goToDateTime()" disabled id="service-next">Next</button>
            </div>

            <!-- Screen 3: Date & Time Selection -->
            <div id="datetime-screen" class="screen">
                <button class="back-button" onclick="goBack('service-screen')">← Back</button>
                <h2 id="select-datetime">Select Date & Time</h2>

                <h3 style="margin-top: 20px;" id="available-dates">Available Dates</h3>
                <div class="date-picker-container" style="padding: 20px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px;">
                    <div style="margin-bottom: 15px;">
                        <input type="date" id="appointment-date" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 5px; cursor: pointer;" onchange="onDateSelected()">
                    </div>
                    <div id="date-info" style="padding: 10px; border-radius: 5px; display: none;">
                        <!-- Will show availability info -->
                    </div>
                    <div id="selected-date-display" style="margin-top: 15px; padding: 15px; background: white; border-radius: 5px; display: none;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;" id="selected-label">Selected Date:</div>
                        <div id="selected-date-text" style="font-size: 18px; font-weight: 500; color: #333;"></div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;" id="available-times">Available Times</h3>
                <div class="time-slots" id="time-slots"></div>

                <button class="next-button" onclick="goToInfo()" disabled id="datetime-next">Next</button>
            </div>

            <!-- Screen 4: Customer Information -->
            <div id="info-screen" class="screen">
                <button class="back-button" onclick="goBack('datetime-screen')">← Back</button>
                <h2 id="your-info">Your Information</h2>

                <div class="form-group">
                    <label for="name" id="label-name">Name</label>
                    <input type="text" id="name" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="phone" id="label-phone">Phone</label>
                    <input type="tel" id="phone" placeholder="(555) 555-5555" maxlength="14" oninput="this.value = formatPhoneNumber(this.value)" onblur="this.value = formatPhoneNumber(this.value)">
                    <div id="phone-error" style="color: #f44336; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="email" id="label-email">Email</label>
                    <input type="email" id="email" placeholder="email@example.com">
                    <div id="email-error" style="color: #f44336; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>

                <button class="next-button" onclick="goToConfirmation()" id="info-next">Review Booking</button>
            </div>

            <!-- Screen 5: Confirmation -->
            <div id="confirmation-screen" class="screen">
                <button class="back-button" onclick="goBack('info-screen')">← Back</button>
                <h2 id="review-booking">Review Your Booking</h2>

                <div class="summary-card">
                    <div class="summary-row">
                        <span id="label-services">Service:</span>
                        <span id="selected-services"></span>
                    </div>
                    <div class="summary-row">
                        <span id="label-date">Date:</span>
                        <span id="selected-date"></span>
                    </div>
                    <div class="summary-row">
                        <span id="label-time">Time:</span>
                        <span id="selected-time"></span>
                    </div>
                    <div class="summary-row">
                        <span id="label-duration">Duration:</span>
                        <span id="total-duration"></span>
                    </div>
                    <div class="summary-row">
                        <span id="label-price">Total Price:</span>
                        <span id="total-price" style="font-weight: bold; color: #2C3E50;"></span>
                    </div>
                </div>

                <div class="summary-card">
                    <h3 id="contact-info">Contact Information</h3>
                    <div style="margin-top: 10px;">
                        <div id="contact-name"></div>
                        <div id="contact-phone"></div>
                        <div id="contact-email"></div>
                    </div>
                </div>

                <button class="next-button" onclick="confirmBooking()" id="confirm-button">Confirm Booking</button>
            </div>

            <!-- Screen 6: Success -->
            <div id="success-screen" class="screen">
                <div class="success-icon">✓</div>
                <h2 style="text-align: center;" id="booking-confirmed">Booking Confirmed!</h2>
                <p style="text-align: center; color: #666; margin-top: 10px;" id="confirmation-message">
                    We've sent a confirmation email with your booking details.
                </p>

                <div class="summary-card" style="margin-top: 30px;">
                    <h3 id="booking-details">Booking Details</h3>
                    <div style="margin-top: 15px;">
                        <div style="margin-bottom: 10px;">
                            <strong id="label-booking-id">Booking ID:</strong> <span id="booking-id"></span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong id="summary-services">Services:</strong> <span id="final-services"></span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong id="summary-datetime">Date & Time:</strong> <span id="final-datetime"></span>
                        </div>
                    </div>
                </div>

                <button class="next-button" onclick="startNew()" id="new-booking">Make Another Booking</button>
            </div>
        </div>
    </div>

    <script>
        // Check for preferred language on load
        let isZh = SharedData.getPreferredLanguage() === 'zh';
        let selectedBarberId = null;
        let selectedServices = [];
        let selectedDate = null;
        let selectedTime = null;
        let currentScreen = 'barber-screen';

        // Note: Booking policies are loaded dynamically when needed to ensure they're always up-to-date

        const translations = {
            zh: {
                appTitle: '预约服务',
                selectBarber: '选择理发师',
                selectService: '选择服务',
                nextBtn: '下一步',
                back: '← 返回',
                selectDateTime: '选择日期和时间',
                availableDates: '可选日期',
                availableTimes: '可选时间',
                yourInfo: '您的信息',
                labelName: '姓名',
                labelPhone: '电话',
                labelEmail: '邮箱',
                reviewBooking: '确认预约',
                labelServices: '服务：',
                labelDate: '日期：',
                labelTime: '时间：',
                labelDuration: '时长：',
                labelPrice: '总价：',
                contactInfo: '联系信息',
                confirmButton: '确认预约',
                bookingConfirmed: '预约成功！',
                confirmationMessage: '我们已发送确认邮件到您的邮箱。',
                bookingDetails: '预约详情',
                labelBookingId: '预约编号：',
                summaryServices: '服务项目：',
                summaryDateTime: '日期时间：',
                newBooking: '新建预约',
                cancellationPolicyLabel: '取消政策',
                selectDateFirst: '请先选择日期',
                services: {
                    "Men's Cut": '男士理发',
                    "Women's Cut": '女士理发',
                    "Children's Cut": '儿童理发',
                    "Hair Coloring": '染发',
                    "Highlights": '挑染',
                    "Perm": '烫发',
                    "Hair Treatment": '护理'
                },
                activeTime: '需在场时间',
                min: '分钟',
                placeholders: {
                    name: '请输入您的姓名',
                    phone: '请输入您的电话',
                    email: '请输入您的邮箱'
                }
            },
            en: {
                appTitle: 'Book Service',
                selectBarber: 'Select Your Barber',
                selectService: 'Select Service',
                nextBtn: 'Next',
                back: '← Back',
                selectDateTime: 'Select Date & Time',
                availableDates: 'Available Dates',
                availableTimes: 'Available Times',
                yourInfo: 'Your Information',
                labelName: 'Name',
                labelPhone: 'Phone',
                labelEmail: 'Email',
                reviewBooking: 'Review Your Booking',
                labelServices: 'Service:',
                labelDate: 'Date:',
                labelTime: 'Time:',
                labelDuration: 'Duration:',
                labelPrice: 'Total Price:',
                contactInfo: 'Contact Information',
                confirmButton: 'Confirm Booking',
                bookingConfirmed: 'Booking Confirmed!',
                confirmationMessage: "We've sent a confirmation email with your booking details.",
                bookingDetails: 'Booking Details',
                labelBookingId: 'Booking ID:',
                summaryServices: 'Services:',
                summaryDateTime: 'Date & Time:',
                newBooking: 'Make Another Booking',
                cancellationPolicyLabel: 'Cancellation Policy',
                selectDateFirst: 'Please select a date first',
                services: {
                    "Men's Cut": "Men's Cut",
                    "Women's Cut": "Women's Cut",
                    "Children's Cut": "Children's Cut",
                    "Hair Coloring": 'Hair Coloring',
                    "Highlights": 'Highlights',
                    "Perm": 'Perm',
                    "Hair Treatment": 'Hair Treatment'
                },
                activeTime: 'Active time',
                min: 'min',
                placeholders: {
                    name: 'Enter your name',
                    phone: 'Enter your phone number',
                    email: 'Enter your email'
                }
            }
        };

        // Service data is now loaded dynamically from SharedData.getServices()
        // No longer using hardcoded service data

        function toggleLang() {
            isZh = !isZh;
            // Save language preference globally
            SharedData.setPreferredLanguage(isZh ? 'zh' : 'en');
            updateLanguage();
            loadAvailableServices(); // Reload services with new language

            // Update date/time screen if active
            if (currentScreen === 'datetime-screen') {
                // Refresh date display if a date is selected
                if (selectedDate) {
                    const datePicker = document.getElementById('appointment-date');
                    if (datePicker && datePicker.value) {
                        onDateSelected(); // Refresh the date display with new language
                    }
                } else {
                    // If no date is selected, refresh the "Please select a date first" message
                    const timeSlots = document.getElementById('time-slots');
                    if (timeSlots) {
                        const t = isZh ? translations.zh : translations.en;
                        timeSlots.innerHTML = `<div style="text-align: center; padding: 20px; color: #666; background: #f5f5f5; border-radius: 10px;">${t.selectDateFirst}</div>`;
                    }
                }

                // Refresh cancellation policy
                const policyNotice = document.getElementById('policy-notice');
                if (policyNotice) {
                    policyNotice.remove();
                    displayCancellationPolicy(); // Re-display with new language
                }
            }
        }

        function updateLanguage() {
            const t = isZh ? translations.zh : translations.en;

            document.getElementById('app-title').textContent = t.appTitle;
            document.querySelector('.lang-toggle').textContent = isZh ? 'EN' : '中文';

            // Update all screens
            document.getElementById('select-barber').textContent = t.selectBarber;
            document.getElementById('select-service').textContent = t.selectService;
            document.getElementById('service-next').textContent = t.nextBtn;
            document.getElementById('select-datetime').textContent = t.selectDateTime;
            document.getElementById('available-dates').textContent = t.availableDates;
            document.getElementById('available-times').textContent = t.availableTimes;
            document.getElementById('datetime-next').textContent = t.nextBtn;
            document.getElementById('your-info').textContent = t.yourInfo;
            document.getElementById('label-name').textContent = t.labelName;
            document.getElementById('label-phone').textContent = t.labelPhone;
            document.getElementById('label-email').textContent = t.labelEmail;
            document.getElementById('info-next').textContent = t.reviewBooking;
            document.getElementById('review-booking').textContent = t.reviewBooking;
            document.getElementById('label-services').textContent = t.labelServices;
            document.getElementById('label-date').textContent = t.labelDate;
            document.getElementById('label-time').textContent = t.labelTime;
            document.getElementById('label-duration').textContent = t.labelDuration;
            document.getElementById('label-price').textContent = t.labelPrice;
            document.getElementById('contact-info').textContent = t.contactInfo;
            document.getElementById('confirm-button').textContent = t.confirmButton;
            document.getElementById('booking-confirmed').textContent = t.bookingConfirmed;
            document.getElementById('confirmation-message').textContent = t.confirmationMessage;
            document.getElementById('booking-details').textContent = t.bookingDetails;
            document.getElementById('label-booking-id').textContent = t.labelBookingId;
            document.getElementById('summary-services').textContent = t.summaryServices;
            document.getElementById('summary-datetime').textContent = t.summaryDateTime;
            document.getElementById('new-booking').textContent = t.newBooking;

            // Update placeholders with null checks
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');
            const notesInput = document.getElementById('notes');

            if (nameInput) nameInput.placeholder = t.placeholders.name;
            if (phoneInput) phoneInput.placeholder = t.placeholders.phone;
            if (emailInput) emailInput.placeholder = t.placeholders.email;
            if (notesInput && t.placeholders.notes) notesInput.placeholder = t.placeholders.notes;

            // Reload services with updated language - they will be rendered with correct translations
            if (currentScreen === 'services-screen') {
                if (selectedBarberId) {
                    loadServicesForBarber(selectedBarberId);
                } else {
                    loadAvailableServices();
                }
            }

            // Update price display for remaining cards
            const serviceCards = document.querySelectorAll('.service-card');
            serviceCards.forEach(card => {
                const priceDiv = card.querySelector('div[style*="color: #666"]');
                if (priceDiv) {
                    const match = priceDiv.textContent.match(/(\d+)\s*min.*\$(\d+)/);
                    if (match) {
                        priceDiv.textContent = `${match[1]} ${t.min} • $${match[2]}`;
                    }
                }
            });

            // Update back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.textContent = t.back;
            });

            // Update confirmation screen if active and data is available
            if (currentScreen === 'confirmation-screen' && selectedServices.length > 0 && selectedDate) {
                // Get service names - use what owner provided
                const allServices = SharedData.getServices();
                const serviceNames = selectedServices.map(s => {
                    const service = allServices[s];
                    if (!service) return '';
                    if (isZh) {
                        return service.name_zh || service.name_en || service.name || '';
                    } else {
                        return service.name_en || service.name_zh || service.name || '';
                    }
                });
                document.getElementById('selected-services').textContent = serviceNames.join(', ');

                // Re-format date
                const dateStr = isZh ?
                    `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日` :
                    selectedDate.toLocaleDateString();
                document.getElementById('selected-date').textContent = dateStr;

                // Update duration
                const services = SharedData.getServices();
            const totalDuration = selectedServices.reduce((sum, s) => {
                const service = services[s];
                return sum + (service ? service.duration : 0);
            }, 0);
                document.getElementById('total-duration').textContent = `${totalDuration} ${t.min}`;
            }

            // Update success screen if active and data is available
            if (currentScreen === 'success-screen' && selectedServices.length > 0 && selectedDate && selectedTime) {
                // Get service names - use what owner provided
                const allServices = SharedData.getServices();
                const serviceNames = selectedServices.map(s => {
                    const service = allServices[s];
                    if (!service) return '';
                    if (isZh) {
                        return service.name_zh || service.name_en || service.name || '';
                    } else {
                        return service.name_en || service.name_zh || service.name || '';
                    }
                });
                document.getElementById('final-services').textContent = serviceNames.join(', ');

                // Re-format date and time
                const finalDateStr = isZh ?
                    `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日` :
                    selectedDate.toLocaleDateString();
                document.getElementById('final-datetime').textContent = `${finalDateStr} ${selectedTime}`;
            }
        }

        // Load barbers for selection
        function loadBarbers() {
            const barbers = SharedData.getBarbersSync();
            const container = document.getElementById('barber-container');
            container.innerHTML = '';

            barbers.forEach(barber => {
                const card = document.createElement('div');
                card.className = 'service-card';
                card.onclick = function() { selectBarber(barber.id); };

                card.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${barber.name}</div>
                    </div>
                    <div class="checkbox" id="barber-check-${barber.id}"></div>
                `;

                container.appendChild(card);
            });
        }

        // Select a barber
        function selectBarber(barberId) {
            // Clear previous selection
            document.querySelectorAll('#barber-container .service-card').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('.checkbox');
                if (checkbox) {
                    checkbox.classList.remove('checked');
                    checkbox.innerHTML = '';
                }
            });

            // Set new selection
            selectedBarberId = barberId;
            const selectedCard = document.querySelector(`#barber-check-${barberId}`).parentElement;
            selectedCard.classList.add('selected');
            const checkbox = document.getElementById(`barber-check-${barberId}`);
            checkbox.classList.add('checked');
            checkbox.innerHTML = '✓';

            // Load services for selected barber and go to service screen
            loadServicesForBarber(barberId);
            showScreen('service-screen');
        }

        function toggleService(element, serviceId) {
            // First, deselect all other services
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
                const cb = card.querySelector('.checkbox');
                if (cb) {
                    cb.classList.remove('checked');
                    cb.innerHTML = '';
                }
            });

            // Clear the array and add only the selected service
            selectedServices = [];

            // Select the clicked service
            element.classList.add('selected');
            const checkbox = element.querySelector('.checkbox');
            checkbox.classList.add('checked');
            checkbox.innerHTML = '✓';
            selectedServices.push(serviceId);

            document.getElementById('service-next').disabled = selectedServices.length === 0;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
            updateProgress();
        }

        function updateProgress() {
            const screens = ['barber-screen', 'service-screen', 'datetime-screen', 'info-screen', 'confirmation-screen', 'success-screen'];
            const currentIndex = screens.indexOf(currentScreen);
            const progress = ((currentIndex + 1) / screens.length) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        function goToDateTime() {
            if (selectedServices.length === 0) return;
            showScreen('datetime-screen');
            generateDates();
            // Show message to select date first
            const timeSlots = document.getElementById('time-slots');
            const t = isZh ? translations.zh : translations.en;
            timeSlots.innerHTML = `<div style="text-align: center; padding: 20px; color: #666; background: #f5f5f5; border-radius: 10px;">${t.selectDateFirst}</div>`;
        }

        function generateDates() {
            // Initialize date picker with limits
            const datePicker = document.getElementById('appointment-date');
            const today = new Date();
            const maxDate = new Date();

            // Apply maximum advance booking policy - get fresh policies in case they were updated
            const policies = SharedData.getBookingPolicies();
            const maxDays = policies.maxBookingDays || 30;
            maxDate.setDate(maxDate.getDate() + maxDays);

            // Set min and max dates on the picker
            datePicker.min = today.toISOString().split('T')[0];
            datePicker.max = maxDate.toISOString().split('T')[0];

            // Clear any previous selection
            datePicker.value = '';
            selectedDate = null;
            selectedTime = null;

            // Hide date info initially
            const dateInfo = document.getElementById('date-info');
            if (dateInfo) {
                dateInfo.style.display = 'none';
            }
        }

        function onDateSelected() {
            console.log('[DEBUG] Date picker value:', document.getElementById('appointment-date').value);
            const datePicker = document.getElementById('appointment-date');
            const dateInfo = document.getElementById('date-info');

            if (!datePicker.value) {
                selectedDate = null;
                if (dateInfo) dateInfo.style.display = 'none';
                return;
            }

            // Parse the selected date
            // Parse date in local timezone
            const [year, month, day] = datePicker.value.split('-').map(Number);
            selectedDate = new Date(year, month - 1, day); // month is 0-indexed

            // Check if the store is open on this day
            let storeHours;
            try {
                storeHours = SharedData.getStoreHours();
            } catch (e) {
                storeHours = {
                    monday: { open: '09:00', close: '18:00', closed: false },
                    tuesday: { open: '09:00', close: '18:00', closed: false },
                    wednesday: { open: '09:00', close: '18:00', closed: false },
                    thursday: { open: '09:00', close: '18:00', closed: false },
                    friday: { open: '09:00', close: '20:00', closed: false },
                    saturday: { open: '10:00', close: '17:00', closed: false },
                    sunday: { open: '', close: '', closed: true }
                };
            }

            const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
            const dayHours = storeHours[dayName];
            const isClosed = !dayHours || dayHours.closed;

            // Show date info
            if (dateInfo) {
                const dayDisplay = isZh ?
                    ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][selectedDate.getDay()] :
                    selectedDate.toLocaleDateString('en', { weekday: 'long' });
                const dateDisplay = isZh ?
                    `${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日` :
                    selectedDate.toLocaleDateString('en', { month: 'long', day: 'numeric' });

                if (isClosed) {
                    dateInfo.innerHTML = `
                        <div style="color: #f44336; font-weight: bold;">
                            ${isZh ? '该日店铺休息' : 'Store is closed on this day'}
                        </div>
                    `;
                    dateInfo.style.background = '#ffebee';
                    selectedDate = null; // Clear selection if closed
                } else {
                    dateInfo.innerHTML = `
                        <div style="color: #4CAF50; font-weight: bold;">
                            ${dayDisplay}, ${dateDisplay}
                        </div>
                        <div style="color: #666; margin-top: 5px;">
                            ${isZh ? '营业时间' : 'Store Hours'}: ${dayHours.open} - ${dayHours.close}
                        </div>
                    `;
                    dateInfo.style.background = '#e8f5e9';
                }
                dateInfo.style.display = 'block';
            }

            // Generate time slots if date is valid
            if (!isClosed) {
                selectedTime = null; // Reset time when date changes
                generateTimeSlots();
                checkDateTimeComplete();
            } else {
                // Clear time slots if store is closed
                const timeSlots = document.getElementById('time-slots');
                if (timeSlots) {
                    timeSlots.innerHTML = `<div style="text-align: center; padding: 20px; color: #f44336; background: #ffebee; border-radius: 10px;">${isZh ? '该日店铺休息，请选择其他日期' : 'Store is closed on this day. Please select another date.'}</div>`;
                }
            }
        }

        function displayCancellationPolicy() {
            const policy = SharedData.getBookingPolicies();
            const minNoticeHours = policy.cancellationHours || 0;
            const policyNotice = document.getElementById('policy-notice');

            if (minNoticeHours > 0) {
                let policyText;
                if (minNoticeHours === 1) {
                    policyText = isZh ?
                        '需要至少提前1小时取消或更改预约' :
                        'Cancellations and changes require at least 1 hour notice';
                } else if (minNoticeHours < 24) {
                    policyText = isZh ?
                        `需要至少提前${minNoticeHours}小时取消或更改预约` :
                        `Cancellations and changes require at least ${minNoticeHours} hours notice`;
                } else {
                    const days = Math.floor(minNoticeHours / 24);
                    policyText = isZh ?
                        `需要至少提前${days}天取消或更改预约` :
                        `Cancellations and changes require at least ${days} day${days > 1 ? 's' : ''} notice`;
                }

                // Add the policy notice div if it doesn't exist
                if (!policyNotice) {
                    const timeSlotsDiv = document.getElementById('time-slots');
                    const noticeDiv = document.createElement('div');
                    noticeDiv.id = 'policy-notice';
                    noticeDiv.style = 'margin-bottom: 15px; padding: 12px; background: #fff3e0; border: 1px solid #ffb74d; border-radius: 5px;';
                    const t = isZh ? translations.zh : translations.en;
                    noticeDiv.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 16px; margin-right: 8px;">⚠️</span>
                            <div>
                                <div style="font-weight: bold; color: #f57c00; margin-bottom: 4px;">${t.cancellationPolicyLabel || (isZh ? '取消政策' : 'Cancellation Policy')}</div>
                                <div style="font-size: 13px; color: #666;">${policyText}</div>
                            </div>
                        </div>
                    `;
                    timeSlotsDiv.parentNode.insertBefore(noticeDiv, timeSlotsDiv);
                } else {
                    const policyTextDiv = policyNotice.querySelector('div[style*="font-size: 13px"]');
                    if (policyTextDiv) {
                        policyTextDiv.textContent = policyText;
                    }
                    policyNotice.style.display = 'block';
                }
            }
        }

        function generateTimeSlots() {
            // Ensure we have fresh store hours
            if (typeof SharedData !== 'undefined' && SharedData.storeHoursCache) {
                console.log('[Customer] Store hours cache state:', SharedData.storeHoursCache.thursday);
            }
            console.log('=== generateTimeSlots called ===');
            console.log('selectedDate:', selectedDate);
            if (selectedDate) {
                console.log('selectedDate string:', selectedDate.toString());
                console.log('selectedDate ISO:', selectedDate.toISOString());
                console.log('selectedDate local:', selectedDate.toLocaleDateString());
                console.log('Day of week:', selectedDate.toLocaleDateString('en-US', { weekday: 'long' }));
            }
            const timeSlots = document.getElementById('time-slots');
            timeSlots.innerHTML = '';

            if (!selectedDate) {
                const t = isZh ? translations.zh : translations.en;
                timeSlots.innerHTML = `<div style="text-align: center; color: #666;">${t.selectDateFirst}</div>`;
                return;
            }

            // Display cancellation policy
            displayCancellationPolicy();

            // Calculate total service duration using SharedData
            const services = SharedData.getServices();
            const totalDuration = selectedServices.reduce((sum, serviceId) => {
                const service = services[serviceId];
                return sum + (service ? service.duration : 30);
            }, 0);

            // Get available slots or use defaults
            let availableSlots;
            try {
                console.log('Calling getAvailableSlots with:', {
                    date: selectedDate,
                    totalDuration: totalDuration,
                    barberId: selectedBarberId
                });
                availableSlots = SharedData.getAvailableSlots(selectedDate, totalDuration, selectedBarberId);
                console.log('Slots returned:', availableSlots);
            } catch (e) {
                // Generate default slots if SharedData isn't available
                const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                const defaultHours = {
                    monday: { start: 9, end: 18 },
                    tuesday: { start: 9, end: 18 },
                    wednesday: { start: 9, end: 18 },
                    thursday: { start: 9, end: 18 },  // FIXED: Was missing or wrong
                    friday: { start: 9, end: 20 },
                    saturday: { start: 10, end: 17 },
                    sunday: null
                };

                availableSlots = [];
                const hours = defaultHours[dayName];
                if (hours) {
                    // Generate 15-minute intervals
                    const startMinutes = hours.start * 60;
                    const endMinutes = hours.end * 60;
                    const lastValidSlot = endMinutes - totalDuration;

                    for (let minutes = startMinutes; minutes <= lastValidSlot; minutes += 15) {
                        const hour = Math.floor(minutes / 60);
                        const min = minutes % 60;
                        availableSlots.push(`${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
                    }
                }
            }

            // Apply minimum booking notice policy - get fresh policies
            const policies = SharedData.getBookingPolicies();
            const now = new Date();
            const minBookingTime = new Date();
            minBookingTime.setHours(minBookingTime.getHours() + policies.minBookingHours);

            // Filter out slots that don't meet minimum booking notice
            if (selectedDate.toDateString() === now.toDateString() ||
                (selectedDate.getTime() - now.getTime()) < (policies.minBookingHours * 60 * 60 * 1000)) {
                availableSlots = availableSlots.filter(slot => {
                    const [hours, minutes] = slot.split(':').map(Number);
                    const slotTime = new Date(selectedDate);
                    slotTime.setHours(hours, minutes, 0, 0);
                    return slotTime >= minBookingTime;
                });
            }

            console.log('Available slots before filtering:', availableSlots.length);
    if (availableSlots.length === 0) {
        console.log('No slots returned from SharedData.getAvailableSlots!');
                const noSlotsMsg = isZh ? '该日期没有可用时段' : 'No available slots for this date';
                timeSlots.innerHTML = `<div style="text-align: center; color: #f44336;">${noSlotsMsg}</div>`;
                return;
            }

            // Filter out past times if showing today
            const currentTime = new Date();
            const isToday = selectedDate.toDateString() === currentTime.toDateString();
            const currentHours = currentTime.getHours();
            const currentMinutes = currentTime.getMinutes();

            const filteredSlots = availableSlots.filter(time => {
                if (!isToday) return true; // Show all times for future dates

                const [hours, minutes] = time.split(':').map(Number);
                const slotMinutes = hours * 60 + minutes;
                const nowMinutes = currentHours * 60 + currentMinutes;

                // Only show times that are at least 15 minutes in the future
                return slotMinutes > nowMinutes + 15;
            });

            if (filteredSlots.length === 0) {
                const noSlotsMsg = isZh ? '今天没有可用时段' : 'No available slots for today';
                timeSlots.innerHTML = `<div style="text-align: center; color: #f44336;">${noSlotsMsg}</div>`;
                return;
            }

            
            // Filter out slots that go past closing time
            const validSlots = filteredSlots.filter(time => {
                const [hours, minutes] = time.split(':').map(Number);
                const slotMinutes = hours * 60 + minutes;
                const endMinutes = slotMinutes + totalDuration;

                // Get closing time
                let closeMinutes = 18 * 60; // Default 6PM
                try {
                    const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                    const dayHours = SharedData.getStoreHours()[dayName];
                    if (dayHours && dayHours.close) {
                        const [closeHour, closeMin] = dayHours.close.split(':').map(Number);
                        closeMinutes = closeHour * 60 + closeMin;
                    }
                } catch (e) {
                    // Use defaults
                }

                // Only include slots that have enough time before closing
                return endMinutes <= closeMinutes;
            });

            // Display only valid slots
            validSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';

                // Format time for display in 24-hour format
                const displayTime = time;
                slot.textContent = displayTime;

                // Parse the time for this slot
                const [hours, minutes] = time.split(':').map(Number);
                const slotMinutes = hours * 60 + minutes;
                const endMinutes = slotMinutes + totalDuration;
                const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();

                // Get closing time (use default if SharedData not available)
                let closeMinutes = 18 * 60; // Default 6PM
                try {
                    const dayHours = SharedData.getStoreHours()[dayName];
                    if (dayHours && dayHours.close) {
                        const [closeHour, closeMin] = dayHours.close.split(':').map(Number);
                        closeMinutes = closeHour * 60 + closeMin;
                    }
                } catch (e) {
                    // Use defaults based on day
                    if (dayName === 'friday') closeMinutes = 20 * 60;
                    else if (dayName === 'saturday') closeMinutes = 17 * 60;
                }

                if (endMinutes > closeMinutes) {
                    slot.classList.add('unavailable');
                    slot.title = isZh ? '剩余时间不足' : 'Not enough time remaining';
                } else {
                    // Check if this time slot is already booked (considering active periods)
                    let isBooked = false;
                    try {
                        // Get the total duration of selected services for conflict checking
                        const totalDuration = selectedServices.reduce((sum, id) => {
                            const service = SharedData.getServices()[id];
                            return sum + (service ? service.duration : 0);
                        }, 0);

                        // Check if any active periods would conflict for the selected barber
                        isBooked = SharedData.isTimeSlotBooked(selectedDate, time, totalDuration, selectedBarber);
                    } catch (e) {
                        // If SharedData not available, skip booking check
                    }

                    if (isBooked) {
                        slot.classList.add('unavailable');
                        slot.title = isZh ? '已预约' : 'Already booked';
                    } else {
                        slot.onclick = () => selectTime(slot, time);
                    }
                }

                timeSlots.appendChild(slot);
            });
        }

        function selectTime(element, time) {
            document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = time;
            checkDateTimeComplete();
        }

        function checkDateTimeComplete() {
            document.getElementById('datetime-next').disabled = !selectedDate || !selectedTime;
        }

        function goToInfo() {
            if (!selectedDate || !selectedTime) return;
            showScreen('info-screen');
        }

        function goToConfirmation() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;

            if (!name || !phone || !email) {
                alert(isZh ? '请填写所有必填信息' : 'Please fill in all required information');
                return;
            }

            if (!validatePhone(phone)) {
                alert(isZh ? '请输入10位电话号码' : 'Please enter a valid 10-digit phone number');
                document.getElementById('phone').focus();
                return;
            }

            if (!validateEmail(email)) {
                alert(isZh ? '请输入有效的电子邮件地址' : 'Please enter a valid email address');
                document.getElementById('email').focus();
                return;
            }

            // Update summary
            const t = isZh ? translations.zh : translations.en;
            const allServices = SharedData.getServices();
            const serviceNames = selectedServices.map(s => {
                const service = allServices[s];
                if (!service) {
                    console.error('Service not found:', s);
                    return '';
                }
                if (isZh) {
                    return service.name_zh || service.name_en || service.name || '';
                } else {
                    return service.name_en || service.name_zh || service.name || '';
                }
            });
            document.getElementById('selected-services').textContent = serviceNames.join(', ');
            const dateStr = isZh ?
                `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日` :
                selectedDate.toLocaleDateString();
            document.getElementById('selected-date').textContent = dateStr;
            document.getElementById('selected-time').textContent = selectedTime;

            const services = SharedData.getServices();
            const totalDuration = selectedServices.reduce((sum, s) => {
                const service = services[s];
                return sum + (service ? service.duration : 0);
            }, 0);
            document.getElementById('total-duration').textContent = `${totalDuration} ${t.min}`;

            const totalPrice = selectedServices.reduce((sum, s) => {
                const service = services[s];
                return sum + (service ? service.price : 0);
            }, 0);
            document.getElementById('total-price').textContent = '$' + totalPrice;

            document.getElementById('contact-name').textContent = name;
            document.getElementById('contact-phone').textContent = phone;
            document.getElementById('contact-email').textContent = email;

            showScreen('confirmation-screen');
        }

        // Phone number formatting and validation
        function formatPhoneNumber(value) {
            // Remove all non-digits
            const cleaned = value.replace(/\D/g, '');

            // Format as (XXX) XXX-XXXX
            if (cleaned.length === 0) return '';
            if (cleaned.length <= 3) return `(${cleaned}`;
            if (cleaned.length <= 6) return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
            return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
        }

        function validatePhone(phone) {
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length === 10;
        }

        function validateEmail(email) {
            return email.includes('@') && email.indexOf('@') > 0 && email.indexOf('@') < email.length - 1;
        }

        // Make functions available globally for inline event handlers
        window.formatPhoneNumber = formatPhoneNumber;
        window.confirmCancellation = confirmCancellation;

        function confirmBooking() {
            // Gather booking information
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;

            const t = isZh ? translations.zh : translations.en;
            const services = SharedData.getServices();
            const serviceNames = selectedServices.map(s => {
                const service = services[s];
                if (isZh) {
                    return service.name_zh || service.name_en || service.name || '';
                } else {
                    return service.name_en || service.name_zh || service.name || '';
                }
            });
            const totalDuration = selectedServices.reduce((sum, s) => {
                const service = services[s];
                return sum + (service ? service.duration : 0);
            }, 0);
            const totalPrice = selectedServices.reduce((sum, s) => {
                const service = services[s];
                return sum + (service ? service.price : 0);
            }, 0);

            // Collect active periods if any services have them
            const activePeriods = [];
            let currentOffset = 0;

            // services already declared above, no need to redeclare

            selectedServices.forEach(serviceId => {
                const service = services[serviceId];
                if (service && service.activePeriods && service.activePeriods.length > 0) {
                    // Add this service's active periods with proper offset
                    service.activePeriods.forEach(period => {
                        activePeriods.push({
                            start: currentOffset + period.start,
                            end: currentOffset + period.end
                        });
                    });
                } else if (service) {
                    // If no active periods, the entire duration is active
                    activePeriods.push({
                        start: currentOffset,
                        end: currentOffset + service.duration
                    });
                }
                currentOffset += service ? service.duration : 0;
            });

            // Create appointment object
            // Format date as YYYY-MM-DD to avoid timezone issues
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            const appointment = {
                barberId: selectedBarberId,
                services: selectedServices,
                serviceNames: serviceNames,
                date: dateStr,
                time: selectedTime,
                totalDuration: totalDuration,
                totalPrice: totalPrice,
                activePeriods: activePeriods,
                customerName: name,
                customerPhone: phone,
                customerEmail: email,
                notes: ''
            };
            
            // Store customer's language preference for email purposes
            if (email) {
                localStorage.setItem(`customerLang_${email}`, isZh ? 'zh' : 'en');
            }

            // Save appointment
            let bookingId;
            try {
                // Check if shop context is set
                const currentShopId = SharedData.getCurrentShopId();
                if (!currentShopId) {
                    console.error('No shop ID set - cannot save appointment');
                    alert(isZh ? '无法保存预约。请刷新页面后重试。' : 'Unable to save appointment. Please refresh the page and try again.');
                    return;
                }

                bookingId = SharedData.saveAppointment(appointment);
                if (!bookingId) {
                    console.error('Failed to get booking ID');
                    alert(isZh ? '保存预约失败。请重试。' : 'Failed to save appointment. Please try again.');
                    return;
                }

                // Send confirmation email
                SharedData.sendConfirmationEmail(appointment);
            } catch (e) {
                console.error('Error saving appointment:', e);
                // Fallback booking ID if SharedData not available
                bookingId = 'BK' + Math.random().toString(36).substr(2, 9).toUpperCase();
                alert(isZh ? '预约可能未成功保存。请联系店铺确认。' : 'Appointment may not have been saved. Please contact the shop to confirm.');
            }

            document.getElementById('booking-id').textContent = bookingId;
            document.getElementById('final-services').textContent = serviceNames.join(', ');
            const finalDateStr = isZh ?
                `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日` :
                selectedDate.toLocaleDateString();
            document.getElementById('final-datetime').textContent =
                `${finalDateStr} ${selectedTime}`;

            showScreen('success-screen');
        }

        function goBack(screenId) {
            showScreen(screenId);
        }

        function handleBookingAction(action, bookingId) {
            // Get the appointment
            const appointment = SharedData.getAppointmentById(bookingId);

            if (!appointment) {
                alert(isZh ? '预约未找到' : 'Appointment not found');
                // Redirect to normal booking flow
                loadAvailableServices();
                updateLanguage();
                updateProgress();
                return;
            }

            if (action === 'modify') {
                handleModification(appointment);
            } else if (action === 'cancel') {
                handleCancellation(appointment);
            }
        }

        function checkCancellationPolicy(appointment) {
            const policy = SharedData.getBookingPolicies();
            const minNoticeHours = policy.cancellationHours || 0;

            if (minNoticeHours === 0) {
                return { allowed: true };
            }

            // Calculate hours until appointment
            const appointmentDateTime = new Date(appointment.date + 'T' + appointment.time);
            const now = new Date();
            const hoursUntilAppointment = (appointmentDateTime - now) / (1000 * 60 * 60);

            if (hoursUntilAppointment < minNoticeHours) {
                let message;
                if (minNoticeHours === 1) {
                    message = isZh ?
                        '预约必须在开始前至少1小时取消或更改' :
                        'Appointments must be cancelled or rescheduled at least 1 hour in advance';
                } else if (minNoticeHours < 24) {
                    message = isZh ?
                        `预约必须在开始前至少${minNoticeHours}小时取消或更改` :
                        `Appointments must be cancelled or rescheduled at least ${minNoticeHours} hours in advance`;
                } else {
                    const days = Math.floor(minNoticeHours / 24);
                    message = isZh ?
                        `预约必须在开始前至少${days}天取消或更改` :
                        `Appointments must be cancelled or rescheduled at least ${days} day${days > 1 ? 's' : ''} in advance`;
                }
                return { allowed: false, message };
            }

            return { allowed: true };
        }

        function handleModification(appointment) {
            // Check cancellation policy
            const policyCheck = checkCancellationPolicy(appointment);
            if (!policyCheck.allowed) {
                alert(policyCheck.message);
                window.location.href = window.location.pathname;
                return;
            }

            // Show a modification header
            const headerTitle = document.getElementById('app-title');
            headerTitle.textContent = isZh ? '修改预约' : 'Modify Appointment';

            // Add current appointment info banner
            const contentDiv = document.querySelector('.content');
            const currentBookingBanner = document.createElement('div');
            currentBookingBanner.style = 'background: #e3f2fd; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #2196F3;';
            currentBookingBanner.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">${isZh ? '当前预约' : 'Current Appointment'}</div>
                <div style="font-size: 14px;">
                    <div>${isZh ? '预约ID' : 'Booking ID'}: ${appointment.id}</div>
                    <div>${isZh ? '服务' : 'Services'}: ${appointment.serviceNames.join(', ')}</div>
                    <div>${isZh ? '日期' : 'Date'}: ${appointment.date}</div>
                    <div>${isZh ? '时间' : 'Time'}: ${SharedData.formatTime(appointment.time)}</div>
                </div>
            `;
            contentDiv.insertBefore(currentBookingBanner, contentDiv.firstChild);

            // Pre-select services
            selectedServices = appointment.services || [];

            // Pre-fill customer information
            setTimeout(() => {
                document.getElementById('name').value = appointment.customerName || '';
                document.getElementById('phone').value = appointment.customerPhone || '';
                document.getElementById('email').value = appointment.customerEmail || '';
            }, 100);

            // Modify the confirm booking function to update instead of create
            window.originalConfirmBooking = window.confirmBooking;
            window.confirmBooking = function() {
                modifyAppointment(appointment.id);
            };

            // Load services and start normal flow
            loadAvailableServices();
            updateLanguage();
            updateProgress();
        }

        function modifyAppointment(appointmentId) {
            // Gather updated information
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;

            const t = isZh ? translations.zh : translations.en;
            const services = SharedData.getServices();
            const serviceNames = selectedServices.map(s => {
                const service = services[s];
                if (isZh) {
                    return service.name_zh || service.name_en || service.name || '';
                } else {
                    return service.name_en || service.name_zh || service.name || '';
                }
            });
            const totalDuration = selectedServices.reduce((sum, s) => {
                const service = services[s];
                return sum + (service ? service.duration : 0);
            }, 0);
            const totalPrice = selectedServices.reduce((sum, s) => {
                const service = services[s];
                return sum + (service ? service.price : 0);
            }, 0);

            // Format date
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            // Update appointment
            const updates = {
                services: selectedServices,
                serviceNames: serviceNames,
                date: dateStr,
                time: selectedTime,
                totalDuration: totalDuration,
                totalPrice: totalPrice,
                customerName: name,
                customerPhone: phone,
                customerEmail: email
            };

            // Get the old appointment before updating
            const oldAppointment = SharedData.getAppointmentById(appointmentId);

            const success = SharedData.updateAppointment(appointmentId, updates);

            if (success) {
                // Send rescheduled email with both old and new details
                const updatedAppointment = SharedData.getAppointmentById(appointmentId);
                SharedData.sendRescheduledEmail(updatedAppointment, oldAppointment);

                // Show success
                document.getElementById('booking-id').textContent = appointmentId;
                document.getElementById('final-services').textContent = serviceNames.join(', ');
                const finalDateStr = isZh ?
                    `${selectedDate.getFullYear()}年${selectedDate.getMonth() + 1}月${selectedDate.getDate()}日` :
                    selectedDate.toLocaleDateString();
                const finalTime = SharedData.formatTime ? SharedData.formatTime(selectedTime) : selectedTime;
                document.getElementById('final-datetime').textContent = `${finalDateStr} ${finalTime}`;

                // Update success message
                const successTitle = document.getElementById('booking-confirmed');
                successTitle.textContent = isZh ? '预约已更新！' : 'Appointment Updated!';

                showScreen('success-screen');
            } else {
                alert(isZh ? '更新失败' : 'Update failed');
            }
        }

        function handleCancellation(appointment) {
            // Check cancellation policy
            const policyCheck = checkCancellationPolicy(appointment);
            if (!policyCheck.allowed) {
                alert(policyCheck.message);
                window.location.href = window.location.pathname;
                return;
            }

            // Create cancellation screen
            const contentDiv = document.querySelector('.content');
            contentDiv.innerHTML = `
                <div style="padding: 20px;">
                    <h2 style="text-align: center; color: #f44336;">${isZh ? '取消预约' : 'Cancel Appointment'}</h2>

                    <div style="background: #ffebee; padding: 15px; margin: 20px 0; border-radius: 8px; border: 1px solid #f44336;">
                        <div style="font-weight: bold; margin-bottom: 10px;">${isZh ? '预约详情' : 'Appointment Details'}</div>
                        <div style="font-size: 14px;">
                            <div style="margin: 5px 0;">${isZh ? '预约ID' : 'Booking ID'}: ${appointment.id}</div>
                            <div style="margin: 5px 0;">${isZh ? '客户' : 'Customer'}: ${appointment.customerName}</div>
                            <div style="margin: 5px 0;">${isZh ? '服务' : 'Services'}: ${appointment.serviceNames.join(', ')}</div>
                            <div style="margin: 5px 0;">${isZh ? '日期' : 'Date'}: ${appointment.date}</div>
                            <div style="margin: 5px 0;">${isZh ? '时间' : 'Time'}: ${SharedData.formatTime(appointment.time)}</div>
                            <div style="margin: 5px 0;">${isZh ? '时长' : 'Duration'}: ${appointment.totalDuration} ${isZh ? '分钟' : 'minutes'}</div>
                            <div style="margin: 5px 0;">${isZh ? '价格' : 'Price'}: $${appointment.totalPrice}</div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            ${isZh ? '取消原因（可选）' : 'Reason for cancellation (optional)'}
                        </label>
                        <textarea id="cancel-reason"
                                  style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px; min-height: 80px;"
                                  placeholder="${isZh ? '请告诉我们取消的原因...' : 'Please tell us why you are cancelling...'}"></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="confirmCancellation('${appointment.id}')"
                                style="background: #f44336; color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin: 0 10px;">
                            ${isZh ? '确认取消' : 'Confirm Cancellation'}
                        </button>
                        <button onclick="window.location.href = window.location.pathname"
                                style="background: #e0e0e0; color: #333; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin: 0 10px;">
                            ${isZh ? '返回' : 'Go Back'}
                        </button>
                    </div>
                </div>
            `;
        }

        function confirmCancellation(appointmentId) {
            if (confirm(isZh ? '确定要取消此预约吗？' : 'Are you sure you want to cancel this appointment?')) {
                const reason = document.getElementById('cancel-reason').value;

                // Get the appointment details before deleting
                const appointment = SharedData.getAppointmentById(appointmentId);

                // Delete the appointment
                SharedData.deleteAppointment(appointmentId);

                // Send cancellation email
                if (appointment) {
                    SharedData.sendCancellationEmail(appointment);
                }

                // Store cancellation record
                const cancellations = JSON.parse(localStorage.getItem('cancellations') || '[]');
                cancellations.push({
                    appointmentId: appointmentId,
                    reason: reason,
                    cancelledAt: new Date().toISOString()
                });
                localStorage.setItem('cancellations', JSON.stringify(cancellations));

                // Show success message
                const contentDiv = document.querySelector('.content');
                contentDiv.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <div style="font-size: 48px; color: #4CAF50; margin-bottom: 20px;">✓</div>
                        <h2>${isZh ? '预约已取消' : 'Appointment Cancelled'}</h2>
                        <p style="color: #666; margin: 20px 0;">
                            ${isZh ? '您的预约已成功取消。' : 'Your appointment has been successfully cancelled.'}
                        </p>
                        <button onclick="window.location.href = window.location.pathname"
                                style="background: #2196F3; color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px;">
                            ${isZh ? '预约新服务' : 'Book New Service'}
                        </button>
                    </div>
                `;
            }
        }

        function startNew() {
            // Reset all selections
            selectedBarberId = null;
            selectedServices = [];
            selectedDate = null;
            selectedTime = null;

            // Reset forms
            document.getElementById('name').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('email').value = '';

            // Reset service selections
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('.checkbox');
                if (checkbox) {
                    checkbox.classList.remove('checked');
                    checkbox.innerHTML = '';
                }
            });

            document.getElementById('service-next').disabled = true;

            // Check number of barbers and show appropriate screen
            const barbers = SharedData.getBarbersSync();
            if (barbers.length === 1) {
                // Single barber - skip barber selection and go straight to services
                selectedBarberId = barbers[0].id;
                loadServicesForBarber(selectedBarberId);
                showScreen('service-screen');
            } else {
                // Multiple barbers - show barber selection screen
                loadBarbers();
                showScreen('barber-screen');
            }
        }

        function checkTimeOff() {
            const timeOff = localStorage.getItem('timeOff');
            const notice = document.getElementById('time-off-notice');

            if (timeOff) {
                const data = JSON.parse(timeOff);
                const startDate = new Date(data.startDate + 'T' + data.startTime);
                const endDate = new Date(data.endDate + 'T' + data.endTime);
                const now = new Date();

                // Format dates for display
                const formatDate = (date) => {
                    if (isZh) {
                        return `${date.getMonth() + 1}月${date.getDate()}日`;
                    }
                    return date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
                };

                const formatTime = (timeStr) => {
                    const [hour, minute] = timeStr.split(':').map(Number);
                    if (isZh) {
                        return `${hour}:${minute.toString().padStart(2, '0')}`;
                    }
                    // Use 24-hour format
                    return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                };

                // Update notice text
                const titleElement = document.getElementById('time-off-title');
                const messageElement = document.getElementById('time-off-message');

                titleElement.textContent = isZh ? '店主休假通知' : 'Owner Unavailable';

                if (data.startDate === data.endDate) {
                    // Single day
                    messageElement.textContent = isZh ?
                        `店主将在${formatDate(startDate)} ${formatTime(data.startTime)}至${formatTime(data.endTime)}期间休假。` :
                        `The owner will be unavailable on ${formatDate(startDate)} from ${formatTime(data.startTime)} to ${formatTime(data.endTime)}.`;
                } else {
                    // Multiple days
                    messageElement.textContent = isZh ?
                        `店主将在${formatDate(startDate)} ${formatTime(data.startTime)}至${formatDate(endDate)} ${formatTime(data.endTime)}期间休假。` :
                        `The owner will be unavailable from ${formatDate(startDate)} ${formatTime(data.startTime)} to ${formatDate(endDate)} ${formatTime(data.endTime)}.`;
                }

                if (data.reason && data.reason !== 'Time Off') {
                    messageElement.textContent += isZh ? ` (${data.reason})` : ` (${data.reason})`;
                }

                notice.style.display = 'block';
            } else {
                notice.style.display = 'none';
            }
        }

        function loadServicesForBarber(barberId) {
            console.log('[DEBUG] loadServicesForBarber called with barberId:', barberId);
            const barber = SharedData.getBarberById(barberId);
            const allServices = SharedData.getServices();

            console.log('[DEBUG] Barber object:', barber);
            console.log('[DEBUG] Barber.services:', barber?.services);
            console.log('[DEBUG] All available services:', allServices);

            // Handle both array and object formats for barber.services
            let barberServiceIds;
            console.log('[DEBUG] Barber services format:', typeof barber.services, barber.services);

            // Check if this is the only barber or if they're the owner
            const barbers = SharedData.getBarbersSync();
            const isSingleBarber = barbers.length === 1;
            const isOwnerBarber = barber?.isOwner === true;

            if ((isSingleBarber || isOwnerBarber) && (!barber.services || Object.keys(barber.services).length === 0)) {
                // If single barber (or owner) with no services assigned, show ALL enabled services
                console.log('[DEBUG] Single/Owner barber with no services - showing all enabled services');
                barberServiceIds = Object.keys(allServices).filter(id => allServices[id].enabled);
            } else if (Array.isArray(barber.services)) {
                barberServiceIds = barber.services;
            } else if (barber.services && typeof barber.services === 'object') {
                // If it's an object, get the keys that have truthy values
                barberServiceIds = Object.keys(barber.services).filter(key => barber.services[key]);

                // If no services assigned but multiple barbers exist, still show all enabled services
                if (barberServiceIds.length === 0) {
                    console.warn('[DEBUG] ⚠️ Barber has no services assigned! Showing all enabled services as fallback');
                    barberServiceIds = Object.keys(allServices).filter(id => allServices[id].enabled);
                }
            } else {
                // Fallback: show all enabled services
                console.warn('[DEBUG] ⚠️ Unknown service format! Showing all enabled services as fallback');
                barberServiceIds = Object.keys(allServices).filter(id => allServices[id].enabled);
            }

            const container = document.getElementById('services-container');
            container.innerHTML = '';

            // Show/hide back button based on number of barbers
            // Note: barbers variable already declared above on line 1687
            const backButton = document.getElementById('service-back');
            if (backButton) {
                backButton.style.display = barbers.length > 1 ? 'block' : 'none';
            }

            const t = isZh ? translations.zh : translations.en;

            // Only show services that the barber offers
            console.log('[DEBUG] Barber service IDs:', barberServiceIds);
            console.log('[DEBUG] All services:', Object.keys(allServices));

            // Filter for enabled services first
            const enabledServiceIds = barberServiceIds.filter(serviceId => {
                const service = allServices[serviceId];
                return service && service.enabled;
            });

            // Check if barber has any ENABLED services
            if (enabledServiceIds.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336; background: #ffebee; border-radius: 10px;">
                        <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
                        ${isZh ?
                            '当前没有可用的服务。请稍后再试。' :
                            'No services are currently available. Please try again later.'}
                    </div>`;
                return;
            }

            enabledServiceIds.forEach(serviceId => {
                const service = allServices[serviceId];

                const card = document.createElement('div');
                card.className = 'service-card';
                card.onclick = function() { toggleService(this, serviceId); };

                // Display logic: show what owner provided
                // If both languages provided, show primary first, secondary below
                // If only one language provided, show that language
                let primaryName = '';
                let secondaryName = '';

                if (isZh) {
                    // Chinese mode
                    primaryName = service.name_zh || service.name_en || service.name || '';
                    // Only show secondary if both languages were provided
                    if (service.name_zh && service.name_en) {
                        secondaryName = service.name_en;
                    }
                } else {
                    // English mode
                    primaryName = service.name_en || service.name_zh || service.name || '';
                    // Only show secondary if both languages were provided
                    if (service.name_en && service.name_zh) {
                        secondaryName = service.name_zh;
                    }
                }

                const minText = t.min || 'min';

                card.innerHTML = `
                    <div>
                        <div class="service-name" style="font-weight: bold;">${primaryName}</div>
                        ${secondaryName ? `<div style="font-size: 12px; color: #888; margin-top: 2px;">${secondaryName}</div>` : ''}
                        <div style="font-size: 14px; color: #666;">
                            ${service.duration} ${minText} • $${service.price}
                        </div>
                    </div>
                    <div class="checkbox" id="check-${serviceId}"></div>
                `;

                container.appendChild(card);
            });

            // Check for time off notice
            checkTimeOff();
        }

        function loadAvailableServices() {
            // This is now a fallback for when no barber is selected
            if (selectedBarberId) {
                loadServicesForBarber(selectedBarberId);
                return;
            }

            const services = SharedData.getServices();
            const container = document.getElementById('services-container');
            container.innerHTML = '';

            // Check for time off notice
            checkTimeOff();

            Object.keys(services).forEach(serviceId => {
                const service = services[serviceId];
                if (!service.enabled) return; // Skip disabled services

                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.onclick = () => toggleService(serviceCard, serviceId);

                const t = isZh ? translations.zh : translations.en;

                // Display logic: show what owner provided
                let primaryName = '';
                let secondaryName = '';

                if (isZh) {
                    // Chinese mode
                    primaryName = service.name_zh || service.name_en || service.name || '';
                    // Only show secondary if both languages were provided
                    if (service.name_zh && service.name_en) {
                        secondaryName = service.name_en;
                    }
                } else {
                    // English mode
                    primaryName = service.name_en || service.name_zh || service.name || '';
                    // Only show secondary if both languages were provided
                    if (service.name_en && service.name_zh) {
                        secondaryName = service.name_zh;
                    }
                }

                const minText = isZh ? '分钟' : 'min';

                serviceCard.innerHTML = `
                    <div>
                        <div class="service-name">${primaryName}</div>
                        ${secondaryName ? `<div style="font-size: 12px; color: #888; margin-top: 2px;">${secondaryName}</div>` : ''}
                        <div style="color: #666; font-size: 14px;">${service.duration} ${minText} • $${service.price}</div>
                    </div>
                    <div class="checkbox"></div>
                `;

                container.appendChild(serviceCard);
            });

            if (container.children.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">No services available at this time</div>';
            }
        }

        // Initialize shop based on URL
        async function initializeShop() {
            try {
                // Check for shop slug in URL path or query param
                const pathParts = window.location.pathname.split('/');
                let shopSlug = null;

                // Check if URL is like /book/shop-slug
                if (pathParts.includes('book') && pathParts.length > pathParts.indexOf('book') + 1) {
                    shopSlug = pathParts[pathParts.indexOf('book') + 1];
                }

                // Fallback to query parameter ?shop=shop-slug
                const urlParams = new URLSearchParams(window.location.search);
                if (!shopSlug) {
                    shopSlug = urlParams.get('shop');
                }

                // For development/testing, use localStorage shopSlug
                if (!shopSlug) {
                    shopSlug = localStorage.getItem('shopSlug');
                }

                // For testing: Get shop ID from localStorage if set by test launcher
                const testShopId = localStorage.getItem('customer_shop_id');
                const testShopSlug = localStorage.getItem('customer_shop_slug');

                if (shopSlug || testShopId) {
                    // Set the shop context for customer
                    if (testShopId) {
                        localStorage.setItem('supabase_shop_id', testShopId);
                        console.log('Using test shop ID:', testShopId);
                    } else if (shopSlug) {
                        // Resolve shop ID from slug
                        console.log('Resolving shop ID from slug:', shopSlug);
                        const shopId = await SharedData.getShopIdFromSlug(shopSlug);
                        if (shopId) {
                            localStorage.setItem('supabase_shop_id', shopId);
                            console.log('Resolved shop ID:', shopId);
                        } else {
                            console.error('Failed to resolve shop ID from slug:', shopSlug);
                        }
                    }
                    console.log('Loading shop:', shopSlug || testShopSlug);
                }

                // Check for booking action (modification or cancellation)
                const action = urlParams.get('action');
                const bookingId = urlParams.get('bookingId');

                if (action && bookingId) {
                    handleBookingAction(action, bookingId);
                } else {
                    // Initialize SharedData and wait for data
                    console.log('Initializing SharedData for customer app...');
                    await SharedData.initialize();

                    // IMPORTANT: Force set the shop ID after initialization
                    // This ensures SharedData has the correct shop context
                    const shopIdToUse = localStorage.getItem('supabase_shop_id');
                    if (shopIdToUse) {
                        SharedData.setCurrentShopId(shopIdToUse);
                        console.log('Forced shop ID in SharedData:', shopIdToUse);

                        // Reload barbers after setting shop ID
                        SharedData.barbersCache = await SharedData.getBarbers();
                        console.log('Reloaded barbers after setting shop ID');
                    }

                    // Log current shop context
                    const currentShopId = SharedData.getCurrentShopId() || localStorage.getItem('supabase_shop_id');
                    console.log('Current shop ID after init:', currentShopId);

                    // Load appointments to ensure conflict checking works
                    await SharedData.getAppointments();
                    console.log('Appointments loaded for conflict checking');

                    // Normal initialization - check for barbers first
                    const barbers = await SharedData.getBarbers();
                    console.log('Barbers loaded:', barbers.length, barbers);

                    if (barbers.length === 1) {
                        // Single barber - skip barber selection and go straight to services
                        selectedBarberId = barbers[0].id;
                        console.log('Single barber found, ID:', selectedBarberId);
                        loadServicesForBarber(selectedBarberId);
                        showScreen('service-screen');
                    } else if (barbers.length > 1) {
                        // Multiple barbers - show barber selection screen
                        console.log('Multiple barbers found:', barbers.length);
                        loadBarbers();
                        showScreen('barber-screen');
                    } else {
                        // No barbers found - show error with more detail
                        console.error('No barbers found for shop:', currentShopId);
                        showScreen('service-screen');
                        document.getElementById('services-container').innerHTML =
                            `<div style="text-align: center; padding: 20px; color: #666;">
                                Shop not found or not configured yet.<br>
                                <small>Shop ID: ${currentShopId || 'Not set'}</small><br>
                                <small>Try refreshing or contact support.</small>
                            </div>`;
                    }

                    updateLanguage();
                    updateProgress();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('services-container').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: #666;">Unable to load shop data. Please try again.</div>';
            }
        }

        // Initialize the app
        initializeShop();

        // Setup input event listeners when DOM is ready
        function setupInputListeners() {
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');

            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    const formatted = formatPhoneNumber(e.target.value);
                    e.target.value = formatted;

                    const errorDiv = document.getElementById('phone-error');
                    if (formatted && !validatePhone(formatted)) {
                        errorDiv.textContent = isZh ? '请输入10位电话号码' : 'Please enter a 10-digit phone number';
                        errorDiv.style.display = 'block';
                    } else {
                        errorDiv.style.display = 'none';
                    }
                });

                phoneInput.addEventListener('blur', function(e) {
                    const formatted = formatPhoneNumber(e.target.value);
                    e.target.value = formatted;
                });
            }

            if (emailInput) {
                emailInput.addEventListener('input', function(e) {
                    const errorDiv = document.getElementById('email-error');
                    if (e.target.value && !validateEmail(e.target.value)) {
                        errorDiv.textContent = isZh ? '请输入有效的电子邮件地址' : 'Please enter a valid email address';
                        errorDiv.style.display = 'block';
                    } else {
                        errorDiv.style.display = 'none';
                    }
                });
            }
        }

        // Setup listeners immediately and also after delay to be safe
        setupInputListeners();
        setTimeout(setupInputListeners, 100);

        // Also setup on DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupInputListeners);
        } else {
            setupInputListeners();
        }

        // Listen for changes from owner app
        window.addEventListener('storage', (e) => {
            // Handle language preference changes
            if (e.key === 'preferredLanguage') {
                const newLang = e.newValue;
                if (newLang) {
                    isZh = newLang === 'zh';
                    updateLanguage();
                    loadAvailableServices(); // Reload services with new language
                }
            }

            if (e.key === 'services') {
                loadAvailableServices();
                // Clear selections if a selected service is no longer available
                const services = SharedData.getServices();
                selectedServices = selectedServices.filter(id => services[id]?.enabled);
                if (selectedServices.length === 0) {
                    document.getElementById('service-next').disabled = true;
                }
            } else if (e.key === 'storeHours') {
                // Regenerate dates if on date selection screen
                if (currentScreen === 'datetime-screen') {
                    generateDates();
                    if (selectedDate) {
                        generateTimeSlots();
                    }
                }
            } else if (e.key === 'timeOff') {
                // Update time off notice
                checkTimeOff();
                // Regenerate time slots if on date selection screen
                if (currentScreen === 'datetime-screen' && selectedDate) {
                    generateTimeSlots();
                }
            }
        });
    </script>
</body>
</html>
