<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fix Barber Services</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-bridge.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #357ABD; }
    </style>
</head>
<body>
    <h1>Fix Barber Services</h1>
    <div id="output"></div>
    <button onclick="fixServices()">Enable All Services for Owner</button>
    <button onclick="checkCurrent()">Check Current Status</button>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            output.appendChild(div);
        }

        async function checkCurrent() {
            output.innerHTML = '';
            log('Checking current status...');

            await SharedData.initialize();

            const shopId = SharedData.getCurrentShopId();
            if (!shopId) {
                log('No shop ID found!', 'error');
                return;
            }

            // Get barbers
            const barbers = await SharedData.getBarbers();
            log(`Found ${barbers.length} barber(s)`, 'info');

            if (barbers.length > 0) {
                const owner = barbers[0];
                log(`Owner: ${owner.name}`, 'info');
                log(`Owner ID: ${owner.id}`, 'info');
                log(`Is Owner: ${owner.isOwner}`, 'info');

                const serviceCount = owner.services ? Object.keys(owner.services).length : 0;
                log(`Services enabled: ${serviceCount}`, 'info');

                if (owner.services && Object.keys(owner.services).length > 0) {
                    log('Service IDs: ' + Object.keys(owner.services).join(', '), 'info');
                }
            }

            // Get all services
            const services = await SharedData.getServices();
            const serviceIds = Object.keys(services);
            log(`Total services in shop: ${serviceIds.length}`, 'info');

            // List services
            Object.entries(services).forEach(([id, service]) => {
                log(`- ${service.name} (ID: ${id})`, 'info');
            });
        }

        async function fixServices() {
            output.innerHTML = '';
            log('Starting fix...');

            await SharedData.initialize();

            const shopId = SharedData.getCurrentShopId();
            if (!shopId) {
                log('No shop ID found!', 'error');
                return;
            }

            // Get all services
            const services = await SharedData.getServices();
            const serviceIds = Object.keys(services);
            log(`Found ${serviceIds.length} services`, 'info');

            // Get barbers
            const barbers = await SharedData.getBarbers();
            if (barbers.length === 0) {
                log('No barbers found!', 'error');
                return;
            }

            const owner = barbers[0];
            log(`Updating owner: ${owner.name}`, 'info');

            // Update owner with all service IDs
            try {
                const { error } = await supabaseClient
                    .from('barbers')
                    .update({
                        service_ids: serviceIds,
                        uses_store_hours: true,
                        is_owner: true
                    })
                    .eq('id', owner.id);

                if (error) {
                    log(`Error: ${error.message}`, 'error');
                } else {
                    log('âœ… Owner services updated successfully!', 'success');
                    log(`Enabled ${serviceIds.length} services for owner`, 'success');
                    log('Reload the owner app to see the changes', 'success');
                }
            } catch (e) {
                log(`Exception: ${e.message}`, 'error');
            }
        }

        // Check status on load
        checkCurrent();
    </script>
</body>
</html>