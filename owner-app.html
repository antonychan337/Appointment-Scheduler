<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Owner Dashboard</title>
    <script src="shared-data.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            // Initialize EmailJS with the configured public key
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            if (emailConfig.publicKey) {
                emailjs.init(emailConfig.publicKey);
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .phone-container {
            max-width: 375px;
            margin: 20px auto;
            background: white;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 812px;
            position: relative;
            overflow-x: hidden;
        }
        .header {
            background: #2C3E50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 18px;
        }
        .lang-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .content {
            padding: 20px;
            height: calc(100% - 120px);
            overflow-y: auto;
        }
        .bottom-nav {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            padding: 10px;
        }
        .nav-item {
            text-align: center;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
        }
        .nav-item.active {
            color: #2C3E50;
        }
        .nav-item span {
            font-size: 24px;
            display: block;
        }
        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 32px;
            color: #2C3E50;
            font-weight: bold;
        }
        .metric-label {
            color: #666;
            margin-top: 5px;
        }
        .appointment-card {
            background: white;
            border-left: 3px solid #4A90E2;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .time-badge {
            display: inline-block;
            background: #E3F2FD;
            color: #1976D2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        .calendar-nav button {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Weekly Calendar Styles */
        .weekly-calendar {
            flex: 1; /* Take remaining space in calendar section */
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 0; /* Allow shrinking */
        }
        /* Special handling for calendar section to prevent double scrollbar */
        #calendar-section {
            height: 100%;
            display: none;  /* Hidden by default */
            flex-direction: column;
        }
        #calendar-section.active {
            display: flex;
        }
        .week-header {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
            border-bottom: 1px solid #e0e0e0;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
            padding-right: 17px; /* Account for scrollbar width */
        }
        .week-day-header {
            padding: 8px 2px;
            text-align: center;
            border-right: 1px solid #f0f0f0;
            font-size: 11px;
        }
        .week-day-header.today {
            background: #E3F2FD;
            color: #2196F3;
            font-weight: bold;
        }
        .week-day-date {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .week-day-name {
            font-size: 10px;
            text-transform: uppercase;
            color: #666;
        }
        .time-grid {
            flex: 1;
            overflow-y: scroll; /* Always show scrollbar for consistent width */
            overflow-x: hidden;
            position: relative;
            background: white;
        }
        .time-slots {
            display: grid;
            grid-template-columns: 40px repeat(7, 1fr);
        }
        .time-label {
            padding: 15px 5px;
            text-align: right;
            font-size: 10px;
            color: #666;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #f0f0f0;
            background: #fafafa;
        }
        .time-slot {
            min-height: 50px;
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            overflow: visible;
        }
        .appointment-block {
            position: absolute;
            left: 2px;
            right: 2px;
            background: #2196F3;
            color: white;
            border-radius: 4px;
            padding: 3px 4px;
            font-size: 10px;
            overflow: hidden;
            z-index: 5;
            cursor: move;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: opacity 0.2s, z-index 0s;
            pointer-events: auto;
        }
        .appointment-block:hover {
            z-index: 100; /* Bring to front on hover */
            opacity: 1 !important;
        }
        .appointment-block.overlapped {
            opacity: 0.85; /* Make slightly transparent when overlapping */
        }
        .appointment-period {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 4px;
            z-index: 3;
            pointer-events: none;
        }
        .appointment-period.active {
            background: #2196F3;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .appointment-period.inactive {
            background: repeating-linear-gradient(
                45deg,
                #E3F2FD,
                #E3F2FD 10px,
                #BBDEFB 10px,
                #BBDEFB 20px
            );
            opacity: 0.7;
            border: 1px dashed #90CAF9;
        }
        .appointment-block.dragging {
            opacity: 0.5;
            z-index: 1000;
        }
        .appointment-block .customer-name {
            font-weight: bold;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .appointment-block .service-name {
            font-size: 9px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Selection overlay for blocking time */
        .selection-overlay {
            position: absolute;
            background: rgba(239, 83, 80, 0.3);
            border: 2px solid #EF5350;
            border-radius: 4px;
            z-index: 100;
            pointer-events: none;
            left: 2px;
            right: 2px;
        }
        /* Blocked time block */
        .blocked-time-block {
            position: absolute;
            left: 2px;
            right: 2px;
            background: #757575;
            color: white;
            border-radius: 4px;
            padding: 3px 4px;
            font-size: 10px;
            overflow: hidden;
            z-index: 4;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .blocked-time-block:hover {
            background: #616161;
        }
        /* Appointment Details Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 340px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .detail-group {
            margin-bottom: 15px;
        }
        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .detail-value {
            font-size: 14px;
            font-weight: bold;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-btn.reschedule {
            background: #4A90E2;
            color: white;
        }
        .modal-btn.cancel {
            background: #f44336;
            color: white;
        }
        .service-list {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }
        .service-item > div:first-child {
            flex: 1;
            padding-right: 60px;
        }
        .service-name-input {
            font-weight: bold;
            font-size: 16px;
            border: none;
            background: transparent;
            padding: 2px 4px;
            border-radius: 3px;
            width: 100%;
            cursor: text;
        }
        .service-name-input:hover {
            background: #f9f9f9;
        }
        .service-name-input:focus {
            outline: none;
            background: white;
            border: 1px solid #4A90E2;
        }
        .service-item:last-child {
            border-bottom: none;
        }
        .toggle-switch {
            position: absolute;
            right: 0;
            top: 12px;
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #4CAF50;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .toggle-switch.active::after {
            left: 26px;
        }
        .store-hours {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .hours-header {
            display: grid;
            grid-template-columns: 70px 85px 12px 85px 40px;
            gap: 3px;
            align-items: center;
            padding: 8px 0;
            margin-left: -10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 10px;
        }
        .hours-header > div {
            font-weight: 600;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .hours-header > div:first-child {
            text-align: left;
        }
        .hours-row {
            display: grid;
            grid-template-columns: 70px 85px 12px 85px 40px;
            gap: 3px;
            align-items: center;
            padding: 8px 0;
            margin-left: -10px;
        }
        .day-label {
            font-weight: 500;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .time-input {
            padding: 6px 4px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
            width: 100%;
        }
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            display: none;
        }
        .time-input:invalid {
            border-color: #f44336;
            background: #ffebee;
        }
        .closed-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .closed-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .revenue-chart {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-bar {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 10px;
            margin-top: 20px;
        }
        .bar {
            flex: 1;
            background: #4A90E2;
            border-radius: 4px 4px 0 0;
            position: relative;
        }
        .bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
        }
        .add-button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .page-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            cursor: pointer;
            transition: background 0.3s;
        }
        .dot.active {
            background: #2C3E50;
        }
        .services-pages {
            display: flex;
            transition: transform 0.3s ease;
            width: 200%;
        }
        .services-page {
            width: 50%;
            padding: 0 20px;
        }
        .settings-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .settings-item:hover {
            background: #f9f9f9;
        }
        .staff-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .staff-item:hover {
            background: #f9f9f9;
            border-color: #2196F3;
        }
        .staff-item.active {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        .settings-icon {
            width: 40px;
            height: 40px;
            background: #E3F2FD;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <!-- Add Service Modal -->
    <div id="add-service-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="add-service-title">Add New Service</h3>
                <button class="modal-close" onclick="closeAddServiceModal()">×</button>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Service Name</label>
                <input type="text" id="new-service-name" placeholder="Enter service name" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Duration (min)</label>
                    <input type="number" id="new-service-duration" value="30" min="5" max="480" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;" onchange="validatePeriodsOnChange()">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Price ($)</label>
                    <input type="number" id="new-service-price" value="25" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="new-service-enabled" checked style="cursor: pointer;">
                    <span style="font-size: 14px; color: #333;">Enable this service immediately</span>
                </label>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="new-service-has-active" onchange="toggleNewServiceActiveTime()" style="cursor: pointer;">
                    <span style="font-size: 14px; color: #333;">Has active time periods</span>
                </label>
            </div>

            <div id="new-service-active-periods" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Active Time Periods</h4>
                <div id="active-periods-list">
                    <div class="active-period-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 13px; color: #666;">From</span>
                        <input type="number" class="period-start" value="0" min="0" style="width: 60px; padding: 5px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 13px;">
                        <span style="font-size: 13px; color: #666;">to</span>
                        <input type="number" class="period-end" value="15" min="0" style="width: 60px; padding: 5px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 13px;">
                        <span style="font-size: 13px; color: #666;">min</span>
                        <button onclick="removeActivePeriod(this)" style="padding: 3px 8px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                </div>
                <button onclick="addActivePeriod()" style="padding: 5px 10px; background: #4A90E2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 13px;">Add Another Period</button>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="saveNewService()" style="flex: 1; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Add Service</button>
                <button onclick="closeAddServiceModal()" style="flex: 1; padding: 10px; background: #ccc; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Owner Booking Modal -->
    <div id="owner-booking-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="owner-booking-title">Create Booking</h3>
                <button class="modal-close" onclick="closeOwnerBookingModal()">×</button>
            </div>

            <!-- Barber Selection -->
            <div class="form-group" style="margin-bottom: 15px;">
                <label id="label-barber-selection" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Select Barber</label>
                <select id="owner-booking-barber" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                    <!-- Barbers will be populated dynamically -->
                </select>
            </div>

            <!-- Service Selection -->
            <div class="form-group" style="margin-bottom: 15px;">
                <label id="label-service-selection" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Select Service</label>
                <select id="owner-booking-service" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;" onchange="onOwnerServiceChange()">
                    <option value="">Choose a service...</option>
                    <!-- Services will be populated dynamically -->
                    <option value="custom">Custom</option>
                </select>
            </div>

            <!-- Customer Information -->
            <div id="customer-info-section">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label id="label-customer-name" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Customer Name *</label>
                    <input type="text" id="owner-booking-name" placeholder="Enter customer name" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label id="label-customer-phone" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Phone (Optional)</label>
                    <input type="tel" id="owner-booking-phone" placeholder="Enter phone number" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label id="label-customer-email" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Email (Optional)</label>
                    <input type="email" id="owner-booking-email" placeholder="Enter email address" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                </div>
            </div>

            <!-- Date/Time Section -->
            <div id="datetime-section" style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <div id="date-single-section">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label id="label-booking-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Date</label>
                        <input type="date" id="owner-booking-date" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                    </div>
                </div>

                <div id="date-range-section" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label id="label-start-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Start Date</label>
                            <input type="date" id="owner-booking-start-date" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label id="label-end-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">End Date</label>
                            <input type="date" id="owner-booking-end-date" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label id="label-start-time" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">Start Time</label>
                        <input type="time" id="owner-booking-start" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;" onchange="onOwnerStartTimeChange()">
                    </div>

                    <div class="form-group" style="flex: 1;">
                        <label id="label-end-time" style="display: block; margin-bottom: 5px; font-size: 14px; color: #333;">End Time</label>
                        <input type="time" id="owner-booking-end" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;" readonly>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div id="booking-summary" style="background: #E3F2FD; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                <div style="font-size: 14px; color: #333;">
                    <div id="summary-service"></div>
                    <div id="summary-duration" style="margin-top: 5px;"></div>
                </div>
            </div>

            <!-- Buttons -->
            <div style="display: flex; gap: 10px;">
                <button class="confirm-button" onclick="confirmOwnerBooking()" style="flex: 1; background: #4A90E2; color: white; border: none; padding: 10px; border-radius: 5px; font-size: 14px; cursor: pointer;">Create Booking</button>
                <button class="cancel-button" onclick="closeOwnerBookingModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 10px; border-radius: 5px; font-size: 14px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Appointment Details Modal -->
    <div id="appointment-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Appointment Details</h3>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>

            <div class="detail-group">
                <div class="detail-label" id="label-customer">Customer</div>
                <div class="detail-value" id="modal-customer-name"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label" id="label-services">Services</div>
                <div class="detail-value" id="modal-services"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label" id="label-barber">Barber</div>
                <div class="detail-value" id="modal-barber"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label" id="label-datetime">Date & Time</div>
                <div class="detail-value" id="modal-datetime"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label" id="label-duration">Duration</div>
                <div class="detail-value" id="modal-duration"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label" id="label-price">Price</div>
                <div class="detail-value" id="modal-price"></div>
            </div>

            <div class="detail-group">
                <div class="detail-label" id="label-contact">Contact</div>
                <div class="detail-value" id="modal-phone"></div>
                <div class="detail-value" id="modal-email"></div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn reschedule" id="btn-reschedule" onclick="rescheduleAppointment()">Reschedule</button>
                <button class="modal-btn cancel" id="btn-cancel" onclick="cancelAppointment()">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Cancellation Policy Modal -->
    <div id="cancellation-policy-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="cancel-policy-modal-title">Cancellation Policy</h3>
                <button class="modal-close" onclick="closeCancellationPolicy()">×</button>
            </div>
            <div style="padding: 20px;">
                <p id="cancel-policy-intro" style="color: #666; margin-bottom: 20px;">
                    Set the minimum notice period required for customers to cancel or reschedule appointments.
                </p>

                <div style="margin-bottom: 20px;">
                    <label id="min-notice-label" style="display: block; margin-bottom: 8px; font-weight: bold;">
                        Minimum Notice Period (hours):
                    </label>
                    <input type="number"
                           id="min-notice-hours"
                           min="0"
                           max="168"
                           step="1"
                           placeholder="e.g., 24"
                           style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px;">
                    <small id="policy-hint" style="color: #666; display: block; margin-top: 5px;">
                        Enter 0 to allow cancellations anytime, or up to 168 hours (1 week)
                    </small>
                </div>

                <div id="policy-preview" style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 20px; display: none;">
                    <strong id="policy-preview-title">Policy Preview:</strong>
                    <p id="policy-preview-text" style="margin-top: 10px;"></p>
                </div>

                <div style="padding: 15px; background: #fff3e0; border-radius: 8px; margin-bottom: 20px;">
                    <strong style="color: #ff9800;">⚠️ <span id="policy-important">Important:</span></strong>
                    <ul style="margin-top: 10px; padding-left: 20px; color: #666;">
                        <li id="policy-note1">This policy applies to customer-initiated changes only</li>
                        <li id="policy-note2">You can still modify or cancel appointments at any time</li>
                        <li id="policy-note3">Customers will see this policy when booking</li>
                    </ul>
                </div>

                <button id="save-policy-btn"
                        class="add-button"
                        onclick="saveCancellationPolicy()"
                        style="width: 100%; margin-top: 10px;">
                    Save Policy
                </button>

                <div id="policy-message" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Owner Profile Modal -->
    <div id="profile-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="profile-modal-title">Business Profile</h3>
                <button class="modal-close" onclick="closeProfileModal()">×</button>
            </div>
            <div style="padding: 20px;">
                <p id="profile-modal-intro" style="color: #666; margin-bottom: 20px;">
                    Manage your business information that will appear in emails and customer communications.
                </p>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="owner-first-name" id="label-first-name" style="display: block; margin-bottom: 5px; font-weight: 500;">
                        First Name <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="owner-first-name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="owner-last-name" id="label-last-name" style="display: block; margin-bottom: 5px; font-weight: 500;">
                        Last Name <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="owner-last-name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="owner-phone" id="label-owner-phone" style="display: block; margin-bottom: 5px; font-weight: 500;">
                        Phone Number <span style="color: #999;">(optional)</span>
                    </label>
                    <input type="tel" id="owner-phone" placeholder="(555) 555-5555" maxlength="14" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                           oninput="this.value = formatOwnerPhone(this.value)">
                    <div id="owner-phone-error" style="color: #f44336; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="owner-email" id="label-owner-email" style="display: block; margin-bottom: 5px; font-weight: 500;">
                        Email <span style="color: #999;">(optional)</span>
                    </label>
                    <input type="email" id="owner-email" placeholder="your@email.com" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                           oninput="validateOwnerEmail()">
                    <div id="owner-email-error" style="color: #f44336; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="owner-wechat" id="label-wechat" style="display: block; margin-bottom: 5px; font-weight: 500;">
                        WeChat ID <span style="color: #999;">(optional)</span>
                    </label>
                    <input type="text" id="owner-wechat" placeholder="WeChat ID" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="store-name" id="label-store-name" style="display: block; margin-bottom: 5px; font-weight: 500;">
                        Store Name <span style="color: red;">*</span>
                    </label>
                    <input type="text" id="store-name" placeholder="Premium Cuts Barbershop" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="store-address" id="label-store-address" style="display: block; margin-bottom: 5px; font-weight: 500;">
                        Store Address <span style="color: red;">*</span>
                    </label>
                    <textarea id="store-address" placeholder="123 Main Street, City, State 12345"
                              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
                </div>

                <!-- Store Hours Section -->
                <div style="border-top: 1px solid #e0e0e0; margin-top: 20px; padding-top: 15px;">
                    <h4 id="store-hours-heading" style="margin-bottom: 10px;">Store Hours</h4>

                    <div style="background: #f9f9f9; padding: 10px; border-radius: 5px;">
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 5px; font-size: 12px; font-weight: 600; color: #666;">
                            <div id="store-hours-label-day">Day</div>
                            <div id="store-hours-label-opens" style="text-align: center;">Opens</div>
                            <div></div>
                            <div id="store-hours-label-closes" style="text-align: center;">Closes</div>
                            <div id="store-hours-label-closed" style="text-align: center;">Closed</div>
                        </div>

                        <!-- Sunday -->
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div id="store-day-sunday" style="font-size: 14px;">Sunday</div>
                            <input type="time" id="store-sunday-open" value="09:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <span style="text-align: center;">–</span>
                            <input type="time" id="store-sunday-close" value="18:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="text-align: center;">
                                <input type="checkbox" id="store-sunday-closed" onchange="toggleStoreDayClosed('sunday')">
                            </div>
                        </div>

                        <!-- Monday -->
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div id="store-day-monday" style="font-size: 14px;">Monday</div>
                            <input type="time" id="store-monday-open" value="09:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <span style="text-align: center;">–</span>
                            <input type="time" id="store-monday-close" value="18:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="text-align: center;">
                                <input type="checkbox" id="store-monday-closed" onchange="toggleStoreDayClosed('monday')">
                            </div>
                        </div>

                        <!-- Tuesday -->
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div id="store-day-tuesday" style="font-size: 14px;">Tuesday</div>
                            <input type="time" id="store-tuesday-open" value="09:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <span style="text-align: center;">–</span>
                            <input type="time" id="store-tuesday-close" value="18:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="text-align: center;">
                                <input type="checkbox" id="store-tuesday-closed" onchange="toggleStoreDayClosed('tuesday')">
                            </div>
                        </div>

                        <!-- Wednesday -->
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div id="store-day-wednesday" style="font-size: 14px;">Wednesday</div>
                            <input type="time" id="store-wednesday-open" value="09:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <span style="text-align: center;">–</span>
                            <input type="time" id="store-wednesday-close" value="18:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="text-align: center;">
                                <input type="checkbox" id="store-wednesday-closed" onchange="toggleStoreDayClosed('wednesday')">
                            </div>
                        </div>

                        <!-- Thursday -->
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div id="store-day-thursday" style="font-size: 14px;">Thursday</div>
                            <input type="time" id="store-thursday-open" value="09:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <span style="text-align: center;">–</span>
                            <input type="time" id="store-thursday-close" value="18:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="text-align: center;">
                                <input type="checkbox" id="store-thursday-closed" onchange="toggleStoreDayClosed('thursday')">
                            </div>
                        </div>

                        <!-- Friday -->
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div id="store-day-friday" style="font-size: 14px;">Friday</div>
                            <input type="time" id="store-friday-open" value="09:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <span style="text-align: center;">–</span>
                            <input type="time" id="store-friday-close" value="18:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="text-align: center;">
                                <input type="checkbox" id="store-friday-closed" onchange="toggleStoreDayClosed('friday')">
                            </div>
                        </div>

                        <!-- Saturday -->
                        <div style="display: grid; grid-template-columns: 100px 120px auto 120px 60px; gap: 10px; align-items: center; margin-bottom: 8px;">
                            <div id="store-day-saturday" style="font-size: 14px;">Saturday</div>
                            <input type="time" id="store-saturday-open" value="09:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <span style="text-align: center;">–</span>
                            <input type="time" id="store-saturday-close" value="18:00" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="text-align: center;">
                                <input type="checkbox" id="store-saturday-closed" onchange="toggleStoreDayClosed('saturday')">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="profile-success" style="display: none; background: #E8F5E9; color: #2E7D32; padding: 10px; border-radius: 4px; margin-top: 15px; text-align: center;">
                    ✅ <span id="profile-success-msg">Profile saved successfully!</span>
                </div>
            </div>

            <div class="modal-actions" style="padding: 15px; border-top: 1px solid #e0e0e0;">
                <button class="modal-btn" id="save-profile-btn" onclick="saveOwnerProfile()" style="background: #2196F3; color: white;">
                    Save Profile
                </button>
                <button class="modal-btn" id="cancel-profile-btn" onclick="closeProfileModal()" style="background: #f5f5f5;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Email Settings Modal -->
    <div id="email-settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="email-settings-modal-title">Email Notifications</h3>
                <button class="modal-close" onclick="closeEmailSettings()">×</button>
            </div>
            <div style="padding: 20px;">
                <p id="email-settings-intro" style="color: #666; margin-bottom: 20px;">
                    Choose which email notifications to send to your customers.
                </p>

                <!-- Main Toggle -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <label for="email-notifications-enabled" style="font-weight: 600; font-size: 16px; cursor: pointer;">
                                <span id="email-main-toggle-label">Send email notifications</span>
                            </label>
                            <p id="email-main-toggle-desc" style="color: #666; font-size: 14px; margin: 5px 0 0 0;">
                                Automatically notify customers about their appointments
                            </p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="email-notifications-enabled" onchange="toggleEmailNotifications()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <!-- Sub-options (only visible when main toggle is on) -->
                <div id="email-sub-options" style="display: none; margin-left: 20px;">
                    <div style="border-left: 3px solid #007AFF; padding-left: 20px;">
                        <!-- Confirmation Emails -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <label for="email-confirmations" style="cursor: pointer;">
                                    <strong id="email-confirmation-label">Booking confirmations</strong>
                                    <span id="email-confirmation-desc" style="color: #666; font-size: 14px; display: block;">
                                        Send when appointments are booked
                                    </span>
                                </label>
                                <label class="switch" style="transform: scale(0.8);">
                                    <input type="checkbox" id="email-confirmations" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Rescheduling Emails -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <label for="email-reschedules" style="cursor: pointer;">
                                    <strong id="email-reschedule-label">Reschedule notifications</strong>
                                    <span id="email-reschedule-desc" style="color: #666; font-size: 14px; display: block;">
                                        Send when appointments are rescheduled
                                    </span>
                                </label>
                                <label class="switch" style="transform: scale(0.8);">
                                    <input type="checkbox" id="email-reschedules" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Cancellation Emails -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <label for="email-cancellations" style="cursor: pointer;">
                                    <strong id="email-cancellation-label">Cancellation notices</strong>
                                    <span id="email-cancellation-desc" style="color: #666; font-size: 14px; display: block;">
                                        Send when appointments are cancelled
                                    </span>
                                </label>
                                <label class="switch" style="transform: scale(0.8);">
                                    <input type="checkbox" id="email-cancellations" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Config Status -->
                <div id="email-config-status" style="margin-top: 20px; padding: 12px; border-radius: 6px; font-size: 14px;">
                    <!-- Status will be filled by JavaScript -->
                </div>

                <div id="email-settings-success" style="display: none; background: #E8F5E9; color: #2E7D32; padding: 10px; border-radius: 4px; margin-top: 15px; text-align: center;">
                    ✅ Settings saved successfully!
                </div>
            </div>

            <div class="modal-actions" style="padding: 15px; border-top: 1px solid #e0e0e0;">
                <button class="modal-btn" id="save-email-settings-btn" onclick="saveEmailSettings()" style="background: #2196F3; color: white;">
                    Save Settings
                </button>
                <button class="modal-btn" id="cancel-email-settings-btn" onclick="closeEmailSettings()" style="background: #f5f5f5;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #007AFF;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
    </style>

    <!-- Booking Link Modal -->
    <div id="booking-link-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="booking-link-modal-title">Booking Link</h3>
                <button class="modal-close" onclick="closeBookingLinkModal()">×</button>
            </div>

            <div style="padding: 20px;">
                <p id="booking-link-intro" style="color: #666; margin-bottom: 20px;">
                    Create a custom URL that customers can use to book appointments with you.
                </p>

                <div style="margin-bottom: 20px;">
                    <label id="url-label" style="display: block; margin-bottom: 8px; font-weight: bold;">Your Custom URL</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="background: #f5f5f5; padding: 10px; border-radius: 4px 0 0 4px; border: 1px solid #e0e0e0;">
                            mycompany.com/
                        </span>
                        <input type="text"
                               id="custom-url-slug"
                               placeholder="your-business-name"
                               style="flex: 1; padding: 10px; border: 1px solid #e0e0e0; border-radius: 0 4px 4px 0; border-left: none;"
                               onkeyup="validateUrlSlug()"
                               pattern="[a-z0-9-]+"
                               maxlength="50">
                    </div>
                    <div id="url-error" style="color: #f44336; font-size: 12px; margin-top: 5px; display: none;"></div>
                    <div id="url-success" style="color: #4CAF50; font-size: 12px; margin-top: 5px; display: none;"></div>
                </div>

                <button id="check-availability-btn"
                        class="add-button"
                        onclick="checkUrlAvailability()"
                        style="margin-bottom: 10px; width: 100%;">
                    Check Availability
                </button>

                <div id="url-display" style="display: none; margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 1px solid #2196F3;">
                    <div style="font-weight: bold; margin-bottom: 10px;" id="your-booking-link">Your Booking Link:</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text"
                               id="full-url"
                               readonly
                               style="flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; background: white;">
                        <button class="add-button" onclick="copyToClipboard()" style="padding: 8px 15px;">
                            📋 <span id="copy-btn-text">Copy</span>
                        </button>
                    </div>
                    <div id="copy-feedback" style="color: #4CAF50; font-size: 12px; margin-top: 5px; display: none;">
                        Copied to clipboard!
                    </div>
                </div>

                <div id="qr-code-section" style="display: none; margin-top: 20px; text-align: center;">
                    <div style="font-weight: bold; margin-bottom: 10px;" id="qr-code-title">QR Code</div>
                    <div id="qr-code" style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <!-- QR code would be generated here -->
                        <div style="width: 150px; height: 150px; margin: 0 auto; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999;">
                            QR Code
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions" style="padding: 15px; border-top: 1px solid #e0e0e0;">
                <button class="modal-btn" id="save-url-btn" onclick="saveBookingUrl()" style="background: #2196F3; color: white;" disabled>
                    Save URL
                </button>
                <button class="modal-btn" id="cancel-booking-link-btn" onclick="closeBookingLinkModal()" style="background: #f5f5f5;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div class="phone-container">
        <div class="header">
            <h1 id="app-title">Shop Management</h1>
            <button class="lang-toggle" onclick="toggleLang()">中文</button>
        </div>

        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="dashboard-title" style="margin: 0;">Dashboard</h2>
                    <!-- Barber selector for dashboard -->
                    <select id="dashboard-barber-select" onchange="selectDashboardBarber(this.value)" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="" id="dashboard-allstaff-option">All Staff</option>
                    </select>
                </div>

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="dashboard-card">
                        <div class="metric-value" id="week-revenue">$0</div>
                        <div class="metric-label" id="week-revenue-label">This Week's Revenue</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="metric-value" id="next-week-revenue">$0</div>
                        <div class="metric-label" id="next-week-revenue-label">Next Week's Revenue</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="metric-value" id="today-appointments">0</div>
                        <div class="metric-label" id="today-appointments-label">Today's Appointments</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="metric-value" id="utilization-rate">0%</div>
                        <div class="metric-label" id="utilization-rate-label">Utilization Rate</div>
                    </div>
                </div>

                <div class="revenue-chart">
                    <h3 id="weekly-revenue">Weekly Revenue</h3>
                    <div class="chart-bar" id="weekly-revenue-bars">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Service Time Breakdown Pie Chart -->
                <div class="revenue-chart" style="margin-top: 20px;">
                    <h3 id="service-breakdown-title">Service Time Breakdown</h3>
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 200px;">
                        <canvas id="service-pie-chart" width="200" height="200" style="max-width: 200px;"></canvas>
                        <div id="service-legend-pie" style="margin-left: 20px;">
                            <!-- Legend will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Section -->
            <div id="calendar-section" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 id="calendar-title" style="margin: 0;">Calendar</h2>
                        <!-- Barber selector for calendar -->
                        <select id="calendar-barber-select" onchange="selectCalendarBarber(this.value)" style="margin-top: 10px; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="" id="calendar-allstaff-option">All Staff</option>
                        </select>
                    </div>
                    <div class="calendar-nav">
                        <button onclick="prevWeek()">←</button>
                        <span id="current-week">Week of Sep 16</span>
                        <button onclick="nextWeek()">→</button>
                    </div>
                </div>

                <!-- Service Color Legend -->
                <div id="service-legend" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px; font-size: 12px;">
                    <!-- Legend items will be generated dynamically -->
                </div>

                <div class="weekly-calendar" id="weekly-calendar">
                    <div class="week-header" id="week-header">
                        <!-- Week headers will be generated -->
                    </div>
                    <div class="time-grid" id="time-grid">
                        <div class="time-slots" id="time-slots">
                            <!-- Time slots will be generated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Section -->
            <div id="services-section" class="section">
                <!-- Staff List Section -->
                <div id="staff-list-section" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 id="staff-title">Staff Members</h2>
                        <button onclick="addNewStaff()" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">Add Staff</button>
                    </div>

                    <!-- Staff list as clickable items -->
                    <div id="staff-list" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Staff items will be generated here -->
                    </div>
                </div>

                <!-- Current Staff Configuration (hidden by default, shown when staff member selected) -->
                <div id="current-staff-config" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;"><span id="config-for-text">Configuration for:</span> <span id="selected-staff-name">Owner</span></h3>
                        <button id="back-to-staff-btn" onclick="backToStaffList()" style="padding: 8px 15px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">← Back to Staff List</button>
                    </div>
                </div>

                <div id="services-config-container" style="overflow: hidden; position: relative; display: none;">
                    <div class="services-pages" id="services-pages">
                        <!-- Page 1: Services -->
                        <div class="services-page">
                            <h2 id="services-title">Services</h2>
                            <div class="service-list" style="margin-top: 20px;">
                                <div class="service-item" data-service="mens-cut">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div class="service-color-indicator" style="width: 20px; height: 20px; background: #2196F3; border-radius: 4px;"></div>
                                            <input type="text" class="service-name-input" id="service-mens-cut" value="Men's Cut" onchange="saveServices()" style="flex: 1;">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                            <input type="number" class="service-duration" id="duration-mens-cut" value="30" min="5" max="480" style="width: 50px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                            <span class="min-label" style="font-size: 13px; color: #666;">min</span>
                                            <span style="color: #666;">•</span>
                                            <span style="font-size: 13px; color: #666;">$</span>
                                            <input type="number" class="service-price" id="price-mens-cut" value="25" min="0" step="0.01" style="width: 60px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                        </div>
                                        <div style="margin-top: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="checkbox" class="active-time-toggle" id="toggle-active-mens-cut" onchange="toggleActiveTime('mens-cut')" style="cursor: pointer;">
                                                <label for="toggle-active-mens-cut" class="active-periods-label" style="font-size: 12px; color: #666; cursor: pointer;">Has active time periods</label>
                                            </div>
                                            <div class="active-time-container" id="active-container-mens-cut" style="display: none; margin-left: 24px; margin-top: 8px;">
                                                <div class="active-periods-list" id="periods-mens-cut">
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span class="period-label" style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 1:</span>
                                                        <input type="number" class="period-start" value="0" min="0" max="30" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="30" min="0" max="30" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                    </div>
                                                </div>
                                                <button class="add-period-btn" onclick="addPeriodToService('mens-cut')" style="margin-top: 5px; padding: 3px 8px; background: #4A90E2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Add period</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="toggle-switch active" onclick="toggleService(this)"></div>
                                </div>
                                <div class="service-item" data-service="womens-cut">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div class="service-color-indicator" style="width: 20px; height: 20px; background: #E91E63; border-radius: 4px;"></div>
                                            <input type="text" class="service-name-input" id="service-womens-cut" value="Women's Cut" onchange="saveServices()" style="flex: 1;">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                            <input type="number" class="service-duration" id="duration-womens-cut" value="45" min="5" max="480" style="width: 50px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                            <span class="min-label" style="font-size: 13px; color: #666;">min</span>
                                            <span style="color: #666;">•</span>
                                            <span style="font-size: 13px; color: #666;">$</span>
                                            <input type="number" class="service-price" id="price-womens-cut" value="35" min="0" step="0.01" style="width: 60px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                        </div>
                                        <div style="margin-top: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="checkbox" class="active-time-toggle" id="toggle-active-womens-cut" onchange="toggleActiveTime('womens-cut')" style="cursor: pointer;">
                                                <label for="toggle-active-womens-cut" class="active-periods-label" style="font-size: 12px; color: #666; cursor: pointer;">Has active time periods</label>
                                            </div>
                                            <div class="active-time-container" id="active-container-womens-cut" style="display: none; margin-left: 24px; margin-top: 8px;">
                                                <div class="active-periods-list" id="periods-womens-cut">
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span class="period-label" style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 1:</span>
                                                        <input type="number" class="period-start" value="0" min="0" max="45" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="45" min="0" max="45" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                    </div>
                                                </div>
                                                <button class="add-period-btn" onclick="addPeriodToService('womens-cut')" style="margin-top: 5px; padding: 3px 8px; background: #4A90E2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Add period</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="toggle-switch active" onclick="toggleService(this)"></div>
                                </div>
                                <div class="service-item" data-service="kids-cut">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div class="service-color-indicator" style="width: 20px; height: 20px; background: #4CAF50; border-radius: 4px;"></div>
                                            <input type="text" class="service-name-input" id="service-kids-cut" value="Children's Cut" onchange="saveServices()" style="flex: 1;">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                            <input type="number" class="service-duration" id="duration-kids-cut" value="15" min="5" max="480" style="width: 50px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                            <span class="min-label" style="font-size: 13px; color: #666;">min</span>
                                            <span style="color: #666;">•</span>
                                            <span style="font-size: 13px; color: #666;">$</span>
                                            <input type="number" class="service-price" id="price-kids-cut" value="15" min="0" step="0.01" style="width: 60px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                        </div>
                                        <div style="margin-top: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="checkbox" class="active-time-toggle" id="toggle-active-kids-cut" onchange="toggleActiveTime('kids-cut')" style="cursor: pointer;">
                                                <label for="toggle-active-kids-cut" class="active-periods-label" style="font-size: 12px; color: #666; cursor: pointer;">Has active time periods</label>
                                            </div>
                                            <div class="active-time-container" id="active-container-kids-cut" style="display: none; margin-left: 24px; margin-top: 8px;">
                                                <div class="active-periods-list" id="periods-kids-cut">
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span class="period-label" style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 1:</span>
                                                        <input type="number" class="period-start" value="0" min="0" max="20" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="20" min="0" max="20" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                    </div>
                                                </div>
                                                <button class="add-period-btn" onclick="addPeriodToService('kids-cut')" style="margin-top: 5px; padding: 3px 8px; background: #4A90E2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Add period</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="toggle-switch active" onclick="toggleService(this)"></div>
                                </div>
                                <div class="service-item" data-service="coloring">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div class="service-color-indicator" style="width: 20px; height: 20px; background: #FF9800; border-radius: 4px;"></div>
                                            <input type="text" class="service-name-input" id="service-coloring" value="Hair Coloring" onchange="saveServices()" style="flex: 1;">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                            <input type="number" class="service-duration" id="duration-coloring" value="90" min="5" max="480" style="width: 50px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                            <span class="min-label" style="font-size: 13px; color: #666;">min</span>
                                            <span style="color: #666;">•</span>
                                            <span style="font-size: 13px; color: #666;">$</span>
                                            <input type="number" class="service-price" id="price-coloring" value="80" min="0" step="0.01" style="width: 60px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                        </div>
                                        <div style="margin-top: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="checkbox" class="active-time-toggle" id="toggle-active-coloring" checked onchange="toggleActiveTime('coloring')" style="cursor: pointer;">
                                                <label for="toggle-active-coloring" class="active-periods-label" style="font-size: 12px; color: #666; cursor: pointer;">Has active time periods</label>
                                            </div>
                                            <div class="active-time-container" id="active-container-coloring" style="display: block; margin-left: 24px; margin-top: 8px;">
                                                <div class="active-periods-list" id="periods-coloring">
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span class="period-label" style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 1:</span>
                                                        <input type="number" class="period-start" value="0" min="0" max="90" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="30" min="0" max="90" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                        <button onclick="removePeriodFromService(this, 'coloring')" style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">×</button>
                                                    </div>
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 2:</span>
                                                        <input type="number" class="period-start" value="60" min="0" max="90" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="90" min="0" max="90" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                        <button onclick="removePeriodFromService(this, 'coloring')" style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">×</button>
                                                    </div>
                                                </div>
                                                <button class="add-period-btn" onclick="addPeriodToService('coloring')" style="margin-top: 5px; padding: 3px 8px; background: #4A90E2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Add period</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="toggle-switch active" onclick="toggleService(this)"></div>
                                </div>
                                <div class="service-item" data-service="highlights">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div class="service-color-indicator" style="width: 20px; height: 20px; background: #9C27B0; border-radius: 4px;"></div>
                                            <input type="text" class="service-name-input" id="service-highlights" value="Highlights" onchange="saveServices()" style="flex: 1;">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                                            <input type="number" class="service-duration" id="duration-highlights" value="120" min="5" max="480" style="width: 50px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                            <span class="min-label" style="font-size: 13px; color: #666;">min</span>
                                            <span style="color: #666;">•</span>
                                            <span style="font-size: 13px; color: #666;">$</span>
                                            <input type="number" class="service-price" id="price-highlights" value="120" min="0" step="0.01" style="width: 60px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                                        </div>
                                        <div style="margin-top: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="checkbox" class="active-time-toggle" id="toggle-active-highlights" checked onchange="toggleActiveTime('highlights')" style="cursor: pointer;">
                                                <label for="toggle-active-highlights" class="active-periods-label" style="font-size: 12px; color: #666; cursor: pointer;">Has active time periods</label>
                                            </div>
                                            <div class="active-time-container" id="active-container-highlights" style="display: block; margin-left: 24px; margin-top: 8px;">
                                                <div class="active-periods-list" id="periods-highlights">
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span class="period-label" style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 1:</span>
                                                        <input type="number" class="period-start" value="0" min="0" max="120" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="15" min="0" max="120" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                        <button onclick="removePeriodFromService(this, 'highlights')" style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">×</button>
                                                    </div>
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 2:</span>
                                                        <input type="number" class="period-start" value="45" min="0" max="120" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="60" min="0" max="120" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                        <button onclick="removePeriodFromService(this, 'highlights')" style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">×</button>
                                                    </div>
                                                    <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                                        <span style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 3:</span>
                                                        <input type="number" class="period-start" value="90" min="0" max="120" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span class="to-label" style="font-size: 12px; color: #4A90E2;">to</span>
                                                        <input type="number" class="period-end" value="120" min="0" max="120" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                                        <span style="font-size: 12px; color: #4A90E2;">min</span>
                                                        <button onclick="removePeriodFromService(this, 'highlights')" style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">×</button>
                                                    </div>
                                                </div>
                                                <button class="add-period-btn" onclick="addPeriodToService('highlights')" style="margin-top: 5px; padding: 3px 8px; background: #4A90E2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Add period</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="toggle-switch active" onclick="toggleService(this)"></div>
                                </div>
                            </div>
                            <button class="add-button" id="add-service-btn" onclick="openAddServiceModal()">Add New Service</button>
                        </div>

                        <!-- Page 2: Store Hours -->
                        <div class="services-page">
                            <h2 id="staff-hours-title">Staff Hours</h2>

                            <!-- Same as store hours checkbox (only show for non-owner staff) -->
                            <div id="same-as-store-hours-container" style="margin: 15px 0; display: none;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="same-as-store-hours" onchange="toggleSameAsStoreHours()" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span id="same-as-store-hours-text" style="font-size: 16px;">Same as store hours</span>
                                </label>
                            </div>

                            <div class="store-hours" style="margin-top: 20px; padding: 15px; overflow: visible;">
                                <div class="hours-header">
                                    <div id="header-day-2">Day</div>
                                    <div id="header-open-2">Start</div>
                                    <div></div>
                                    <div id="header-close-2">End</div>
                                    <div id="header-closed-2">Closed</div>
                                </div>
                                <div class="hours-row">
                                    <div class="day-label" id="monday2">Monday</div>
                                    <input type="time" class="time-input" id="monday-open" value="09:00">
                                    <span style="text-align: center; font-size: 12px;">–</span>
                                    <input type="time" class="time-input" id="monday-close" value="18:00">
                                    <div class="closed-toggle">
                                        <input type="checkbox" class="closed-checkbox" id="monday-closed" onchange="toggleDayClosed('monday')">
                                    </div>
                                </div>
                                <div class="hours-row">
                                    <div class="day-label" id="tuesday2">Tuesday</div>
                                    <input type="time" class="time-input" id="tuesday-open" value="09:00">
                                    <span style="text-align: center; font-size: 12px;">–</span>
                                    <input type="time" class="time-input" id="tuesday-close" value="18:00">
                                    <div class="closed-toggle">
                                        <input type="checkbox" class="closed-checkbox" id="tuesday-closed" onchange="toggleDayClosed('tuesday')">
                                    </div>
                                </div>
                                <div class="hours-row">
                                    <div class="day-label" id="wednesday2">Wednesday</div>
                                    <input type="time" class="time-input" id="wednesday-open" value="09:00">
                                    <span style="text-align: center; font-size: 12px;">–</span>
                                    <input type="time" class="time-input" id="wednesday-close" value="18:00">
                                    <div class="closed-toggle">
                                        <input type="checkbox" class="closed-checkbox" id="wednesday-closed" onchange="toggleDayClosed('wednesday')">
                                    </div>
                                </div>
                                <div class="hours-row">
                                    <div class="day-label" id="thursday2">Thursday</div>
                                    <input type="time" class="time-input" id="thursday-open" value="09:00">
                                    <span style="text-align: center; font-size: 12px;">–</span>
                                    <input type="time" class="time-input" id="thursday-close" value="18:00">
                                    <div class="closed-toggle">
                                        <input type="checkbox" class="closed-checkbox" id="thursday-closed" onchange="toggleDayClosed('thursday')">
                                    </div>
                                </div>
                                <div class="hours-row">
                                    <div class="day-label" id="friday2">Friday</div>
                                    <input type="time" class="time-input" id="friday-open" value="09:00">
                                    <span style="text-align: center; font-size: 12px;">–</span>
                                    <input type="time" class="time-input" id="friday-close" value="20:00">
                                    <div class="closed-toggle">
                                        <input type="checkbox" class="closed-checkbox" id="friday-closed" onchange="toggleDayClosed('friday')">
                                    </div>
                                </div>
                                <div class="hours-row">
                                    <div class="day-label" id="saturday2">Saturday</div>
                                    <input type="time" class="time-input" id="saturday-open" value="10:00">
                                    <span style="text-align: center; font-size: 12px;">–</span>
                                    <input type="time" class="time-input" id="saturday-close" value="17:00">
                                    <div class="closed-toggle">
                                        <input type="checkbox" class="closed-checkbox" id="saturday-closed" onchange="toggleDayClosed('saturday')">
                                    </div>
                                </div>
                                <div class="hours-row">
                                    <div class="day-label" id="sunday2">Sunday</div>
                                    <input type="time" class="time-input" id="sunday-open" value="" disabled>
                                    <span style="text-align: center; font-size: 12px;">–</span>
                                    <input type="time" class="time-input" id="sunday-close" value="" disabled>
                                    <div class="closed-toggle">
                                        <input type="checkbox" class="closed-checkbox" id="sunday-closed" checked onchange="toggleDayClosed('sunday')">
                                    </div>
                                </div>
                                <button class="add-button" id="save-hours-btn" onclick="saveStoreHours()">Save Hours</button>
                                <div id="hours-message" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
                            </div>

                            <!-- Time Off Section -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                                <h3 id="time-off-title" style="margin-bottom: 15px; color: #333;">Time Off</h3>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="time-off-enabled" onchange="toggleTimeOff()" style="margin-right: 10px;">
                                        <span id="time-off-label">I need to take time off</span>
                                    </label>
                                </div>

                                <div id="time-off-fields" style="display: none;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div>
                                            <label id="time-off-start-date-label" style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">Start Date</label>
                                            <input type="date" id="time-off-start-date" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label id="time-off-start-time-label" style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">Start Time</label>
                                            <input type="time" id="time-off-start-time" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                                        </div>
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div>
                                            <label id="time-off-end-date-label" style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">End Date</label>
                                            <input type="date" id="time-off-end-date" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label id="time-off-end-time-label" style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">End Time</label>
                                            <input type="time" id="time-off-end-time" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                                        </div>
                                    </div>

                                    <div style="margin-bottom: 15px;">
                                        <label id="time-off-reason-label" style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">Reason (optional)</label>
                                        <input type="text" id="time-off-reason" placeholder="e.g., Vacation, Personal time" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
                                    </div>

                                    <button class="add-button" id="save-time-off-btn" onclick="saveTimeOff()">Save Time Off</button>
                                    <button class="delete-button" id="clear-time-off-btn" onclick="clearTimeOff()" style="margin-left: 10px; display: none;">Clear Time Off</button>
                                    <div id="time-off-message" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page dots -->
                <div class="page-dots">
                    <div class="dot active" onclick="switchServicesPage(0)"></div>
                    <div class="dot" onclick="switchServicesPage(1)"></div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="section">
                <h2 id="settings-title">Settings</h2>

                <div style="margin-top: 20px;">
                    <div class="settings-item" onclick="openProfile()">
                        <div style="display: flex; align-items: center;">
                            <div class="settings-icon">👤</div>
                            <div>
                                <div style="font-weight: bold;" id="profile-title">Profile</div>
                                <div style="font-size: 12px; color: #666;" id="profile-desc">Manage your business information</div>
                            </div>
                        </div>
                        <span style="color: #999;">›</span>
                    </div>

                    <div class="settings-item" onclick="openEmailSettings()">
                        <div style="display: flex; align-items: center;">
                            <div class="settings-icon">📧</div>
                            <div>
                                <div style="font-weight: bold;" id="email-settings-title">Email Settings</div>
                                <div style="font-size: 12px; color: #666;" id="email-settings-desc">Configure EmailJS for notifications</div>
                            </div>
                        </div>
                        <span style="color: #999;">›</span>
                    </div>

                    <div class="settings-item" onclick="openBookingLink()">
                        <div style="display: flex; align-items: center;">
                            <div class="settings-icon">🔗</div>
                            <div>
                                <div style="font-weight: bold;" id="booking-link-title">Booking Link</div>
                                <div style="font-size: 12px; color: #666;" id="booking-link-desc">Share your custom booking URL</div>
                            </div>
                        </div>
                        <span style="color: #999;">›</span>
                    </div>

                    <div class="settings-item" onclick="openCancellationPolicy()">
                        <div style="display: flex; align-items: center;">
                            <div class="settings-icon">⚠️</div>
                            <div>
                                <div style="font-weight: bold;" id="cancel-policy-title">Cancellation Policy</div>
                                <div style="font-size: 12px; color: #666;" id="cancel-policy-desc">Set minimum notice period for changes</div>
                            </div>
                        </div>
                        <span style="color: #999;">›</span>
                    </div>


                    <div class="settings-item" onclick="openPayments()">
                        <div style="display: flex; align-items: center;">
                            <div class="settings-icon">💳</div>
                            <div>
                                <div style="font-weight: bold;" id="payment-title">Payment Methods</div>
                                <div style="font-size: 12px; color: #666;" id="payment-desc">Manage accepted payment options</div>
                            </div>
                        </div>
                        <span style="color: #999;">›</span>
                    </div>


                    <div class="settings-item" onclick="openHelp()">
                        <div style="display: flex; align-items: center;">
                            <div class="settings-icon">❓</div>
                            <div>
                                <div style="font-weight: bold;" id="help-title">Help & Support</div>
                                <div style="font-size: 12px; color: #666;" id="help-desc">Get help and contact support</div>
                            </div>
                        </div>
                        <span style="color: #999;">›</span>
                    </div>

                    <div class="settings-item" onclick="openAbout()">
                        <div style="display: flex; align-items: center;">
                            <div class="settings-icon">ℹ️</div>
                            <div>
                                <div style="font-weight: bold;" id="about-title">About</div>
                                <div style="font-size: 12px; color: #666;" id="about-desc">Version 1.0.0</div>
                            </div>
                        </div>
                        <span style="color: #999;">›</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <span>📊</span>
                <div id="nav-dashboard">Dashboard</div>
            </div>
            <div class="nav-item" onclick="showSection('calendar')">
                <span>📅</span>
                <div id="nav-calendar">Calendar</div>
            </div>
            <div class="nav-item" onclick="showSection('services')">
                <span>👥</span>
                <div id="nav-services">Staff</div>
            </div>
            <div class="nav-item" onclick="showSection('settings')">
                <span>⚙️</span>
                <div id="nav-settings">Settings</div>
            </div>
        </div>
    </div>

    <script>
        let isZh = false;
        let currentWeekStart = new Date();
        let touchStartX = null;

        // Variables for drag selection
        let isSelecting = false;
        let selectionStart = null;
        let selectionEnd = null;
        let selectionOverlay = null;

        // Set current week to start on Sunday (matching the calendar display)
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            const result = new Date(d.setDate(diff));
            result.setHours(0, 0, 0, 0);
            return result;
        }

        currentWeekStart = getWeekStart(new Date());

        const translations = {
            zh: {
                appTitle: '商家管理',
                dashboardTitle: '仪表盘',
                todayAppointments: '今日预约',
                weekRevenue: '本周收入',
                nextWeekRevenue: '下周预计收入',
                utilizationRate: '利用率',
                upcomingAppointments: '即将到来的预约',
                weeklyRevenue: '每周收入',
                serviceBreakdown: '服务时间分布',
                allStaff: '所有员工',
                calendarTitle: '日历',
                selectedDateAppointments: '今日日程',
                servicesTitle: '服务项目',
                storeTitle: '服务项目',
                settingsTitle: '设置',
                storeHoursTitle: '营业时间',
                staffHoursTitle: '员工时间',
                sameAsStoreHours: '与店铺营业时间相同',
                storeOpenTime: '开店时间',
                storeCloseTime: '关店时间',
                businessDays: '营业日',
                storeHoursDay: '日期',
                storeHoursOpens: '开始',
                storeHoursCloses: '结束',
                storeHoursClosed: '休息',
                storeDaySunday: '周日',
                storeDayMonday: '周一',
                storeDayTuesday: '周二',
                storeDayWednesday: '周三',
                storeDayThursday: '周四',
                storeDayFriday: '周五',
                storeDaySaturday: '周六',
                navDashboard: '仪表盘',
                navCalendar: '日历',
                navServices: '员工',
                navSettings: '设置',
                addService: '添加新服务',
                saveSettings: '保存设置',
                configurationFor: '配置：',
                backToStaffList: '← 返回员工列表',
                services: {
                    mensCut: '男士理发',
                    womensCut: '女士理发',
                    childrensCut: '儿童理发',
                    hairColoring: '染发',
                    highlights: '挑染'
                },
                customers: {
                    johnSmith: '张先生',
                    sarahJohnson: '李女士',
                    mikeChen: '陈先生'
                },
                activeTime: '需在场时间',
                days: {
                    monday: '周一',
                    tuesday: '周二',
                    wednesday: '周三',
                    thursday: '周四',
                    friday: '周五',
                    saturday: '周六',
                    sunday: '周日'
                },
                daysShort: {
                    mon: '周一',
                    tue: '周二',
                    wed: '周三',
                    thu: '周四',
                    fri: '周五',
                    sat: '周六',
                    sun: '周日'
                },
                closed: '休息',
                ownerBookingTitle: '创建预约',
                selectService: '选择服务',
                chooseService: '选择服务...',
                custom: '自定义',
                customerName: '客户姓名',
                customerPhone: '电话（可选）',
                customerEmail: '邮箱（可选）',
                bookingDate: '日期',
                startTime: '开始时间',
                endTime: '结束时间',
                startDate: '开始日期',
                endDate: '结束日期',
                createBooking: '创建预约',
                cancel: '取消',
                timeOffTitle: '休假时间',
                timeOffLabel: '我需要休假',
                timeOffStartDate: '开始日期',
                timeOffStartTime: '开始时间',
                timeOffEndDate: '结束日期',
                timeOffEndTime: '结束时间',
                timeOffReason: '原因（可选）',
                saveTimeOff: '保存休假',
                clearTimeOff: '清除休假',
                bookingLinkTitle: '预约链接',
                bookingLinkDesc: '分享您的自定义预约网址',
                bookingLinkModalTitle: '预约链接',
                bookingLinkIntro: '创建一个自定义网址，客户可以使用它来预约。',
                cancelPolicyTitle: '取消政策',
                cancelPolicyDesc: '设置更改的最短通知期',
                cancelPolicyModalTitle: '取消政策',
                cancelPolicyIntro: '设置客户取消或重新安排预约所需的最短通知期。',
                minNoticeLabel: '最短通知期（小时）：',
                policyHint: '输入0允许随时取消，或最多168小时（1周）',
                // Email Settings translations
                emailSettingsTitle: '邮件通知',
                emailSettingsDesc: '管理客户邮件通知',
                emailSettingsModalTitle: '邮件通知',
                emailSettingsIntro: '选择向客户发送哪些邮件通知。',
                emailMainToggleLabel: '发送邮件通知',
                emailMainToggleDesc: '自动向客户发送预约相关通知',
                emailConfirmationLabel: '预约确认',
                emailConfirmationDesc: '当预约创建时发送',
                emailRescheduleLabel: '改期通知',
                emailRescheduleDesc: '当预约改期时发送',
                emailCancellationLabel: '取消通知',
                emailCancellationDesc: '当预约取消时发送',
                saveEmailSettingsBtn: '保存设置',
                cancelEmailSettingsBtn: '取消',
                // Profile Modal translations
                profileModalTitle: '商家资料',
                profileModalIntro: '管理您的商家信息，这些信息将显示在电子邮件和客户通信中。',
                labelFirstName: '名字',
                labelLastName: '姓氏',
                labelOwnerPhone: '电话号码',
                labelOwnerEmail: '电子邮件',
                labelWechat: '微信号',
                labelStoreName: '店铺名称',
                labelStoreAddress: '店铺地址',
                profileSuccessMsg: '资料保存成功！',
                saveProfileBtn: '保存资料',
                cancelBtn: '取消',
                optional: '（可选）',
                policyPreviewTitle: '政策预览：',
                policyImportant: '重要提示：',
                policyNote1: '此政策仅适用于客户发起的更改',
                policyNote2: '您仍然可以随时修改或取消预约',
                policyNote3: '客户在预约时会看到此政策',
                savePolicyBtn: '保存政策',
                urlLabel: '您的自定义网址',
                checkAvailability: '检查可用性',
                yourBookingLink: '您的预约链接：',
                copyBtn: '复制',
                qrCodeTitle: '二维码',
                saveUrl: '保存网址',
                urlAvailable: '网址可用！',
                urlTaken: '此网址已被使用',
                urlSaved: '网址已保存成功！',
                minChars: '至少需要3个字符',
                invalidFormat: '只能使用小写字母、数字和连字符'
            },
            en: {
                appTitle: 'Shop Management',
                dashboardTitle: 'Dashboard',
                todayAppointments: "Today's Appointments",
                weekRevenue: "This Week's Revenue",
                nextWeekRevenue: "Next Week's Revenue",
                utilizationRate: 'Utilization Rate',
                upcomingAppointments: 'Upcoming Appointments',
                weeklyRevenue: 'Weekly Revenue',
                serviceBreakdown: 'Service Time Breakdown',
                allStaff: 'All Staff',
                calendarTitle: 'Calendar',
                selectedDateAppointments: "Today's Schedule",
                servicesTitle: 'Services',
                storeTitle: 'Services',
                settingsTitle: 'Settings',
                storeHoursTitle: 'Store Hours',
                staffHoursTitle: 'Staff Hours',
                sameAsStoreHours: 'Same as store hours',
                storeOpenTime: 'Opening Time',
                storeCloseTime: 'Closing Time',
                businessDays: 'Business Days',
                storeHoursDay: 'Day',
                storeHoursOpens: 'Start',
                storeHoursCloses: 'End',
                storeHoursClosed: 'Closed',
                storeDaySunday: 'Sunday',
                storeDayMonday: 'Monday',
                storeDayTuesday: 'Tuesday',
                storeDayWednesday: 'Wednesday',
                storeDayThursday: 'Thursday',
                storeDayFriday: 'Friday',
                storeDaySaturday: 'Saturday',
                navDashboard: 'Dashboard',
                navCalendar: 'Calendar',
                navServices: 'Staff',
                navSettings: 'Settings',
                addService: 'Add New Service',
                saveSettings: 'Save Settings',
                configurationFor: 'Configuration for:',
                backToStaffList: '← Back to Staff List',
                services: {
                    mensCut: "Men's Cut",
                    womensCut: "Women's Cut",
                    childrensCut: "Children's Cut",
                    hairColoring: 'Hair Coloring',
                    highlights: 'Highlights'
                },
                customers: {
                    johnSmith: 'John Smith',
                    sarahJohnson: 'Sarah Johnson',
                    mikeChen: 'Mike Chen'
                },
                activeTime: 'Active time',
                days: {
                    monday: 'Monday',
                    tuesday: 'Tuesday',
                    wednesday: 'Wednesday',
                    thursday: 'Thursday',
                    friday: 'Friday',
                    saturday: 'Saturday',
                    sunday: 'Sunday'
                },
                daysShort: {
                    mon: 'Mon',
                    tue: 'Tue',
                    wed: 'Wed',
                    thu: 'Thu',
                    fri: 'Fri',
                    sat: 'Sat',
                    sun: 'Sun'
                },
                closed: 'Closed',
                ownerBookingTitle: 'Create Booking',
                selectService: 'Select Service',
                chooseService: 'Choose a service...',
                custom: 'Custom',
                customerName: 'Customer Name',
                customerPhone: 'Phone (Optional)',
                customerEmail: 'Email (Optional)',
                bookingDate: 'Date',
                startTime: 'Start Time',
                endTime: 'End Time',
                startDate: 'Start Date',
                endDate: 'End Date',
                createBooking: 'Create Booking',
                cancel: 'Cancel',
                timeOffTitle: 'Time Off',
                timeOffLabel: 'I need to take time off',
                timeOffStartDate: 'Start Date',
                timeOffStartTime: 'Start Time',
                timeOffEndDate: 'End Date',
                timeOffEndTime: 'End Time',
                timeOffReason: 'Reason (optional)',
                saveTimeOff: 'Save Time Off',
                clearTimeOff: 'Clear Time Off',
                bookingLinkTitle: 'Booking Link',
                bookingLinkDesc: 'Share your custom booking URL',
                bookingLinkModalTitle: 'Booking Link',
                bookingLinkIntro: 'Create a custom URL that customers can use to book appointments with you.',
                cancelPolicyTitle: 'Cancellation Policy',
                cancelPolicyDesc: 'Set minimum notice period for changes',
                cancelPolicyModalTitle: 'Cancellation Policy',
                cancelPolicyIntro: 'Set the minimum notice period required for customers to cancel or reschedule appointments.',
                minNoticeLabel: 'Minimum Notice Period (hours):',
                policyHint: 'Enter 0 to allow cancellations anytime, or up to 168 hours (1 week)',
                // Email Settings translations
                emailSettingsTitle: 'Email Notifications',
                emailSettingsDesc: 'Manage customer email notifications',
                emailSettingsModalTitle: 'Email Notifications',
                emailSettingsIntro: 'Choose which email notifications to send to your customers.',
                emailMainToggleLabel: 'Send email notifications',
                emailMainToggleDesc: 'Automatically notify customers about their appointments',
                emailConfirmationLabel: 'Booking confirmations',
                emailConfirmationDesc: 'Send when appointments are booked',
                emailRescheduleLabel: 'Reschedule notifications',
                emailRescheduleDesc: 'Send when appointments are rescheduled',
                emailCancellationLabel: 'Cancellation notices',
                emailCancellationDesc: 'Send when appointments are cancelled',
                saveEmailSettingsBtn: 'Save Settings',
                cancelEmailSettingsBtn: 'Cancel',
                // Profile Modal translations
                profileModalTitle: 'Business Profile',
                profileModalIntro: 'Manage your business information that will appear in emails and customer communications.',
                labelFirstName: 'First Name',
                labelLastName: 'Last Name',
                labelOwnerPhone: 'Phone Number',
                labelOwnerEmail: 'Email',
                labelWechat: 'WeChat ID',
                labelStoreName: 'Store Name',
                labelStoreAddress: 'Store Address',
                profileSuccessMsg: 'Profile saved successfully!',
                saveProfileBtn: 'Save Profile',
                cancelBtn: 'Cancel',
                optional: '(optional)',
                policyPreviewTitle: 'Policy Preview:',
                policyImportant: 'Important:',
                policyNote1: 'This policy applies to customer-initiated changes only',
                policyNote2: 'You can still modify or cancel appointments at any time',
                policyNote3: 'Customers will see this policy when booking',
                savePolicyBtn: 'Save Policy',
                urlLabel: 'Your Custom URL',
                checkAvailability: 'Check Availability',
                yourBookingLink: 'Your Booking Link:',
                copyBtn: 'Copy',
                qrCodeTitle: 'QR Code',
                saveUrl: 'Save URL',
                urlAvailable: 'URL is available!',
                urlTaken: 'This URL is already taken',
                urlSaved: 'URL saved successfully!',
                minChars: 'Minimum 3 characters required',
                invalidFormat: 'Only lowercase letters, numbers, and hyphens allowed'
            }
        };

        function toggleLang() {
            isZh = !isZh;
            updateLanguage();

            // Force update of dropdown text for "All Staff"
            const t = isZh ? translations.zh : translations.en;

            // Update calendar dropdown
            const calendarSelect = document.getElementById('calendar-barber-select');
            if (calendarSelect && calendarSelect.options[0] && calendarSelect.options[0].value === '') {
                calendarSelect.options[0].text = t.allStaff;
            }

            // Update dashboard dropdown
            const dashboardSelect = document.getElementById('dashboard-barber-select');
            if (dashboardSelect && dashboardSelect.options[0] && dashboardSelect.options[0].value === '') {
                dashboardSelect.options[0].text = t.allStaff;
            }
        }

        // Helper function to translate service names
        function translateServiceName(name) {
            if (!isZh) return name;
            const serviceTranslations = {
                "Men's Cut": '男士理发',
                "Women's Cut": '女士理发',
                "Children's Cut": '儿童理发',
                "Hair Coloring": '染发',
                "Highlights": '挑染',
                "Perm": '烫发',
                "Hair Treatment": '护理',
                "Beard": '修胡子',
                "Beard Trim": '修胡子'
            };
            return serviceTranslations[name] || name;
        }

        function updateLanguage() {
            const t = isZh ? translations.zh : translations.en;

            // Helper function to safely update element text
            function updateElement(id, text) {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            }

            updateElement('app-title', t.appTitle);
            const langToggle = document.querySelector('.lang-toggle');
            if (langToggle) langToggle.textContent = isZh ? 'EN' : '中文';

            // Update All Staff options in dropdowns
            updateElement('dashboard-allstaff-option', t.allStaff);
            updateElement('calendar-allstaff-option', t.allStaff);

            // Dashboard
            updateElement('dashboard-title', t.dashboardTitle);
            updateElement('today-appointments-label', t.todayAppointments);
            updateElement('week-revenue-label', t.weekRevenue);
            updateElement('utilization-rate-label', t.utilizationRate);
            updateElement('next-week-revenue-label', t.nextWeekRevenue);
            updateElement('upcoming-appointments', t.upcomingAppointments);
            updateElement('weekly-revenue', t.weeklyRevenue);
            const serviceBreakdownEl = document.getElementById('service-breakdown-title');
            if (serviceBreakdownEl) {
                serviceBreakdownEl.textContent = t.serviceBreakdown;
            }

            // Update customer names
            updateElement('customer1', t.customers.johnSmith);
            updateElement('customer2', t.customers.sarahJohnson);
            updateElement('customer3', t.customers.mikeChen);

            // Update service names in appointments
            updateElement('service1', t.services.mensCut);
            updateElement('service2', t.services.hairColoring);
            updateElement('service3', t.services.mensCut + ' + Beard');
            updateElement('active-time2', `${t.activeTime}: 30 min`);

            // Week days
            updateElement('mon', t.daysShort.mon);
            updateElement('tue', t.daysShort.tue);
            updateElement('wed', t.daysShort.wed);
            updateElement('thu', t.daysShort.thu);
            updateElement('fri', t.daysShort.fri);
            updateElement('sat', t.daysShort.sat);
            updateElement('sun', t.daysShort.sun);

            // Calendar
            updateElement('calendar-title', t.calendarTitle);
            updateElement('selected-date-appointments', t.selectedDateAppointments);

            // Services
            updateElement('services-title', t.servicesTitle);
            // Service names are now input fields, so we don't update them here to preserve user edits
            // Active time labels are now integrated in the input fields
            updateElement('add-service-btn', t.addService);

            // Settings
            updateElement('settings-title', t.settingsTitle);

            // Staff Hours (in Staff > Services tab)
            const staffHoursEl = document.getElementById('staff-hours-title');
            if (staffHoursEl) staffHoursEl.textContent = t.staffHoursTitle;

            // Same as store hours checkbox
            const sameAsStoreHoursText = document.getElementById('same-as-store-hours-text');
            if (sameAsStoreHoursText) sameAsStoreHoursText.textContent = t.sameAsStoreHours;

            // Configuration for text
            updateElement('config-for-text', t.configurationFor);

            // Back to Staff List button
            updateElement('back-to-staff-btn', t.backToStaffList);

            // Store hours labels in Profile modal
            updateElement('store-hours-heading', t.storeHoursTitle);
            updateElement('store-hours-label-day', t.storeHoursDay);
            updateElement('store-hours-label-opens', t.storeHoursOpens);
            updateElement('store-hours-label-closes', t.storeHoursCloses);
            updateElement('store-hours-label-closed', t.storeHoursClosed);

            // Store hours day names
            updateElement('store-day-sunday', t.storeDaySunday);
            updateElement('store-day-monday', t.storeDayMonday);
            updateElement('store-day-tuesday', t.storeDayTuesday);
            updateElement('store-day-wednesday', t.storeDayWednesday);
            updateElement('store-day-thursday', t.storeDayThursday);
            updateElement('store-day-friday', t.storeDayFriday);
            updateElement('store-day-saturday', t.storeDaySaturday);

            // Update day labels in store hours
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach(day => {
                const el = document.getElementById(day + '2');
                if (el) el.textContent = t.days[day];
            });

            // Update header labels
            const headerDay2 = document.getElementById('header-day-2');
            const headerOpen2 = document.getElementById('header-open-2');
            const headerClose2 = document.getElementById('header-close-2');
            const headerClosed2 = document.getElementById('header-closed-2');

            if (headerDay2) headerDay2.textContent = isZh ? '日期' : 'Day';
            if (headerOpen2) headerOpen2.textContent = isZh ? '开始' : 'Start';
            if (headerClose2) headerClose2.textContent = isZh ? '结束' : 'End';
            if (headerClosed2) headerClosed2.textContent = t.closed;

            // Owner Booking Modal
            updateElement('owner-booking-title', t.ownerBookingTitle);
            updateElement('label-service-selection', t.selectService);
            updateElement('label-customer-name', t.customerName + (isZh ? ' *' : ' *'));
            updateElement('label-customer-phone', t.customerPhone);
            updateElement('label-customer-email', t.customerEmail);
            updateElement('label-booking-date', t.bookingDate);
            updateElement('label-start-time', t.startTime);
            updateElement('label-end-time', t.endTime);
            updateElement('label-start-date', t.startDate);
            updateElement('label-end-date', t.endDate);

            // Update button text
            const createBookingBtn = document.querySelector('#owner-booking-modal .confirm-button');
            if (createBookingBtn) createBookingBtn.textContent = t.createBooking;
            const cancelBtn = document.querySelector('#owner-booking-modal .cancel-button');
            if (cancelBtn) cancelBtn.textContent = t.cancel;

            // Update dropdown placeholder
            const serviceSelect = document.getElementById('owner-booking-service');
            if (serviceSelect && serviceSelect.options[0]) {
                serviceSelect.options[0].textContent = t.chooseService;
            }
            // Update Custom option text
            if (serviceSelect && serviceSelect.options[serviceSelect.options.length - 1]) {
                serviceSelect.options[serviceSelect.options.length - 1].textContent = t.custom;
            }

            const saveHoursBtn = document.getElementById('save-hours-btn');
            if (saveHoursBtn) saveHoursBtn.textContent = isZh ? '保存时间' : 'Save Hours';

            // Time Off section translations
            updateElement('time-off-title', t.timeOffTitle);
            updateElement('time-off-label', t.timeOffLabel);
            updateElement('time-off-start-date-label', t.timeOffStartDate);
            updateElement('time-off-start-time-label', t.timeOffStartTime);
            updateElement('time-off-end-date-label', t.timeOffEndDate);
            updateElement('time-off-end-time-label', t.timeOffEndTime);
            updateElement('time-off-reason-label', t.timeOffReason);
            const saveTimeOffBtn = document.getElementById('save-time-off-btn');
            if (saveTimeOffBtn) saveTimeOffBtn.textContent = t.saveTimeOff;
            const clearTimeOffBtn = document.getElementById('clear-time-off-btn');
            if (clearTimeOffBtn) clearTimeOffBtn.textContent = t.clearTimeOff;
            const reasonInput = document.getElementById('time-off-reason');
            if (reasonInput) {
                reasonInput.placeholder = isZh ? '例如：休假，个人时间' : 'e.g., Vacation, Personal time';
            }

            // Settings items
            updateElement('profile-title', isZh ? '个人资料' : 'Profile');
            updateElement('profile-desc', isZh ? '管理您的商家信息' : 'Manage your business information');
            updateElement('email-settings-title', t.emailSettingsTitle);
            updateElement('email-settings-desc', t.emailSettingsDesc);
            updateElement('booking-link-title', t.bookingLinkTitle);
            updateElement('booking-link-desc', t.bookingLinkDesc);
            updateElement('cancel-policy-title', t.cancelPolicyTitle);
            updateElement('cancel-policy-desc', t.cancelPolicyDesc);
            // Booking Link Modal translations
            updateElement('booking-link-modal-title', t.bookingLinkModalTitle);
            updateElement('booking-link-intro', t.bookingLinkIntro);
            updateElement('url-label', t.urlLabel);
            updateElement('cancel-booking-link-btn', t.cancelBtn);

            // Cancellation Policy Modal translations
            updateElement('cancel-policy-modal-title', t.cancelPolicyModalTitle);
            updateElement('cancel-policy-intro', t.cancelPolicyIntro);
            updateElement('min-notice-label', t.minNoticeLabel);
            updateElement('policy-hint', t.policyHint);
            updateElement('policy-preview-title', t.policyPreviewTitle);
            updateElement('policy-important', t.policyImportant);
            updateElement('policy-note1', t.policyNote1);
            updateElement('policy-note2', t.policyNote2);
            updateElement('policy-note3', t.policyNote3);
            
            // Email Settings Modal translations
            updateElement('email-settings-modal-title', t.emailSettingsModalTitle);
            updateElement('email-settings-intro', t.emailSettingsIntro);
            updateElement('email-main-toggle-label', t.emailMainToggleLabel);
            updateElement('email-main-toggle-desc', t.emailMainToggleDesc);
            updateElement('email-confirmation-label', t.emailConfirmationLabel);
            updateElement('email-confirmation-desc', t.emailConfirmationDesc);
            updateElement('email-reschedule-label', t.emailRescheduleLabel);
            updateElement('email-reschedule-desc', t.emailRescheduleDesc);
            updateElement('email-cancellation-label', t.emailCancellationLabel);
            updateElement('email-cancellation-desc', t.emailCancellationDesc);
            updateElement('save-email-settings-btn', t.saveEmailSettingsBtn);
            updateElement('cancel-email-settings-btn', t.cancelEmailSettingsBtn);
            
            // Profile Modal translations
            updateElement('profile-modal-title', t.profileModalTitle);
            updateElement('profile-modal-intro', t.profileModalIntro);
            updateElement('label-first-name', t.labelFirstName);
            updateElement('label-last-name', t.labelLastName);
            updateElement('label-owner-phone', t.labelOwnerPhone);
            updateElement('label-owner-email', t.labelOwnerEmail);
            updateElement('label-wechat', t.labelWechat);
            updateElement('label-store-name', t.labelStoreName);
            updateElement('label-store-address', t.labelStoreAddress);
            updateElement('profile-success-msg', t.profileSuccessMsg);
            updateElement('save-profile-btn', t.saveProfileBtn);
            updateElement('cancel-profile-btn', t.cancelBtn);
            
            // Update optional labels in profile modal
            document.querySelectorAll('#profile-modal span').forEach(span => {
                if (span.style.color === '#999' || span.style.color === 'rgb(153, 153, 153)') {
                    if (span.textContent.includes('optional') || span.textContent.includes('可选')) {
                        span.textContent = t.optional;
                    }
                }
            });
            const savePolicyBtn = document.getElementById('save-policy-btn');
            if (savePolicyBtn) savePolicyBtn.textContent = t.savePolicyBtn;
            updateElement('check-availability-btn', t.checkAvailability);
            updateElement('your-booking-link', t.yourBookingLink);
            updateElement('copy-btn-text', t.copyBtn);
            updateElement('qr-code-title', t.qrCodeTitle);
            updateElement('save-url-btn', t.saveUrl);
            updateElement('payment-title', isZh ? '支付方式' : 'Payment Methods');
            updateElement('payment-desc', isZh ? '管理接受的支付选项' : 'Manage accepted payment options');
            updateElement('policy-title', isZh ? '政策' : 'Policies');
            updateElement('policy-desc', isZh ? '取消和预约政策' : 'Cancellation and booking policies');
            updateElement('help-title', isZh ? '帮助与支持' : 'Help & Support');
            updateElement('help-desc', isZh ? '获取帮助和联系支持' : 'Get help and contact support');
            updateElement('about-title', isZh ? '关于' : 'About');

            // Navigation
            updateElement('nav-dashboard', t.navDashboard);
            updateElement('nav-calendar', t.navCalendar);
            updateElement('nav-services', t.navServices);
            updateElement('nav-settings', t.navSettings);

            // Update Store tab translations
            updateStoreTabTranslations();
        }

        function updateStoreTabTranslations() {
            // Update "min" labels
            document.querySelectorAll('.min-label').forEach(label => {
                label.textContent = isZh ? '分钟' : 'min';
            });

            // Update "Has active time periods" labels
            document.querySelectorAll('.active-periods-label').forEach(label => {
                label.textContent = isZh ? '有活动时间段' : 'Has active time periods';
            });

            // Update "Period X:" labels
            document.querySelectorAll('.period-label').forEach(label => {
                const text = label.textContent;
                if (text.includes('Period') || text.includes('时段')) {
                    const num = text.match(/\d+/);
                    if (num) {
                        label.textContent = isZh ? `时段 ${num[0]}:` : `Period ${num[0]}:`;
                    }
                }
            });

            // Update "to" labels
            document.querySelectorAll('.to-label').forEach(label => {
                label.textContent = isZh ? '到' : 'to';
            });

            // Update "Add period" buttons
            document.querySelectorAll('.add-period-btn').forEach(btn => {
                btn.textContent = isZh ? '添加时段' : 'Add period';
            });

            // Update service names in the Store tab (these are input placeholders)
            const serviceNameInputs = {
                'service-mens-cut': { en: "Men's Cut", zh: '男士理发' },
                'service-womens-cut': { en: "Women's Cut", zh: '女士理发' },
                'service-kids-cut': { en: "Children's Cut", zh: '儿童理发' },
                'service-coloring': { en: 'Hair Coloring', zh: '染发' },
                'service-highlights': { en: 'Highlights', zh: '挑染' }
            };

            Object.entries(serviceNameInputs).forEach(([id, names]) => {
                const input = document.getElementById(id);
                if (input) {
                    // Only update if the value is still the default English name
                    if (input.value === names.en || input.value === names.zh) {
                        input.value = isZh ? names.zh : names.en;
                    }
                }
            });
        }

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Show selected section
            document.getElementById(`${section}-section`).classList.add('active');

            // Update nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            // Generate calendar if showing calendar section
            if (section === 'calendar') {
                // Generate appropriate view based on selected barber
                if (calendarBarberId === '') {
                    calendarViewMode = 'day';
                    generateDayViewCalendar();
                } else {
                    calendarViewMode = 'week';
                    generateWeeklyCalendar();
                }
            }

            // Update dashboard metrics if showing dashboard section
            if (section === 'dashboard') {
                updateDashboardMetrics();
            }

            // Re-populate barber selectors with translated "All Staff" option
            populateBarberSelectors();
        }

        function toggleService(element) {
            element.classList.toggle('active');
            saveServices();
        }

        function deleteService(serviceId) {
            // Check if we have at least 2 services (need at least 1 to remain)
            const services = SharedData.getServices();
            const enabledCount = Object.keys(services).filter(id => services[id].enabled).length;

            if (Object.keys(services).length <= 1) {
                alert(isZh ? '至少需要保留一个服务' : 'At least one service must remain');
                return;
            }

            if (confirm(isZh ? '确定要删除此服务吗？' : 'Are you sure you want to delete this service?')) {
                // Remove from services object
                delete services[serviceId];
                SharedData.saveServices(services);

                // Remove from DOM
                const serviceElement = document.querySelector(`[data-service="${serviceId}"]`);
                if (serviceElement) {
                    serviceElement.remove();
                }

                showServiceSaveMessage();
            }
        }

        function toggleActiveTime(serviceId) {
            const checkbox = document.getElementById(`toggle-active-${serviceId}`);
            const container = document.getElementById(`active-container-${serviceId}`);

            if (checkbox.checked) {
                container.style.display = 'block';
                // If no periods exist, add a default one
                const periodsList = container.querySelector('.active-periods-list');
                if (!periodsList || periodsList.children.length === 0) {
                    const duration = parseInt(document.querySelector(`[data-service="${serviceId}"] .service-duration`).value) || 30;
                    periodsList.innerHTML = `
                        <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period 1:</span>
                            <input type="number" class="period-start" value="0" min="0" max="${duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                            <span style="font-size: 12px; color: #4A90E2;">to</span>
                            <input type="number" class="period-end" value="${Math.min(duration, 15)}" min="0" max="${duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                            <span style="font-size: 12px; color: #4A90E2;">min</span>
                        </div>
                    `;
                }
            } else {
                container.style.display = 'none';
            }

            saveServices();
        }

        function addPeriodToService(serviceId) {
            const periodsList = document.getElementById(`periods-${serviceId}`);
            const duration = parseInt(document.querySelector(`[data-service="${serviceId}"] .service-duration`).value) || 30;
            const periodCount = periodsList.children.length + 1;

            // Get existing periods to calculate smart defaults
            const existingPeriods = [];
            const periodItems = periodsList.querySelectorAll('.active-period-item');
            periodItems.forEach(item => {
                const start = parseInt(item.querySelector('.period-start').value) || 0;
                const end = parseInt(item.querySelector('.period-end').value) || 0;
                existingPeriods.push({ start, end });
            });

            // Calculate smart defaults for new period
            let defaultStart = 0;
            let defaultEnd = Math.min(15, duration);

            if (existingPeriods.length > 0) {
                // Sort periods by end time to find the last one
                existingPeriods.sort((a, b) => b.end - a.end);
                const lastPeriod = existingPeriods[0];

                // Start 5 minutes after the last period ends
                defaultStart = lastPeriod.end + 5;

                // End 15 minutes after start (or at duration limit)
                defaultEnd = Math.min(defaultStart + 15, duration);

                // If we can't fit a valid period, don't add one
                if (defaultStart >= duration) {
                    alert('No room for additional active periods within service duration');
                    return;
                }
            }

            const newPeriod = document.createElement('div');
            newPeriod.className = 'active-period-item';
            newPeriod.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 5px;';
            newPeriod.innerHTML = `
                <span style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period ${periodCount}:</span>
                <input type="number" class="period-start" value="${defaultStart}" min="0" max="${duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                <span style="font-size: 12px; color: #4A90E2;">to</span>
                <input type="number" class="period-end" value="${defaultEnd}" min="0" max="${duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                <span style="font-size: 12px; color: #4A90E2;">min</span>
                <button onclick="removePeriodFromService(this, '${serviceId}')" style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">×</button>
            `;

            periodsList.appendChild(newPeriod);
            saveServices();
        }

        function removePeriodFromService(button, serviceId) {
            const periodsList = document.getElementById(`periods-${serviceId}`);
            if (periodsList.children.length > 1) {
                button.parentElement.remove();
                // Renumber periods
                Array.from(periodsList.children).forEach((period, index) => {
                    const label = period.querySelector('span');
                    if (label) {
                        const periodText = isZh ? `时段 ${index + 1}:` : `Period ${index + 1}:`;
                        label.textContent = periodText;
                    }
                });
                saveServices();
            } else {
                alert(isZh ? '至少需要一个活动时间段' : 'At least one active period is required');
            }
        }

        function toggleDayClosed(day) {
            const checkbox = document.getElementById(`${day}-closed`);
            const openInput = document.getElementById(`${day}-open`);
            const closeInput = document.getElementById(`${day}-close`);

            if (checkbox.checked) {
                openInput.disabled = true;
                closeInput.disabled = true;
                openInput.value = '';
                closeInput.value = '';
            } else {
                openInput.disabled = false;
                closeInput.disabled = false;
                openInput.value = '09:00';
                closeInput.value = '18:00';
            }
        }

        function toggleStoreDayClosed(day) {
            const checkbox = document.getElementById(`store-${day}-closed`);
            const openInput = document.getElementById(`store-${day}-open`);
            const closeInput = document.getElementById(`store-${day}-close`);

            if (checkbox.checked) {
                openInput.disabled = true;
                closeInput.disabled = true;
                openInput.value = '';
                closeInput.value = '';
            } else {
                openInput.disabled = false;
                closeInput.disabled = false;
                openInput.value = '09:00';
                closeInput.value = '18:00';
            }
        }

        // Helper function to convert time string to minutes for comparison
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function toggleSameAsStoreHours() {
            const checkbox = document.getElementById('same-as-store-hours');
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            if (checkbox.checked) {
                // Get store hours from owner profile
                const ownerProfile = JSON.parse(localStorage.getItem('ownerProfile') || '{}');
                const storeHours = ownerProfile.storeHours;

                if (storeHours) {
                    // Apply store hours to employee
                    days.forEach(day => {
                        const dayCheckbox = document.getElementById(`${day}-closed`);
                        const openInput = document.getElementById(`${day}-open`);
                        const closeInput = document.getElementById(`${day}-close`);

                        // Check if store has hours for this day
                        const dayHours = storeHours[day];
                        if (dayHours) {
                            if (dayHours.closed) {
                                // Store is closed this day
                                dayCheckbox.checked = true;
                                openInput.disabled = true;
                                closeInput.disabled = true;
                                openInput.value = '';
                                closeInput.value = '';
                            } else {
                                // Store is open this day
                                dayCheckbox.checked = false;
                                openInput.disabled = true; // Disabled because using store hours
                                closeInput.disabled = true; // Disabled because using store hours
                                openInput.value = dayHours.open || '09:00';
                                closeInput.value = dayHours.close || '18:00';
                            }
                        } else {
                            // No specific hours for this day, use defaults
                            dayCheckbox.checked = false;
                            openInput.disabled = true;
                            closeInput.disabled = true;
                            openInput.value = '09:00';
                            closeInput.value = '18:00';
                        }

                        // Disable checkbox when using store hours
                        dayCheckbox.disabled = true;
                    });

                    // Save immediately
                    saveStoreHours();
                } else {
                    // No store hours set, use defaults
                    alert('Store hours not set. Please configure store hours in Settings > Profile first.');
                    checkbox.checked = false;
                }
            } else {
                // Enable all inputs when not using store hours
                days.forEach(day => {
                    const dayCheckbox = document.getElementById(`${day}-closed`);
                    const openInput = document.getElementById(`${day}-open`);
                    const closeInput = document.getElementById(`${day}-close`);
                    dayCheckbox.disabled = false;
                    if (!dayCheckbox.checked) {
                        openInput.disabled = false;
                        closeInput.disabled = false;
                    }
                });
            }
        }

        function loadStoreHours() {
            // Get hours for current barber
            const barber = SharedData.getBarberById(window.currentBarberId || 'owner');
            const hours = barber ? (barber.hours || SharedData.getStoreHours()) : SharedData.getStoreHours();
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            // Also check for existing time off
            const timeOff = localStorage.getItem('timeOff');
            if (timeOff) {
                document.getElementById('time-off-enabled').checked = true;
                toggleTimeOff();
            }

            days.forEach(day => {
                const dayHours = hours[day];
                const openInput = document.getElementById(`${day}-open`);
                const closeInput = document.getElementById(`${day}-close`);
                const closedCheckbox = document.getElementById(`${day}-closed`);

                if (dayHours.closed) {
                    closedCheckbox.checked = true;
                    openInput.disabled = true;
                    closeInput.disabled = true;
                    openInput.value = '';
                    closeInput.value = '';
                } else {
                    closedCheckbox.checked = false;
                    openInput.disabled = false;
                    closeInput.disabled = false;
                    openInput.value = dayHours.open || '09:00';
                    closeInput.value = dayHours.close || '18:00';
                }
            });
        }

        function saveStoreHours() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const hours = {};
            let hasError = false;


            // Get store hours for validation
            const ownerProfile = JSON.parse(localStorage.getItem('ownerProfile') || '{}');
            const storeHours = ownerProfile.storeHours;

            // Process and validate hours for ALL staff (including owner)
            if (storeHours) {
                // Validate everyone's hours against store hours
                const sameAsStoreCheckbox = document.getElementById('same-as-store-hours');

                if (sameAsStoreCheckbox && sameAsStoreCheckbox.checked) {
                    // Using store hours - no validation needed
                    days.forEach(day => {
                        const openInput = document.getElementById(`${day}-open`);
                        const closeInput = document.getElementById(`${day}-close`);
                        const closedCheckbox = document.getElementById(`${day}-closed`);

                        if (closedCheckbox.checked) {
                            hours[day] = { open: '', close: '', closed: true };
                        } else {
                            hours[day] = { open: openInput.value, close: closeInput.value, closed: false };
                        }
                    });
                } else {
                    // Not using store hours - validate each day
                    days.forEach(day => {
                        const openInput = document.getElementById(`${day}-open`);
                        const closeInput = document.getElementById(`${day}-close`);
                        const closedCheckbox = document.getElementById(`${day}-closed`);

                        if (closedCheckbox.checked) {
                            hours[day] = { open: '', close: '', closed: true };
                        } else {
                            const openTime = openInput.value;
                            const closeTime = closeInput.value;

                            // Validate times are provided
                            if (!openTime || !closeTime) {
                                hasError = true;
                                openInput.style.borderColor = '#f44336';
                                closeInput.style.borderColor = '#f44336';
                            } else if (storeHours && storeHours[day]) {
                                // Check if store has hours for this day
                                const storeDayHours = storeHours[day];
                                if (storeDayHours.closed) {
                                    hasError = true;
                                    openInput.style.borderColor = '#f44336';
                                    closeInput.style.borderColor = '#f44336';

                                    const messageDiv = document.getElementById('hours-message');
                                    if (messageDiv) {
                                        const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                                        messageDiv.textContent = `${dayName}: Cannot set hours - store is closed this day`;
                                        messageDiv.style.display = 'block';
                                        messageDiv.style.background = '#ff9800';
                                        messageDiv.style.color = 'white';
                                    }
                                } else {
                                    // Validate employee hours are within store hours
                                    const storeOpen = storeDayHours.open;
                                    const storeClose = storeDayHours.close;

                                    if (!storeOpen || !storeClose) {
                                        // Store hours incomplete for this day, allow any hours
                                        hours[day] = { open: openTime, close: closeTime, closed: false };
                                        return; // Skip to next iteration in forEach
                                    }

                                    // Convert times to minutes for proper comparison
                                    const empOpenMinutes = timeToMinutes(openTime);
                                    const empCloseMinutes = timeToMinutes(closeTime);
                                    const storeOpenMinutes = timeToMinutes(storeOpen);
                                    const storeCloseMinutes = timeToMinutes(storeClose);

                                    // Check if end time is before start time
                                    if (empCloseMinutes <= empOpenMinutes) {
                                        hasError = true;
                                        openInput.style.borderColor = '#f44336';
                                        closeInput.style.borderColor = '#f44336';

                                        const messageDiv = document.getElementById('hours-message');
                                        if (messageDiv) {
                                            const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                                            messageDiv.textContent = `${dayName}: End time (${closeTime}) must be after start time (${openTime})`;
                                            messageDiv.style.display = 'block';
                                            messageDiv.style.background = '#f44336';
                                            messageDiv.style.color = 'white';
                                        }
                                    } else if (empOpenMinutes < storeOpenMinutes || empCloseMinutes > storeCloseMinutes) {
                                        hasError = true;
                                        openInput.style.borderColor = '#f44336';
                                        closeInput.style.borderColor = '#f44336';

                                        const messageDiv = document.getElementById('hours-message');
                                        if (messageDiv) {
                                            const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                                            let errorMsg = '';
                                            if (empOpenMinutes < storeOpenMinutes && empCloseMinutes > storeCloseMinutes) {
                                                errorMsg = `${dayName}: Hours (${openTime}-${closeTime}) must be within store hours (${storeOpen}-${storeClose})`;
                                            } else if (empOpenMinutes < storeOpenMinutes) {
                                                errorMsg = `${dayName}: Start time (${openTime}) cannot be before store opening (${storeOpen})`;
                                            } else if (empCloseMinutes > storeCloseMinutes) {
                                                errorMsg = `${dayName}: End time (${closeTime}) cannot be after store closing (${storeClose})`;
                                            }
                                            messageDiv.textContent = errorMsg;
                                            messageDiv.style.display = 'block';
                                            messageDiv.style.background = '#f44336';
                                            messageDiv.style.color = 'white';
                                        }
                                        // Don't add to hours object when validation fails
                                    } else {
                                        openInput.style.borderColor = '';
                                        closeInput.style.borderColor = '';
                                        hours[day] = { open: openTime, close: closeTime, closed: false };
                                    }
                                }
                            } else {
                                // No store hours set for this day or no store hours at all
                                // No store hours to validate against, but still check start/end time logic
                                const openMinutes = timeToMinutes(openTime);
                                const closeMinutes = timeToMinutes(closeTime);

                                if (closeMinutes <= openMinutes) {
                                    hasError = true;
                                    openInput.style.borderColor = '#f44336';
                                    closeInput.style.borderColor = '#f44336';

                                    const messageDiv = document.getElementById('hours-message');
                                    if (messageDiv) {
                                        const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                                        messageDiv.textContent = `${dayName}: End time (${closeTime}) must be after start time (${openTime})`;
                                        messageDiv.style.display = 'block';
                                        messageDiv.style.background = '#f44336';
                                        messageDiv.style.color = 'white';
                                    }
                                } else {
                                    if (!storeHours) {
                                        // Show warning once
                                        const messageDiv = document.getElementById('hours-message');
                                        if (messageDiv && messageDiv.textContent === '') {
                                            messageDiv.textContent = 'Warning: Store hours not set. Please configure in Settings > Profile';
                                            messageDiv.style.display = 'block';
                                            messageDiv.style.background = '#ff9800';
                                            messageDiv.style.color = 'white';
                                        }
                                    }
                                    hours[day] = { open: openTime, close: closeTime, closed: false };
                                }
                            }
                        }
                    });
                }
            } else {
                // No store hours set - allow any hours but show warning
                const messageDiv = document.getElementById('hours-message');
                if (messageDiv) {
                    messageDiv.textContent = isZh ? '警告：未设置商店时间' : 'Warning: Store hours not set. Please configure in Settings > Profile';
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = '#ff9800';
                    messageDiv.style.color = 'white';
                }

                days.forEach(day => {
                    const openInput = document.getElementById(`${day}-open`);
                    const closeInput = document.getElementById(`${day}-close`);
                    const closedCheckbox = document.getElementById(`${day}-closed`);

                    if (closedCheckbox.checked) {
                        hours[day] = { open: '', close: '', closed: true };
                    } else {
                        const openTime = openInput.value;
                        const closeTime = closeInput.value;

                        // Validate times - check if times are provided and in correct format
                        if (!openTime || !closeTime) {
                            hasError = true;
                            openInput.style.borderColor = '#f44336';
                            closeInput.style.borderColor = '#f44336';
                        } else if (!/^\d{2}:\d{2}$/.test(openTime) || !/^\d{2}:\d{2}$/.test(closeTime)) {
                            // Basic time format validation (HH:MM)
                            hasError = true;
                            if (!/^\d{2}:\d{2}$/.test(openTime)) openInput.style.borderColor = '#f44336';
                            if (!/^\d{2}:\d{2}$/.test(closeTime)) closeInput.style.borderColor = '#f44336';
                        } else {
                            // Check if end time is before or equal to start time
                            const openMinutes = timeToMinutes(openTime);
                            const closeMinutes = timeToMinutes(closeTime);

                            if (closeMinutes <= openMinutes) {
                                hasError = true;
                                openInput.style.borderColor = '#f44336';
                                closeInput.style.borderColor = '#f44336';

                                const messageDiv = document.getElementById('hours-message');
                                if (messageDiv) {
                                    const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                                    messageDiv.textContent = `${dayName}: End time (${closeTime}) must be after start time (${openTime})`;
                                    messageDiv.style.display = 'block';
                                    messageDiv.style.background = '#f44336';
                                    messageDiv.style.color = 'white';
                                }
                            } else {
                                openInput.style.borderColor = '';
                                closeInput.style.borderColor = '';
                                hours[day] = { open: openTime, close: closeTime, closed: false };
                            }
                        }
                    }
                });
            }

            if (hasError) {
                const messageDiv = document.getElementById('hours-message');
                if (messageDiv && !messageDiv.textContent) {
                    messageDiv.textContent = isZh ? '请检查输入的时间' : 'Please check the time inputs';
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = '#f44336';
                    messageDiv.style.color = 'white';
                }
                setTimeout(() => {
                    const msg = document.getElementById('hours-message');
                    if (msg) msg.style.display = 'none';
                }, 5000);
                return; // EXIT HERE - DO NOT SAVE
            }



            // Save hours for current barber
            if (window.currentBarberId) {
                // Check if using store hours (only for non-owner staff)
                const sameAsStoreCheckbox = document.getElementById('same-as-store-hours');
                const usesStoreHours = sameAsStoreCheckbox ? sameAsStoreCheckbox.checked : false;
                SharedData.updateBarber(window.currentBarberId, { hours, usesStoreHours });

                // If this is the owner, also save as store hours
                if (window.currentBarberId === 'owner') {
                    SharedData.saveStoreHours(hours);
                }
            }

            // Clear any error borders on successful save
            days.forEach(day => {
                const openInput = document.getElementById(`${day}-open`);
                const closeInput = document.getElementById(`${day}-close`);
                if (openInput) openInput.style.borderColor = '';
                if (closeInput) closeInput.style.borderColor = '';
            });

            // Show success message
            const messageDiv = document.getElementById('hours-message');
            if (messageDiv) {
                messageDiv.textContent = isZh ? '时间已保存！' : 'Hours saved successfully!';
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#4CAF50';
                messageDiv.style.color = 'white';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Time Off Management Functions
        function toggleTimeOff() {
            const checkbox = document.getElementById('time-off-enabled');
            const fields = document.getElementById('time-off-fields');
            fields.style.display = checkbox.checked ? 'block' : 'none';

            if (checkbox.checked) {
                // Load existing time off if any
                loadTimeOff();
            }
        }

        function loadTimeOff() {
            const timeOff = localStorage.getItem('timeOff');
            if (timeOff) {
                const data = JSON.parse(timeOff);
                document.getElementById('time-off-start-date').value = data.startDate || '';
                document.getElementById('time-off-start-time').value = data.startTime || '';
                document.getElementById('time-off-end-date').value = data.endDate || '';
                document.getElementById('time-off-end-time').value = data.endTime || '';
                document.getElementById('time-off-reason').value = data.reason || '';
                document.getElementById('clear-time-off-btn').style.display = 'inline-block';
            }
        }

        function saveTimeOff() {
            const startDate = document.getElementById('time-off-start-date').value;
            const startTime = document.getElementById('time-off-start-time').value;
            const endDate = document.getElementById('time-off-end-date').value;
            const endTime = document.getElementById('time-off-end-time').value;
            const reason = document.getElementById('time-off-reason').value.trim();

            // Validation
            if (!startDate || !startTime || !endDate || !endTime) {
                alert(isZh ? '请填写所有时间字段' : 'Please fill in all time fields');
                return;
            }

            // Check end is after start
            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);

            if (end <= start) {
                alert(isZh ? '结束时间必须晚于开始时间' : 'End time must be after start time');
                return;
            }

            // Save time off data
            const timeOffData = {
                startDate,
                startTime,
                endDate,
                endTime,
                reason: reason || 'Time Off',
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('timeOff', JSON.stringify(timeOffData));

            // Create blocked times for the entire period
            createTimeOffBlocks(timeOffData);

            // Show success message
            const messageDiv = document.getElementById('time-off-message');
            messageDiv.textContent = isZh ? '休假时间已保存' : 'Time off has been saved';
            messageDiv.style.background = '#e8f5e9';
            messageDiv.style.color = '#4CAF50';
            messageDiv.style.display = 'block';

            document.getElementById('clear-time-off-btn').style.display = 'inline-block';

            // Trigger storage event for customer app
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'timeOff',
                newValue: JSON.stringify(timeOffData),
                url: window.location.href
            }));

            // Refresh calendar
            loadAppointments();
            generateWeeklyCalendar();

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        function createTimeOffBlocks(timeOffData) {
            // Clear existing time off blocks
            clearExistingTimeOffBlocks();

            const startDate = new Date(timeOffData.startDate + 'T00:00:00');
            const endDate = new Date(timeOffData.endDate + 'T23:59:59');
            const currentDate = new Date(startDate);

            const blocks = [];
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];

                // Determine start and end times for this day
                let dayStartTime = '00:00';
                let dayEndTime = '23:59';

                // If it's the first day, use the specified start time
                if (currentDate.toDateString() === startDate.toDateString()) {
                    dayStartTime = timeOffData.startTime;
                }

                // If it's the last day, use the specified end time
                if (currentDate.toDateString() === endDate.toDateString()) {
                    dayEndTime = timeOffData.endTime;
                }

                // Create a blocked time for this day
                blocks.push({
                    date: dateStr,
                    startTime: dayStartTime,
                    endTime: dayEndTime,
                    reason: timeOffData.reason,
                    isTimeOff: true
                });

                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Save all blocks
            blocks.forEach(block => {
                SharedData.saveBlockedTime(block);
            });
        }

        function clearExistingTimeOffBlocks() {
            const blockedTimes = SharedData.getBlockedTimes();
            const nonTimeOffBlocks = blockedTimes.filter(block => !block.isTimeOff);
            localStorage.setItem('blockedTimes', JSON.stringify(nonTimeOffBlocks));
        }

        function clearTimeOff() {
            if (confirm(isZh ? '确定要清除休假时间吗？' : 'Are you sure you want to clear time off?')) {
                localStorage.removeItem('timeOff');
                clearExistingTimeOffBlocks();

                // Clear form
                document.getElementById('time-off-start-date').value = '';
                document.getElementById('time-off-start-time').value = '';
                document.getElementById('time-off-end-date').value = '';
                document.getElementById('time-off-end-time').value = '';
                document.getElementById('time-off-reason').value = '';
                document.getElementById('time-off-enabled').checked = false;
                document.getElementById('time-off-fields').style.display = 'none';
                document.getElementById('clear-time-off-btn').style.display = 'none';

                // Show message
                const messageDiv = document.getElementById('time-off-message');
                messageDiv.textContent = isZh ? '休假时间已清除' : 'Time off has been cleared';
                messageDiv.style.background = '#fff3cd';
                messageDiv.style.color = '#856404';
                messageDiv.style.display = 'block';

                // Trigger storage event
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'timeOff',
                    newValue: null,
                    url: window.location.href
                }));

                // Refresh calendar
                loadAppointments();
                generateWeeklyCalendar();

                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Booking Link Management Functions
        function openBookingLink() {
            document.getElementById('booking-link-modal').style.display = 'flex';

            // Load existing URL if saved
            const savedUrl = localStorage.getItem('bookingUrl');
            if (savedUrl) {
                const urlData = JSON.parse(savedUrl);
                document.getElementById('custom-url-slug').value = urlData.slug;
                document.getElementById('full-url').value = `mycompany.com/${urlData.slug}`;
                document.getElementById('url-display').style.display = 'block';
                document.getElementById('qr-code-section').style.display = 'block';
                document.getElementById('save-url-btn').disabled = false;
                document.getElementById('url-success').textContent = isZh ? '网址已保存' : 'URL saved';
                document.getElementById('url-success').style.display = 'block';
            }
        }

        function closeBookingLinkModal() {
            document.getElementById('booking-link-modal').style.display = 'none';
        }

        function validateUrlSlug() {
            const slug = document.getElementById('custom-url-slug').value;
            const errorDiv = document.getElementById('url-error');
            const successDiv = document.getElementById('url-success');
            const saveBtn = document.getElementById('save-url-btn');

            // Reset messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (!slug) {
                saveBtn.disabled = true;
                return;
            }

            // Validate format (lowercase letters, numbers, hyphens only)
            const validFormat = /^[a-z0-9-]+$/.test(slug);

            if (!validFormat) {
                errorDiv.textContent = isZh ? '只能使用小写字母、数字和连字符' : 'Only lowercase letters, numbers, and hyphens allowed';
                errorDiv.style.display = 'block';
                saveBtn.disabled = true;
                return;
            }

            if (slug.length < 3) {
                errorDiv.textContent = isZh ? '至少需要3个字符' : 'Minimum 3 characters required';
                errorDiv.style.display = 'block';
                saveBtn.disabled = true;
                return;
            }

            // Enable check availability button if valid
            document.getElementById('check-availability-btn').disabled = false;
        }

        function checkUrlAvailability() {
            const slug = document.getElementById('custom-url-slug').value;
            const errorDiv = document.getElementById('url-error');
            const successDiv = document.getElementById('url-success');
            const saveBtn = document.getElementById('save-url-btn');

            // Simulate checking availability (in production, this would be an API call)
            // For demo, check against a mock list of taken URLs
            const takenUrls = JSON.parse(localStorage.getItem('takenUrls') || '["example", "test", "demo"]');

            if (takenUrls.includes(slug)) {
                errorDiv.textContent = isZh ? '此网址已被使用' : 'This URL is already taken';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                saveBtn.disabled = true;
            } else {
                successDiv.textContent = isZh ? '网址可用！' : 'URL is available!';
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                saveBtn.disabled = false;

                // Show the full URL preview
                const fullUrl = `mycompany.com/${slug}`;
                document.getElementById('full-url').value = fullUrl;
                document.getElementById('url-display').style.display = 'block';
                document.getElementById('qr-code-section').style.display = 'block';
            }
        }

        function saveBookingUrl() {
            const slug = document.getElementById('custom-url-slug').value;

            // Save to localStorage
            const urlData = {
                slug: slug,
                createdAt: new Date().toISOString()
            };
            localStorage.setItem('bookingUrl', JSON.stringify(urlData));

            // Add to taken URLs list
            const takenUrls = JSON.parse(localStorage.getItem('takenUrls') || '[]');
            if (!takenUrls.includes(slug)) {
                takenUrls.push(slug);
                localStorage.setItem('takenUrls', JSON.stringify(takenUrls));
            }

            // Show success message
            const successDiv = document.getElementById('url-success');
            successDiv.textContent = isZh ? '网址已保存成功！' : 'URL saved successfully!';
            successDiv.style.display = 'block';

            setTimeout(() => {
                closeBookingLinkModal();
            }, 1500);
        }

        function copyToClipboard() {
            const urlInput = document.getElementById('full-url');
            urlInput.select();
            document.execCommand('copy');

            // Show feedback
            const feedback = document.getElementById('copy-feedback');
            const btnText = document.getElementById('copy-btn-text');

            feedback.style.display = 'block';
            btnText.textContent = isZh ? '已复制' : 'Copied';

            setTimeout(() => {
                feedback.style.display = 'none';
                btnText.textContent = isZh ? '复制' : 'Copy';
            }, 2000);
        }

        // Cancellation Policy Functions
        function openCancellationPolicy() {
            document.getElementById('cancellation-policy-modal').style.display = 'flex';

            // Load existing policy
            const policy = JSON.parse(localStorage.getItem('cancellationPolicy') || '{}');
            const hoursInput = document.getElementById('min-notice-hours');

            if (policy.minNoticeHours !== undefined) {
                hoursInput.value = policy.minNoticeHours;
                updatePolicyPreview();
            }

            // Add event listener for live preview
            hoursInput.addEventListener('input', updatePolicyPreview);
        }

        function closeCancellationPolicy() {
            document.getElementById('cancellation-policy-modal').style.display = 'none';
        }

        function updatePolicyPreview() {
            const hours = parseInt(document.getElementById('min-notice-hours').value) || 0;
            const previewDiv = document.getElementById('policy-preview');
            const previewText = document.getElementById('policy-preview-text');

            if (hours > 0) {
                previewDiv.style.display = 'block';
                let text;
                if (hours === 1) {
                    text = isZh ? '客户必须在预约前至少1小时取消或更改' : 'Customers must cancel or reschedule at least 1 hour before their appointment';
                } else if (hours < 24) {
                    text = isZh ? `客户必须在预约前至少${hours}小时取消或更改` : `Customers must cancel or reschedule at least ${hours} hours before their appointment`;
                } else if (hours === 24) {
                    text = isZh ? '客户必须在预约前至少1天取消或更改' : 'Customers must cancel or reschedule at least 1 day before their appointment';
                } else {
                    const days = Math.floor(hours / 24);
                    const remainingHours = hours % 24;
                    if (remainingHours === 0) {
                        text = isZh ? `客户必须在预约前至少${days}天取消或更改` : `Customers must cancel or reschedule at least ${days} days before their appointment`;
                    } else {
                        text = isZh ? `客户必须在预约前至少${days}天${remainingHours}小时取消或更改` : `Customers must cancel or reschedule at least ${days} days and ${remainingHours} hours before their appointment`;
                    }
                }
                previewText.textContent = text;
            } else {
                previewDiv.style.display = 'block';
                previewText.textContent = isZh ? '客户可以随时取消或更改预约' : 'Customers can cancel or reschedule appointments at any time';
            }
        }

        function saveCancellationPolicy() {
            const hours = parseInt(document.getElementById('min-notice-hours').value) || 0;

            // Save policy
            const policy = {
                minNoticeHours: hours,
                updatedAt: new Date().toISOString()
            };
            localStorage.setItem('cancellationPolicy', JSON.stringify(policy));

            // Show success message
            const messageDiv = document.getElementById('policy-message');
            messageDiv.textContent = isZh ? '取消政策已保存！' : 'Cancellation policy saved!';
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#4CAF50';
            messageDiv.style.color = 'white';

            setTimeout(() => {
                closeCancellationPolicy();
            }, 1500);
        }

        // Email Configuration Functions
        function openEmailConfig() {
            document.getElementById('email-config-modal').style.display = 'flex';

            // Load existing configuration
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            document.getElementById('email-business-name').value = emailConfig.businessName || '';
            document.getElementById('emailjs-service-id').value = emailConfig.serviceId || '';
            document.getElementById('emailjs-template-id').value = emailConfig.templateId || '';
            document.getElementById('emailjs-public-key').value = emailConfig.publicKey || '';
        }

        function closeEmailConfig() {
            document.getElementById('email-config-modal').style.display = 'none';
        }

        function saveEmailConfig() {
            const businessName = document.getElementById('email-business-name').value.trim();
            const serviceId = document.getElementById('emailjs-service-id').value.trim();
            const templateId = document.getElementById('emailjs-template-id').value.trim();
            const publicKey = document.getElementById('emailjs-public-key').value.trim();

            // Save configuration
            const emailConfig = {
                businessName: businessName,
                serviceId: serviceId,
                templateId: templateId,
                publicKey: publicKey,
                configuredAt: new Date().toISOString()
            };

            localStorage.setItem('emailConfig', JSON.stringify(emailConfig));

            // Update EmailJS initialization in customer app
            if (publicKey) {
                // Store for customer app to use
                localStorage.setItem('emailjsPublicKey', publicKey);
            }

            alert(isZh ? '邮件配置已保存！' : 'Email configuration saved!');
            closeEmailConfig();
        }

        function testEmailConfig() {
            const testEmail = prompt(isZh ? '输入测试邮箱地址:' : 'Enter test email address:');
            if (!testEmail) return;

            const serviceId = document.getElementById('emailjs-service-id').value.trim();
            const templateId = document.getElementById('emailjs-template-id').value.trim();
            const publicKey = document.getElementById('emailjs-public-key').value.trim();
            const businessName = document.getElementById('email-business-name').value.trim() || 'Your Hair Salon';

            if (!serviceId || !templateId || !publicKey) {
                alert(isZh ? '请先填写所有EmailJS配置' : 'Please fill in all EmailJS configuration first');
                return;
            }

            // Create test appointment data
            const testAppointment = {
                id: 'TEST123',
                customerName: 'Test Customer',
                customerEmail: testEmail,
                customerPhone: '(555) 123-4567',
                services: ['test-service'],
                serviceNames: ['Test Service'],
                date: '2025-09-25',
                time: '14:00',
                totalDuration: 30,
                totalPrice: 50
            };

            // Test send
            const resultSpan = document.getElementById('test-result');
            resultSpan.textContent = isZh ? '发送中...' : 'Sending...';
            resultSpan.style.color = '#2196F3';

            // Try to send test email
            SharedData.sendConfirmationEmail(testAppointment);

            setTimeout(() => {
                resultSpan.textContent = isZh ? '测试邮件已发送！请检查收件箱。' : 'Test email sent! Check your inbox.';
                resultSpan.style.color = '#4CAF50';
            }, 2000);
        }

        function validateActivePeriods(periods, duration) {
            // Sort periods by start time
            const sortedPeriods = periods.sort((a, b) => a.start - b.start);

            for (let i = 0; i < sortedPeriods.length; i++) {
                const period = sortedPeriods[i];

                // Check if end time is after start time
                if (period.end <= period.start) {
                    return { valid: false, error: `Period ${i + 1}: End time must be after start time` };
                }

                // Check if period is within service duration
                if (period.end > duration) {
                    return { valid: false, error: `Period ${i + 1}: End time cannot exceed service duration (${duration} min)` };
                }

                // Check for overlaps with next period
                if (i < sortedPeriods.length - 1) {
                    const nextPeriod = sortedPeriods[i + 1];
                    if (period.end > nextPeriod.start) {
                        return { valid: false, error: `Period ${i + 1} overlaps with Period ${i + 2}` };
                    }
                }
            }

            return { valid: true, periods: sortedPeriods };
        }

        function saveServices() {
            // Get services for current barber
            const barber = SharedData.getBarberById(window.currentBarberId || 'owner');
            const services = barber ? barber.services : SharedData.getServices();
            let hasErrors = false;

            // Get all service items
            document.querySelectorAll('.service-item[data-service]').forEach(item => {
                const serviceId = item.dataset.service;
                if (!services[serviceId]) return;

                // Get service name
                const nameInput = item.querySelector('.service-name-input');
                if (nameInput && nameInput.value.trim()) {
                    services[serviceId].name = nameInput.value.trim();
                }

                // Get enabled state
                const toggleSwitch = item.querySelector('.toggle-switch');
                services[serviceId].enabled = toggleSwitch.classList.contains('active');

                // Get duration
                const durationInput = item.querySelector('.service-duration');
                if (durationInput) {
                    const duration = parseInt(durationInput.value) || services[serviceId].duration;
                    if (duration > 0 && duration <= 480) {
                        services[serviceId].duration = duration;
                    } else {
                        durationInput.value = services[serviceId].duration;
                    }
                }

                // Get price
                const priceInput = item.querySelector('.service-price');
                if (priceInput) {
                    const price = parseFloat(priceInput.value) || services[serviceId].price;
                    if (price >= 0) {
                        services[serviceId].price = Math.round(price * 100) / 100; // Round to 2 decimals
                    } else {
                        priceInput.value = services[serviceId].price;
                    }
                }

                // Get active time toggle state and periods
                const activeToggle = item.querySelector('.active-time-toggle');
                if (activeToggle) {
                    services[serviceId].hasActiveTime = activeToggle.checked;

                    // Only save active periods if the toggle is checked
                    if (activeToggle.checked) {
                        const periodsList = item.querySelector('.active-periods-list');
                        if (periodsList) {
                            const periods = [];
                            const periodItems = periodsList.querySelectorAll('.active-period-item');

                            periodItems.forEach(periodItem => {
                                const startInput = periodItem.querySelector('.period-start');
                                const endInput = periodItem.querySelector('.period-end');

                                if (startInput && endInput) {
                                    const start = parseInt(startInput.value) || 0;
                                    const end = parseInt(endInput.value) || 0;
                                    periods.push({ start, end });
                                }
                            });

                            if (periods.length > 0) {
                                const validation = validateActivePeriods(periods, services[serviceId].duration);
                                if (validation.valid) {
                                    services[serviceId].activePeriods = validation.periods;
                                } else {
                                    hasErrors = true;
                                    alert(`${services[serviceId].name}: ${validation.error}`);
                                    return;
                                }
                            }
                            // Remove old single activeTime if it exists
                            delete services[serviceId].activeTime;
                        }
                    } else {
                        // Clear active time data if toggle is unchecked
                        delete services[serviceId].activeTime;
                        delete services[serviceId].activePeriods;
                    }
                }
            });

            if (!hasErrors) {
                SharedData.saveServices(services);
                // Show save feedback
                showServiceSaveMessage();
            }
        }

        function showServiceSaveMessage() {
            // Create or get message div
            let messageDiv = document.getElementById('service-save-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'service-save-message';
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 1000;
                    display: none;
                `;
                document.body.appendChild(messageDiv);
            }

            // Save services for current barber
            if (window.currentBarberId && window.currentBarberId !== 'owner') {
                SharedData.updateBarber(window.currentBarberId, { services });
            } else {
                SharedData.saveServices(services);
            }
            messageDiv.textContent = isZh ? '服务已保存' : 'Services saved';
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 2000);
        }

        function loadServices() {
            // Get services for current barber
            const barber = SharedData.getBarberById(window.currentBarberId || 'owner');
            const services = barber ? (barber.services || SharedData.getServices()) : SharedData.getServices();

            // Load service data for each item
            document.querySelectorAll('.service-item[data-service]').forEach(item => {
                const serviceId = item.dataset.service;
                if (!services[serviceId]) return;

                const service = services[serviceId];

                // Update color indicator
                const colorIndicator = item.querySelector('.service-color-indicator');
                if (colorIndicator) {
                    const color = SharedData.getServiceColor(serviceId);
                    colorIndicator.style.background = color;
                }

                // Set service name
                const nameInput = item.querySelector('.service-name-input');
                if (nameInput) {
                    nameInput.value = service.name || '';
                }

                // Set enabled state
                const toggleSwitch = item.querySelector('.toggle-switch');
                if (service.enabled) {
                    toggleSwitch.classList.add('active');
                } else {
                    toggleSwitch.classList.remove('active');
                }

                // Set duration
                const durationInput = item.querySelector('.service-duration');
                if (durationInput) {
                    durationInput.value = service.duration;
                }

                // Set price
                const priceInput = item.querySelector('.service-price');
                if (priceInput) {
                    priceInput.value = service.price;
                }

                // Set active time toggle and periods
                const activeToggle = item.querySelector('.active-time-toggle');
                const activeContainer = item.querySelector('.active-time-container');
                const periodsList = item.querySelector('.active-periods-list');

                if (activeToggle && activeContainer) {
                    // Set checkbox state based on hasActiveTime or presence of periods
                    const hasActive = service.hasActiveTime || (service.activePeriods && service.activePeriods.length > 0);
                    activeToggle.checked = hasActive;

                    if (hasActive) {
                        activeContainer.style.display = 'block';

                        // Load periods
                        if (periodsList && service.activePeriods) {
                            periodsList.innerHTML = '';
                            service.activePeriods.forEach((period, index) => {
                                const periodDiv = document.createElement('div');
                                periodDiv.className = 'active-period-item';
                                periodDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 5px;';
                                const periodLabel = isZh ? `时段 ${index + 1}:` : `Period ${index + 1}:`;
                                const toLabel = isZh ? '到' : 'to';
                                const minLabel = isZh ? '分钟' : 'min';
                                periodDiv.innerHTML = `
                                    <span class="period-label" style="font-size: 12px; color: #4A90E2; min-width: 50px;">${periodLabel}</span>
                                    <input type="number" class="period-start" value="${period.start}" min="0" max="${service.duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                    <span class="to-label" style="font-size: 12px; color: #4A90E2;">${toLabel}</span>
                                    <input type="number" class="period-end" value="${period.end}" min="0" max="${service.duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                                    <span class="min-label" style="font-size: 12px; color: #4A90E2;">${minLabel}</span>
                                    ${service.activePeriods.length > 1 ? `<button onclick="removePeriodFromService(this, '${serviceId}')" style="padding: 2px 6px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">×</button>` : ''}
                                `;
                                periodsList.appendChild(periodDiv);
                            });
                        }
                    } else {
                        activeContainer.style.display = 'none';
                    }
                }
            });
        }

        function showMessage(message, type) {
            // Try both message divs
            const messageDiv = document.getElementById('hours-message') || document.getElementById('settings-message');
            if (messageDiv) {
                messageDiv.textContent = message;
                messageDiv.style.display = 'block';
                messageDiv.style.background = type === 'success' ? '#4CAF50' : '#f44336';
                messageDiv.style.color = 'white';

                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        function switchServicesPage(pageIndex) {
            const pages = document.getElementById('services-pages');
            const dots = document.querySelectorAll('#services-section .dot');

            pages.style.transform = `translateX(-${pageIndex * 50}%)`;

            dots.forEach((dot, i) => {
                if (i === pageIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Settings page functions
        function openProfile() {
            // Load existing profile data
            const profile = JSON.parse(localStorage.getItem('ownerProfile') || '{}');
            
            // Populate form fields
            document.getElementById('owner-first-name').value = profile.firstName || '';
            document.getElementById('owner-last-name').value = profile.lastName || '';
            document.getElementById('owner-phone').value = profile.phone || '';
            document.getElementById('owner-email').value = profile.email || '';
            document.getElementById('owner-wechat').value = profile.wechatId || '';
            document.getElementById('store-name').value = profile.storeName || 'Premium Cuts Barbershop';
            document.getElementById('store-address').value = profile.storeAddress || '';

            // Load store hours (new per-day format)
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const storeHours = profile.storeHours || {};

            days.forEach(day => {
                const dayHours = storeHours[day] || { open: '09:00', close: '18:00', closed: false };
                const openInput = document.getElementById(`store-${day}-open`);
                const closeInput = document.getElementById(`store-${day}-close`);
                const closedCheckbox = document.getElementById(`store-${day}-closed`);

                if (dayHours.closed) {
                    closedCheckbox.checked = true;
                    openInput.disabled = true;
                    closeInput.disabled = true;
                    openInput.value = '';
                    closeInput.value = '';
                } else {
                    closedCheckbox.checked = false;
                    openInput.disabled = false;
                    closeInput.disabled = false;
                    openInput.value = dayHours.open || '09:00';
                    closeInput.value = dayHours.close || '18:00';
                }
            });

            // Show modal
            document.getElementById('profile-modal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
            document.getElementById('profile-success').style.display = 'none';
        }

        // Phone formatting for owner profile
        function formatOwnerPhone(value) {
            // Remove all non-digits
            const cleaned = value.replace(/\D/g, '');
            
            // Format as (XXX) XXX-XXXX
            if (cleaned.length <= 3) {
                return cleaned;
            } else if (cleaned.length <= 6) {
                return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
            } else {
                return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
            }
        }

        // Email validation for owner profile
        function validateOwnerEmail() {
            const emailInput = document.getElementById('owner-email');
            const errorDiv = document.getElementById('owner-email-error');
            
            if (emailInput.value && !isValidEmail(emailInput.value)) {
                errorDiv.textContent = isZh ? '请输入有效的电子邮件地址' : 'Please enter a valid email address';
                errorDiv.style.display = 'block';
                return false;
            } else {
                errorDiv.style.display = 'none';
                return true;
            }
        }

        function isValidEmail(email) {
            return email.includes('@') && email.indexOf('@') > 0 && email.indexOf('@') < email.length - 1;
        }

        function isValidPhone(phone) {
            const cleaned = phone.replace(/\D/g, '');
            return cleaned.length === 10;
        }

        function saveOwnerProfile() {
            const firstName = document.getElementById('owner-first-name').value.trim();
            const lastName = document.getElementById('owner-last-name').value.trim();
            const phone = document.getElementById('owner-phone').value.trim();
            const email = document.getElementById('owner-email').value.trim();
            const wechatId = document.getElementById('owner-wechat').value.trim();
            const storeName = document.getElementById('store-name').value.trim();
            const storeAddress = document.getElementById('store-address').value.trim();

            // Validation
            if (!firstName) {
                alert(isZh ? '请输入名字' : 'Please enter first name');
                return;
            }
            if (!lastName) {
                alert(isZh ? '请输入姓氏' : 'Please enter last name');
                return;
            }
            if (!storeName) {
                alert(isZh ? '请输入店铺名称' : 'Please enter store name');
                return;
            }
            if (!storeAddress) {
                alert(isZh ? '请输入店铺地址' : 'Please enter store address');
                return;
            }
            
            // Validate phone if provided
            if (phone && !isValidPhone(phone)) {
                document.getElementById('owner-phone-error').textContent = 
                    isZh ? '请输入有效的10位电话号码' : 'Please enter a valid 10-digit phone number';
                document.getElementById('owner-phone-error').style.display = 'block';
                return;
            }
            
            // Validate email if provided
            if (email && !isValidEmail(email)) {
                document.getElementById('owner-email-error').textContent = 
                    isZh ? '请输入有效的电子邮件地址' : 'Please enter a valid email address';
                document.getElementById('owner-email-error').style.display = 'block';
                return;
            }

            // Save profile
            // Save store hours in new per-day format
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const storeHours = {};

            days.forEach(day => {
                const openInput = document.getElementById(`store-${day}-open`);
                const closeInput = document.getElementById(`store-${day}-close`);
                const closedCheckbox = document.getElementById(`store-${day}-closed`);

                if (closedCheckbox.checked) {
                    storeHours[day] = { open: '', close: '', closed: true };
                } else {
                    storeHours[day] = {
                        open: openInput.value || '09:00',
                        close: closeInput.value || '18:00',
                        closed: false
                    };
                }
            });

            const profile = {
                firstName,
                lastName,
                phone,
                email,
                wechatId,
                storeName,
                storeAddress,
                storeHours,
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('ownerProfile', JSON.stringify(profile));

            // If there's only the owner (no other staff), sync their hours with store hours
            const barbers = SharedData.getBarbers();
            if (barbers.length === 1 && barbers[0].id === 'owner') {
                // Store hours are already in the correct format
                SharedData.updateBarber('owner', { hours: storeHours });
                SharedData.saveStoreHours(storeHours);
            }

            // Show success message
            document.getElementById('profile-success').style.display = 'block';

            // Hide success message after 2 seconds and close modal
            setTimeout(() => {
                closeProfileModal();
            }, 2000);
        }

        function openEmailSettings() {
            // Load owner's email preferences
            const emailPrefs = JSON.parse(localStorage.getItem('emailPreferences') || '{}');
            const adminConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');

            // Set main toggle state
            const isEnabled = emailPrefs.enabled !== false; // Default to true
            document.getElementById('email-notifications-enabled').checked = isEnabled;

            // Set sub-option states (default all to true if not set)
            document.getElementById('email-confirmations').checked = emailPrefs.confirmations !== false;
            document.getElementById('email-reschedules').checked = emailPrefs.reschedules !== false;
            document.getElementById('email-cancellations').checked = emailPrefs.cancellations !== false;

            // Show/hide sub-options based on main toggle
            toggleEmailNotifications();

            // Check admin configuration status
            const statusDiv = document.getElementById('email-config-status');
            if (adminConfig.serviceId && adminConfig.publicKey && adminConfig.templateId) {
                statusDiv.innerHTML = `
                    <div style="background: #E8F5E9; color: #2E7D32; padding: 10px; border-radius: 6px;">
                        ✅ <span id="email-status-ready">${isZh ? '邮件服务已配置并就绪' : 'Email service is configured and ready'}</span>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="background: #FFF3E0; color: #E65100; padding: 10px; border-radius: 6px;">
                        ⚠️ <span id="email-status-not-configured">${isZh ? '邮件服务未配置。请联系管理员设置EmailJS。' : 'Email service not configured. Contact your administrator to set up EmailJS.'}</span>
                    </div>
                `;
            }

            // Show modal
            document.getElementById('email-settings-modal').style.display = 'flex';
        }

        function toggleEmailNotifications() {
            const isEnabled = document.getElementById('email-notifications-enabled').checked;
            const subOptions = document.getElementById('email-sub-options');
            subOptions.style.display = isEnabled ? 'block' : 'none';
        }

        function closeEmailSettings() {
            document.getElementById('email-settings-modal').style.display = 'none';
            document.getElementById('email-settings-success').style.display = 'none';
        }

        function saveEmailSettings() {
            // Save owner's preferences
            const emailPrefs = {
                enabled: document.getElementById('email-notifications-enabled').checked,
                confirmations: document.getElementById('email-confirmations').checked,
                reschedules: document.getElementById('email-reschedules').checked,
                cancellations: document.getElementById('email-cancellations').checked,
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('emailPreferences', JSON.stringify(emailPrefs));

            // Show success message
            document.getElementById('email-settings-success').style.display = 'block';

            // Hide success message after 2 seconds and close modal
            setTimeout(() => {
                closeEmailSettings();
            }, 2000);
        }

        function openNotifications() {
            alert(isZh ? '通知设置页面' : 'Notifications settings');
        }

        function openPayments() {
            alert(isZh ? '支付方式页面' : 'Payment methods page');
        }

        function openPolicies() {
            alert(isZh ? '政策设置页面' : 'Policies settings');
        }

        function openHelp() {
            alert(isZh ? '帮助与支持页面' : 'Help & Support page');
        }

        function openAbout() {
            alert(isZh ? '关于页面' : 'About page');
        }

        // Add Service Modal Functions
        function openAddServiceModal() {
            document.getElementById('add-service-modal').classList.add('active');
        }

        function closeAddServiceModal() {
            document.getElementById('add-service-modal').classList.remove('active');
            // Reset form
            document.getElementById('new-service-name').value = '';
            document.getElementById('new-service-duration').value = '30';
            document.getElementById('new-service-price').value = '25';
            document.getElementById('new-service-enabled').checked = true;
            document.getElementById('new-service-has-active').checked = false;
            document.getElementById('new-service-active-periods').style.display = 'none';
            // Reset active periods to single default period
            document.getElementById('active-periods-list').innerHTML = `
                <div class="active-period-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 13px; color: #666;">From</span>
                    <input type="number" class="period-start" value="0" min="0" style="width: 60px; padding: 5px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 13px;">
                    <span style="font-size: 13px; color: #666;">to</span>
                    <input type="number" class="period-end" value="15" min="0" style="width: 60px; padding: 5px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 13px;">
                    <span style="font-size: 13px; color: #666;">min</span>
                    <button onclick="removeActivePeriod(this)" style="padding: 3px 8px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
            `;
        }

        function toggleNewServiceActiveTime() {
            const checkbox = document.getElementById('new-service-has-active');
            const periodsDiv = document.getElementById('new-service-active-periods');
            periodsDiv.style.display = checkbox.checked ? 'block' : 'none';
        }

        function addActivePeriod() {
            const periodsList = document.getElementById('active-periods-list');
            const durationInput = document.getElementById('new-service-duration');
            const duration = durationInput ? parseInt(durationInput.value) || 30 : 30;

            // Get existing periods to calculate smart defaults
            const existingPeriods = [];
            const periodItems = periodsList.querySelectorAll('.active-period-item');
            periodItems.forEach(item => {
                const start = parseInt(item.querySelector('.period-start').value) || 0;
                const end = parseInt(item.querySelector('.period-end').value) || 0;
                existingPeriods.push({ start, end });
            });

            // Calculate smart defaults for new period
            let defaultStart = 0;
            let defaultEnd = 15;

            if (existingPeriods.length > 0) {
                // Sort periods by end time to find the last one
                existingPeriods.sort((a, b) => b.end - a.end);
                const lastPeriod = existingPeriods[0];

                // Start 5 minutes after the last period ends
                defaultStart = lastPeriod.end + 5;

                // End 15 minutes after start (or at duration limit)
                defaultEnd = Math.min(defaultStart + 15, duration);

                // If we can't fit a valid period, don't add one
                if (defaultStart >= duration) {
                    alert('No room for additional active periods within service duration');
                    return;
                }
            }

            const newPeriod = document.createElement('div');
            newPeriod.className = 'active-period-item';
            newPeriod.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 10px;';
            newPeriod.innerHTML = `
                <span style="font-size: 13px; color: #666;">From</span>
                <input type="number" class="period-start" value="${defaultStart}" min="0" style="width: 60px; padding: 5px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 13px;" onchange="validatePeriodsOnChange()">
                <span style="font-size: 13px; color: #666;">to</span>
                <input type="number" class="period-end" value="${defaultEnd}" min="0" style="width: 60px; padding: 5px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 13px;" onchange="validatePeriodsOnChange()">
                <span style="font-size: 13px; color: #666;">min</span>
                <button onclick="removeActivePeriod(this)" style="padding: 3px 8px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Remove</button>
            `;
            periodsList.appendChild(newPeriod);

            // Validate after adding
            validatePeriodsOnChange();

            // Update button state
            updateAddPeriodButtonState();
        }

        function validatePeriodsOnChange() {
            // Get the duration value for the new service modal
            const durationInput = document.getElementById('new-service-duration');
            if (!durationInput) return;

            const duration = parseInt(durationInput.value) || 30;
            const periods = [];
            const periodItems = document.querySelectorAll('#active-periods-list .active-period-item');

            periodItems.forEach(item => {
                const start = parseInt(item.querySelector('.period-start').value) || 0;
                const end = parseInt(item.querySelector('.period-end').value) || 0;
                periods.push({ start, end });
            });

            if (periods.length > 0) {
                const validation = validateActivePeriods(periods, duration);
                if (!validation.valid) {
                    // Show a non-blocking warning instead of alert
                    showValidationWarning(validation.error);
                } else {
                    clearValidationWarning();
                }
            }

            // Update button state whenever validation runs
            updateAddPeriodButtonState();
        }

        function showValidationWarning(message) {
            let warningDiv = document.getElementById('period-validation-warning');
            if (!warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'period-validation-warning';
                warningDiv.style.cssText = 'color: #f44336; font-size: 12px; margin-top: 5px;';
                const periodsList = document.getElementById('active-periods-list');
                if (periodsList && periodsList.parentElement) {
                    periodsList.parentElement.appendChild(warningDiv);
                }
            }
            warningDiv.textContent = message;
            warningDiv.style.display = 'block';
        }

        function clearValidationWarning() {
            const warningDiv = document.getElementById('period-validation-warning');
            if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        }

        function removeActivePeriod(button) {
            const periodsList = document.getElementById('active-periods-list');
            if (periodsList.children.length > 1) {
                button.parentElement.remove();
                validatePeriodsOnChange();
                updateAddPeriodButtonState();
            } else {
                alert(isZh ? '至少需要一个活动时间段' : 'At least one active period is required');
            }
        }

        function updateAddPeriodButtonState() {
            const addButton = document.querySelector('button[onclick="addActivePeriod()"]');
            if (!addButton) return;

            const durationInput = document.getElementById('new-service-duration');
            if (!durationInput) return;

            const duration = parseInt(durationInput.value) || 30;
            const periodsList = document.getElementById('active-periods-list');
            const periodItems = periodsList.querySelectorAll('.active-period-item');

            // Get all existing periods
            const periods = [];
            periodItems.forEach(item => {
                const end = parseInt(item.querySelector('.period-end').value) || 0;
                periods.push(end);
            });

            // Find the maximum end time
            const maxEnd = periods.length > 0 ? Math.max(...periods) : 0;

            // Disable if there's not enough room for a new period (need at least 10 minutes)
            if (maxEnd + 10 > duration) {
                addButton.disabled = true;
                addButton.style.opacity = '0.5';
                addButton.title = 'No room for additional periods';
            } else {
                addButton.disabled = false;
                addButton.style.opacity = '1';
                addButton.title = '';
            }
        }

        function saveNewService() {
            const name = document.getElementById('new-service-name').value.trim();
            const duration = parseInt(document.getElementById('new-service-duration').value);
            const price = parseFloat(document.getElementById('new-service-price').value);
            const enabled = document.getElementById('new-service-enabled').checked;
            const hasActive = document.getElementById('new-service-has-active').checked;

            // Validation
            if (!name) {
                alert(isZh ? '请输入服务名称' : 'Please enter a service name');
                return;
            }
            if (!duration || duration < 5 || duration > 480) {
                alert(isZh ? '持续时间必须在5-480分钟之间' : 'Duration must be between 5-480 minutes');
                return;
            }
            if (price < 0) {
                alert(isZh ? '价格必须是正数' : 'Price must be a positive number');
                return;
            }

            // Get active periods if applicable
            let activePeriods = null;
            if (hasActive) {
                const periods = [];
                const periodItems = document.querySelectorAll('#active-periods-list .active-period-item');
                for (let item of periodItems) {
                    const start = parseInt(item.querySelector('.period-start').value) || 0;
                    const end = parseInt(item.querySelector('.period-end').value) || 0;
                    periods.push({ start, end });
                }

                // Validate periods
                const validation = validateActivePeriods(periods, duration);
                if (!validation.valid) {
                    alert(validation.error);
                    return;
                }
                activePeriods = validation.periods;
            }

            // Generate unique ID for the new service
            const services = SharedData.getServices();
            let serviceId = 'custom-1';
            let counter = 1;
            while (services[serviceId]) {
                counter++;
                serviceId = `custom-${counter}`;
            }

            // Create service object
            const newService = {
                name: name,
                duration: duration,
                price: Math.round(price * 100) / 100,
                enabled: enabled,
                hasActiveTime: hasActive
            };

            if (activePeriods) {
                newService.activePeriods = activePeriods;
            }

            // Save to services
            services[serviceId] = newService;
            SharedData.saveServices(services);

            // Add to UI
            addServiceToUI(serviceId, newService);

            // Close modal
            closeAddServiceModal();

            // Show success message
            showServiceSaveMessage();
        }

        function addServiceToUI(serviceId, service) {
            const serviceList = document.querySelector('.service-list');
            const newServiceDiv = document.createElement('div');
            newServiceDiv.className = 'service-item';
            newServiceDiv.dataset.service = serviceId;

            const hasActive = service.hasActiveTime && service.activePeriods;
            const activePeriodsHtml = hasActive ? service.activePeriods.map((period, index) => `
                <div class="active-period-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                    <span style="font-size: 12px; color: #4A90E2; min-width: 50px;">Period ${index + 1}:</span>
                    <input type="number" class="period-start" value="${period.start}" min="0" max="${service.duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                    <span style="font-size: 12px; color: #4A90E2;">to</span>
                    <input type="number" class="period-end" value="${period.end}" min="0" max="${service.duration}" style="width: 45px; padding: 3px; border: 1px solid #E3F2FD; border-radius: 3px; font-size: 12px; background: #F5FBFF;" onchange="saveServices()">
                    <span style="font-size: 12px; color: #4A90E2;">min</span>
                </div>
            `).join('') : '';

            newServiceDiv.innerHTML = `
                <div style="flex: 1;">
                    <input type="text" class="service-name-input" value="${service.name}" onchange="saveServices()">
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                        <input type="number" class="service-duration" value="${service.duration}" min="5" max="480" style="width: 50px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                        <span style="font-size: 13px; color: #666;">min</span>
                        <span style="color: #666;">•</span>
                        <span style="font-size: 13px; color: #666;">$</span>
                        <input type="number" class="service-price" value="${service.price}" min="0" step="0.01" style="width: 60px; padding: 4px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="saveServices()">
                    </div>
                    <div style="margin-top: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="active-time-toggle" ${hasActive ? 'checked' : ''} onchange="toggleActiveTime('${serviceId}')" style="cursor: pointer;">
                            <label style="font-size: 12px; color: #666; cursor: pointer;">Has active time periods</label>
                        </div>
                        <div class="active-time-container" id="active-container-${serviceId}" style="${hasActive ? 'display: block;' : 'display: none;'} margin-left: 24px; margin-top: 8px;">
                            <div class="active-periods-list" id="periods-${serviceId}">
                                ${activePeriodsHtml}
                            </div>
                            <button onclick="addPeriodToService('${serviceId}')" style="margin-top: 5px; padding: 3px 8px; background: #4A90E2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">Add period</button>
                        </div>
                    </div>
                </div>
                <div class="toggle-switch ${service.enabled ? 'active' : ''}" onclick="toggleService(this)"></div>
            `;

            serviceList.appendChild(newServiceDiv);
        }

        function generateServiceLegend() {
            const legendContainer = document.getElementById('service-legend');
            if (!legendContainer) return;

            const services = SharedData.getServicesWithColors();
            legendContainer.innerHTML = '';

            // Add blocked time to legend
            const blockedItem = document.createElement('div');
            blockedItem.style.cssText = 'display: flex; align-items: center; gap: 5px;';
            blockedItem.innerHTML = `
                <div style="width: 20px; height: 20px; background: #757575; border-radius: 3px;"></div>
                <span>${isZh ? '屏蔽时间' : 'Blocked'}</span>
            `;
            legendContainer.appendChild(blockedItem);

            // Add services to legend
            Object.keys(services).forEach(serviceId => {
                const service = services[serviceId];
                if (service.enabled) {
                    const legendItem = document.createElement('div');
                    legendItem.style.cssText = 'display: flex; align-items: center; gap: 5px;';
                    legendItem.innerHTML = `
                        <div style="width: 20px; height: 20px; background: ${service.color}; border-radius: 3px;"></div>
                        <span>${translateServiceName(service.name)}</span>
                    `;
                    legendContainer.appendChild(legendItem);
                }
            });
        }

        // Day view calendar with staff columns for "All Staff" view
        function generateDayViewCalendar() {
            const weekHeader = document.getElementById('week-header');
            const timeSlotsContainer = document.getElementById('time-slots');

            weekHeader.innerHTML = '';
            timeSlotsContainer.innerHTML = '';

            // Generate service color legend first
            generateServiceLegend();

            // Update display to show current day (using currentWeekStart as the selected date)
            const currentDay = new Date(currentWeekStart);
            const dayNames = isZh ? ['周日', '周一', '周二', '周三', '周四', '周五', '周六'] :
                                    ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = isZh ?
                ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'] :
                ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('current-week').textContent =
                `${monthNames[currentDay.getMonth()]} ${currentDay.getDate()}, ${currentDay.getFullYear()} - ${dayNames[currentDay.getDay()]}`;

            // Set up grid template for header
            const numBarbers = barbers.length || 1;
            weekHeader.style.display = 'grid';
            weekHeader.style.gridTemplateColumns = `40px repeat(${numBarbers}, 1fr)`;
            weekHeader.style.gap = '0';
            weekHeader.style.marginBottom = '0';

            // Add empty corner cell
            const cornerCell = document.createElement('div');
            cornerCell.style.cssText = 'background: #f5f5f5; padding: 5px; border-right: 1px solid #ddd;';
            weekHeader.appendChild(cornerCell);

            // Add barber headers with proper alignment
            barbers.forEach((barber, index) => {
                const barberHeader = document.createElement('div');
                barberHeader.className = 'week-day';
                barberHeader.style.cssText = `
                    background: #4A90E2;
                    color: white;
                    text-align: center;
                    padding: 8px 5px;
                    font-weight: bold;
                    font-size: 12px;
                    border-right: ${index < barbers.length - 1 ? '1px solid #3a7bc8' : 'none'};
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                `;
                barberHeader.textContent = barber.name;
                weekHeader.appendChild(barberHeader);
            });

            // Create time slots grid
            const startHour = 7;
            const endHour = 21;

            // Set up time slots container with proper grid matching header
            timeSlotsContainer.style.display = 'grid';
            timeSlotsContainer.style.gridTemplateColumns = `40px repeat(${numBarbers}, 1fr)`;
            timeSlotsContainer.style.gap = '0';

            // Generate time slots
            for (let hour = startHour; hour <= endHour; hour++) {
                // Time label
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                timeLabel.textContent = `${displayHour} ${ampm}`;
                timeLabel.style.cssText = `
                    background: #f5f5f5;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    height: 50px;
                    border-right: 1px solid #ddd;
                    border-bottom: 1px solid #e0e0e0;
                `;
                timeSlotsContainer.appendChild(timeLabel);

                // Barber slots for this hour
                barbers.forEach((barber, barberIndex) => {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.dataset.hour = hour;
                    slot.dataset.barberId = barber.id;
                    slot.dataset.barberIndex = barberIndex;
                    slot.style.cssText = `
                        position: relative;
                        background: white;
                        border-right: ${barberIndex < barbers.length - 1 ? '1px solid #e0e0e0' : 'none'};
                        border-bottom: 1px solid #e0e0e0;
                        cursor: pointer;
                        height: 50px;
                        z-index: 0;
                    `;

                    // Create 4 sub-slots for 15-minute intervals
                    for (let quarter = 0; quarter < 4; quarter++) {
                        const subSlot = document.createElement('div');
                        subSlot.style.cssText = 'position: absolute; left: 0; right: 0; height: 25%; cursor: pointer;';
                        subSlot.style.top = `${quarter * 25}%`;
                        subSlot.dataset.minutes = quarter * 15;

                        subSlot.addEventListener('click', function(e) {
                            if (!e.target.closest('.appointment-block') && !e.target.closest('.appointment-period') && !e.target.closest('.appointment-clickable') && !e.target.closest('.blocked-time-block')) {
                                e.stopPropagation();
                                const startMinutes = hour * 60 + quarter * 15;
                                // Open booking modal with specific barber selected
                                openOwnerBookingModalForBarber(currentDay.getDay(), Math.floor(startMinutes / 60), startMinutes % 60, barber.id);
                            }
                        });

                        slot.appendChild(subSlot);
                    }

                    // Add drag and drop handlers for moving appointments
                    slot.ondragover = (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';

                        // Calculate which 15-minute interval is being hovered
                        const rect = slot.getBoundingClientRect();
                        const relativeY = e.clientY - rect.top;
                        const slotHeight = rect.height;
                        const quarterHeight = slotHeight / 4;

                        // Determine which quarter we're in
                        const quarter = Math.floor(relativeY / quarterHeight);
                        const boundedQuarter = Math.max(0, Math.min(3, quarter));

                        // Visual feedback - highlight the quarter
                        slot.style.background = `linear-gradient(to bottom,
                            transparent ${boundedQuarter * 25}%,
                            rgba(33, 150, 243, 0.1) ${boundedQuarter * 25}%,
                            rgba(33, 150, 243, 0.1) ${(boundedQuarter + 1) * 25}%,
                            transparent ${(boundedQuarter + 1) * 25}%)`;
                    };

                    slot.ondragleave = () => {
                        slot.style.background = '';
                    };

                    slot.ondrop = (e) => {
                        e.preventDefault();
                        slot.style.background = '';

                        // Calculate which 15-minute interval was dropped on
                        const rect = slot.getBoundingClientRect();
                        const relativeY = e.clientY - rect.top;
                        const slotHeight = rect.height;
                        const quarterHeight = slotHeight / 4;

                        // Determine which quarter (0-3) for minutes (00, 15, 30, 45)
                        let quarter = Math.floor(relativeY / quarterHeight);
                        quarter = Math.max(0, Math.min(3, quarter));
                        const minutes = quarter * 15;

                        const appointmentId = e.dataTransfer.getData('appointmentId');
                        const blockId = e.dataTransfer.getData('blockId');

                        const targetDate = new Date(currentWeekStart);
                        targetDate.setDate(currentWeekStart.getDate()); // Day view is always current day
                        const dateStr = targetDate.toISOString().split('T')[0];
                        const newTime = `${hour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

                        if (appointmentId) {
                            // Handle appointment drop
                            const appointments = SharedData.getAppointments();
                            const appointment = appointments.find(apt => apt.id === appointmentId);

                            if (appointment) {
                                // Create a temporary appointment object with new values to check conflicts
                                const tempAppointment = {
                                    ...appointment,
                                    date: dateStr,
                                    time: newTime,
                                    barberId: barber.id
                                };

                                // Check for conflicts at the new time and barber
                                // We need to check if moving this appointment to the new barber/time would cause a conflict
                                let hasConflict = false;

                                const [newHour, newMin] = newTime.split(':').map(Number);
                                const newStartMinutes = newHour * 60 + newMin;
                                const newEndMinutes = newStartMinutes + appointment.totalDuration;

                                for (const apt of appointments) {
                                    // Skip the appointment being moved
                                    if (apt.id === appointmentId) continue;

                                    // Skip if different date
                                    if (apt.date !== dateStr) continue;

                                    // Skip if different barber
                                    if (apt.barberId && barber.id && apt.barberId !== barber.id) continue;

                                    const [aptHour, aptMin] = apt.time.split(':').map(Number);
                                    const aptStartMinutes = aptHour * 60 + aptMin;

                                    // Check if appointments overlap at all
                                    const aptEndMinutes = aptStartMinutes + apt.totalDuration;
                                    if (newStartMinutes >= aptEndMinutes || newEndMinutes <= aptStartMinutes) {
                                        // No overlap at all, skip this appointment
                                        continue;
                                    }

                                    // They overlap in time, now check active periods
                                    if (apt.activePeriods && apt.activePeriods.length > 0) {
                                        // Check if the new appointment conflicts with any active period
                                        for (const period of apt.activePeriods) {
                                            const periodStart = aptStartMinutes + period.start;
                                            const periodEnd = aptStartMinutes + period.end;

                                            // Check if new appointment overlaps with this active period
                                            if (newStartMinutes < periodEnd && newEndMinutes > periodStart) {
                                                console.log('Conflict with active period:', period);
                                                hasConflict = true;
                                                break;
                                            }
                                        }
                                    } else {
                                        // No active periods means the entire appointment is active
                                        console.log('Conflict with full appointment (no active periods)');
                                        hasConflict = true;
                                    }

                                    if (hasConflict) break;
                                }

                                if (!hasConflict) {
                                    // Update appointment
                                    appointment.date = dateStr;
                                    appointment.time = newTime;
                                    appointment.barberId = barber.id; // Update to the target barber

                                    // Save and refresh
                                    localStorage.setItem('appointments', JSON.stringify(appointments));

                                    // Reload the day view appointments
                                    setTimeout(() => {
                                        loadDayAppointments();
                                        loadAppointments(); // Refresh dashboard
                                        updateDashboardMetrics();
                                    }, 100);
                                } else {
                                    alert(isZh ? '该时间段与现有预约冲突' : 'This time slot conflicts with an existing appointment');
                                }
                            }
                        }
                    };

                    timeSlotsContainer.appendChild(slot);
                });
            }

            // Load appointments for the day
            loadDayAppointments();
        }

        // Load appointments for day view (all staff)
        function loadDayAppointments() {
            const appointments = SharedData.getAppointments();
            const selectedDate = new Date(currentWeekStart);
            const dateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;

            // Clear existing appointments and periods
            document.querySelectorAll('.appointment-block, .appointment-period').forEach(block => block.remove());

            // Filter appointments for selected date
            const todayAppointments = appointments.filter(apt => apt.date === dateStr);
            const heightPerHour = 50;

            todayAppointments.forEach(apt => {
                // Find the barber
                const barberIndex = barbers.findIndex(b => b.id === (apt.barberId || 'owner'));
                if (barberIndex === -1) return;

                // Parse appointment start time
                const [startHour, startMinutes] = apt.time.split(':').map(Number);

                // Get service color
                const services = SharedData.getServicesWithColors();
                const firstServiceId = apt.services ? apt.services[0] : null;
                let serviceColor = '#4A90E2'; // Default color
                if (firstServiceId && services[firstServiceId]) {
                    serviceColor = services[firstServiceId].color || '#4A90E2';
                }

                // Helper function to render a block that may span multiple hours
                const renderPeriod = (periodStart, periodEnd, isActive, showText) => {
                    let currentMin = periodStart;
                    let isFirstBlock = true;

                    while (currentMin < periodEnd) {
                        // Calculate which hour this block belongs to
                        const totalMinutes = startHour * 60 + startMinutes + currentMin;
                        const currentHour = Math.floor(totalMinutes / 60);
                        const minuteInHour = totalMinutes % 60;

                        // Calculate how much of this period fits in the current hour
                        const remainingInHour = 60 - minuteInHour;
                        const periodRemaining = periodEnd - currentMin;
                        const blockDuration = Math.min(remainingInHour, periodRemaining);

                        // Check if this is the last segment
                        const isLastBlock = (currentMin + blockDuration >= periodEnd);

                        // Check if block extends to hour boundary
                        const extendsToHourBoundary = (blockDuration === remainingInHour && !isLastBlock);

                        // Find the target slot
                        const targetSlot = document.querySelector(`.time-slot[data-hour="${currentHour}"][data-barber-id="${apt.barberId || 'owner'}"]`);
                        if (targetSlot) {
                            const block = document.createElement('div');
                            block.className = isActive ? 'appointment-period active appointment-clickable' : 'appointment-period inactive';

                            const topOffset = (minuteInHour / 60) * heightPerHour;
                            let blockHeight = (blockDuration / 60) * heightPerHour;

                            // Determine border radius based on position
                            let borderRadius = '0';
                            if (isFirstBlock && isLastBlock) {
                                borderRadius = '4px'; // Single block gets full radius
                            } else if (isFirstBlock) {
                                borderRadius = '4px 4px 0 0'; // First block: top rounded
                            } else if (isLastBlock) {
                                borderRadius = '0 0 4px 4px'; // Last block: bottom rounded
                            }

                            if (isActive) {
                                // Adjust for seamless connection
                                let adjustedHeight = blockHeight;
                                let adjustedTop = topOffset;

                                if (isFirstBlock && !isLastBlock) {
                                    adjustedTop = topOffset + 1;
                                    adjustedHeight = extendsToHourBoundary ? blockHeight + 10 : blockHeight - 1;
                                } else if (!isFirstBlock && !isLastBlock) {
                                    adjustedTop = topOffset - 10;
                                    adjustedHeight = extendsToHourBoundary ? blockHeight + 20 : blockHeight + 10;
                                } else if (!isFirstBlock && isLastBlock) {
                                    adjustedTop = topOffset - 10;
                                    adjustedHeight = blockHeight + 8;
                                } else {
                                    // Single block within hour
                                    adjustedTop = topOffset + 1;
                                    adjustedHeight = blockHeight - 2;
                                }

                                // Always allow text overflow for blocks with text
                                const overflowStyle = (isFirstBlock && showText) ? 'visible' : 'hidden';
                                const zIndex = isFirstBlock && showText ? 12 : 10; // Text blocks on top

                                block.style.cssText = `
                                    position: absolute;
                                    left: 2px;
                                    right: 2px;
                                    height: ${adjustedHeight}px;
                                    top: ${adjustedTop}px;
                                    background: ${serviceColor};
                                    color: white;
                                    border-radius: ${borderRadius};
                                    padding: 2px 5px;
                                    font-size: 11px;
                                    overflow: ${overflowStyle};
                                    cursor: pointer;
                                    z-index: ${zIndex};
                                    pointer-events: auto;
                                `;

                                // Remove customer names from calendar blocks for consistency
                                // Names are visible when clicking on appointments

                                // Add click handler
                                (function(appointment) {
                                    block.addEventListener('click', function(e) {
                                        e.stopPropagation();
                                        e.preventDefault();
                                        showAppointmentDetails(appointment);
                                    }, false);
                                })(apt);

                                // Make draggable
                                block.draggable = true;
                                block.dataset.appointmentId = apt.id;
                                block.ondragstart = (e) => {
                                    e.dataTransfer.effectAllowed = 'move';
                                    e.dataTransfer.setData('appointmentId', apt.id);
                                    block.classList.add('dragging');
                                };
                                block.ondragend = () => {
                                    block.classList.remove('dragging');
                                };
                            } else {
                                // Inactive block - use same overlap logic as active blocks
                                let adjustedHeight = blockHeight;
                                let adjustedTop = topOffset;

                                if (isFirstBlock && !isLastBlock) {
                                    adjustedTop = topOffset + 1;
                                    adjustedHeight = extendsToHourBoundary ? blockHeight + 10 : blockHeight - 1;
                                } else if (!isFirstBlock && !isLastBlock) {
                                    adjustedTop = topOffset - 10;
                                    adjustedHeight = extendsToHourBoundary ? blockHeight + 20 : blockHeight + 10;
                                } else if (!isFirstBlock && isLastBlock) {
                                    adjustedTop = topOffset - 10;
                                    adjustedHeight = blockHeight + 8;
                                } else {
                                    // Single block within hour
                                    adjustedTop = topOffset + 1;
                                    adjustedHeight = blockHeight - 2;
                                }

                                // For inactive blocks, handle borders to avoid double lines at boundaries
                                let borderLeft = `1px solid ${serviceColor}`;
                                let borderRight = `1px solid ${serviceColor}`;
                                let borderTop = isFirstBlock ? `1px solid ${serviceColor}` : 'none';
                                let borderBottom = isLastBlock ? `1px solid ${serviceColor}` : 'none';

                                block.style.cssText = `
                                    position: absolute;
                                    left: 2px;
                                    right: 2px;
                                    height: ${adjustedHeight}px;
                                    top: ${adjustedTop}px;
                                    background: repeating-linear-gradient(45deg, ${serviceColor}33, ${serviceColor}33 10px, transparent 10px, transparent 20px);
                                    border-left: ${borderLeft};
                                    border-right: ${borderRight};
                                    border-top: ${borderTop};
                                    border-bottom: ${borderBottom};
                                    border-radius: ${borderRadius};
                                    opacity: 0.7;
                                    z-index: 4;
                                    pointer-events: none;
                                `;
                            }

                            targetSlot.appendChild(block);
                        }

                        currentMin += blockDuration;
                        isFirstBlock = false;
                    }
                };


                // Render appointment based on whether it has active periods
                // Note: Only use active periods if they exist AND have content
                if (apt.activePeriods && Array.isArray(apt.activePeriods) && apt.activePeriods.length > 0) {
                    let lastEnd = 0;
                    let isFirstActive = true;

                    apt.activePeriods.forEach((period) => {
                        // Render inactive gap before this active period
                        if (period.start > lastEnd) {
                            renderPeriod(lastEnd, period.start, false, false);
                        }

                        // Render active period
                        renderPeriod(period.start, period.end, true, isFirstActive);

                        lastEnd = period.end;
                        isFirstActive = false;
                    });

                    // Render inactive period after last active period if needed
                    if (lastEnd < apt.totalDuration) {
                        renderPeriod(lastEnd, apt.totalDuration, false, false);
                    }
                } else {
                    // No active periods - render as a single continuous appointment
                    renderPeriod(0, apt.totalDuration, true, true);
                }
            });
        }

        // Helper function for opening booking modal with specific barber
        function openOwnerBookingModalForBarber(day, hour, minutes, barberId) {
            // Pass the barberId to the modal
            openOwnerBookingModal(day, hour, minutes, barberId);
        }

        function generateWeeklyCalendar() {
            const weekHeader = document.getElementById('week-header');
            const timeSlotsContainer = document.getElementById('time-slots');

            weekHeader.innerHTML = '';
            timeSlotsContainer.innerHTML = '';

            // Reset any inline styles from day view
            weekHeader.style = '';
            timeSlotsContainer.style = '';

            // Update week display
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const monthNames = isZh ?
                ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'] :
                ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            if (isZh) {
                // Chinese format: X月X日 - X月X日
                document.getElementById('current-week').textContent =
                    `${currentWeekStart.getMonth() + 1}月${currentWeekStart.getDate()}日 - ${weekEnd.getMonth() + 1}月${weekEnd.getDate()}日`;
            } else {
                // English format: Mon X - Mon X
                document.getElementById('current-week').textContent =
                    `${monthNames[currentWeekStart.getMonth()]} ${currentWeekStart.getDate()} - ${monthNames[weekEnd.getMonth()]} ${weekEnd.getDate()}`;
            }

            // Add empty corner cell
            const corner = document.createElement('div');
            corner.style.borderRight = '1px solid #e0e0e0';
            weekHeader.appendChild(corner);

            // Add day headers
            const dayNames = isZh ? ['日', '一', '二', '三', '四', '五', '六'] : ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);

                const dayHeader = document.createElement('div');
                dayHeader.className = 'week-day-header';
                if (date.getTime() === today.getTime()) {
                    dayHeader.classList.add('today');
                }

                dayHeader.innerHTML = `
                    <div class="week-day-date">${date.getDate()}</div>
                    <div class="week-day-name">${dayNames[date.getDay()]}</div>
                `;
                weekHeader.appendChild(dayHeader);
            }

            // Generate time slots from 7 AM to 9 PM
            const startHour = 7;
            const endHour = 21;

            for (let hour = startHour; hour <= endHour; hour++) {
                // Time label
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                timeLabel.textContent = `${displayHour} ${ampm}`;
                timeSlotsContainer.appendChild(timeLabel);

                // Day slots
                for (let day = 0; day < 7; day++) {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.dataset.hour = hour;
                    slot.dataset.day = day;

                    // Create 4 sub-slots for 15-minute intervals
                    for (let quarter = 0; quarter < 4; quarter++) {
                        const subSlot = document.createElement('div');
                        subSlot.style.cssText = 'position: absolute; left: 0; right: 0; height: 25%; cursor: pointer;';
                        subSlot.style.top = `${quarter * 25}%`;
                        subSlot.dataset.minutes = quarter * 15;

                        // Add click handler for creating bookings at 15-minute intervals
                        subSlot.addEventListener('click', function(e) {
                            // Don't open if clicking on an existing appointment or blocked time
                            if (!e.target.closest('.appointment-block') && !e.target.closest('.blocked-time-block')) {
                                e.stopPropagation();
                                const startMinutes = hour * 60 + quarter * 15;
                                openOwnerBookingModal(day, Math.floor(startMinutes / 60), startMinutes % 60);
                            }
                        });

                        slot.appendChild(subSlot);
                    }

                    timeSlotsContainer.appendChild(slot);
                }
            }

            // Load appointments for the week
            loadWeekAppointments();

            // Setup drag and drop
            setTimeout(setupDragAndDrop, 100);
        }

        function loadWeekAppointments() {
            let appointments = SharedData.getAppointments();

            // Filter by selected barber if one is selected
            if (calendarBarberId) {
                appointments = appointments.filter(apt => apt.barberId === calendarBarberId);
            }

            // Clear existing appointments
            document.querySelectorAll('.appointment-block').forEach(block => block.remove());

            // Process each appointment
            appointments.forEach(apt => {
                // Parse date from YYYY-MM-DD format without timezone shift
                const [year, month, day] = apt.date.split('-').map(Number);
                const aptDate = new Date(year, month - 1, day);
                aptDate.setHours(0, 0, 0, 0);

                // Check if appointment is in current week
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);

                if (aptDate >= currentWeekStart && aptDate < weekEnd) {
                    // Calculate day difference properly
                    const dayDiff = Math.floor((aptDate - currentWeekStart) / (1000 * 60 * 60 * 24));

                    // Parse appointment time
                    const [hours, minutes] = apt.time.split(':').map(Number);

                    // Find the corresponding time slot
                    const targetSlot = document.querySelector(`.time-slot[data-hour="${hours}"][data-day="${dayDiff}"]`);

                    if (targetSlot) {
                        const heightPerHour = 50; // Height of one time slot
                        const baseTopOffset = (minutes / 60) * heightPerHour;

                        // Get the service color for this appointment
                        const serviceColor = apt.services && apt.services.length > 0
                            ? SharedData.getServiceColor(apt.services[0])
                            : '#2196F3';

                        if (apt.activePeriods && apt.activePeriods.length > 0) {
                            // Create separate blocks for active and inactive periods
                            let lastEnd = 0;

                            apt.activePeriods.forEach((period, index) => {
                                // Create inactive period before this active period if there's a gap
                                if (period.start > lastEnd) {
                                    const inactiveBlock = document.createElement('div');
                                    inactiveBlock.className = 'appointment-period inactive';
                                    const inactiveHeight = ((period.start - lastEnd) / 60) * heightPerHour;
                                    inactiveBlock.style.height = `${inactiveHeight - 2}px`;
                                    inactiveBlock.style.top = `${baseTopOffset + (lastEnd / 60) * heightPerHour + 1}px`;
                                    // Use service color with stripes for inactive periods
                                    inactiveBlock.style.background = `repeating-linear-gradient(45deg, ${serviceColor}33, ${serviceColor}33 10px, transparent 10px, transparent 20px)`;
                                    inactiveBlock.style.border = `1px solid ${serviceColor}`;
                                    targetSlot.appendChild(inactiveBlock);
                                }

                                // Create active period block
                                const activeBlock = document.createElement('div');
                                activeBlock.className = 'appointment-period active';
                                const activeHeight = ((period.end - period.start) / 60) * heightPerHour;
                                activeBlock.style.height = `${activeHeight - 2}px`;
                                activeBlock.style.top = `${baseTopOffset + (period.start / 60) * heightPerHour + 1}px`;
                                // Use solid service color for active periods
                                activeBlock.style.background = serviceColor;
                                targetSlot.appendChild(activeBlock);

                                lastEnd = period.end;
                            });

                            // Create inactive period after last active period if needed
                            if (lastEnd < apt.totalDuration) {
                                const inactiveBlock = document.createElement('div');
                                inactiveBlock.className = 'appointment-period inactive';
                                const inactiveHeight = ((apt.totalDuration - lastEnd) / 60) * heightPerHour;
                                inactiveBlock.style.height = `${inactiveHeight - 2}px`;
                                inactiveBlock.style.top = `${baseTopOffset + (lastEnd / 60) * heightPerHour + 1}px`;
                                // Use service color with stripes for inactive periods
                                inactiveBlock.style.background = `repeating-linear-gradient(45deg, ${serviceColor}33, ${serviceColor}33 10px, transparent 10px, transparent 20px)`;
                                inactiveBlock.style.border = `1px solid ${serviceColor}`;
                                targetSlot.appendChild(inactiveBlock);
                            }
                        }

                        // Create the main appointment block for text and interaction
                        const block = document.createElement('div');
                        block.className = 'appointment-block';
                        const blockHeight = (apt.totalDuration / 60) * heightPerHour;
                        block.style.height = `${blockHeight - 4}px`;
                        block.style.top = `${baseTopOffset + 2}px`;

                        // Fix: Ensure Men's Cut and other non-active period appointments have solid background
                        const hasActivePeriods = apt.activePeriods && apt.activePeriods.length > 0;
                        block.style.background = hasActivePeriods ? 'transparent' : serviceColor;
                        block.style.color = hasActivePeriods ? serviceColor : 'white';

                        // Set specific z-index for regular appointments to be above multi-period ones
                        if (!apt.activePeriods || apt.activePeriods.length === 0) {
                            block.style.zIndex = '6';
                        }


                        // Remove all customer names from calendar blocks for consistency
                        // Names are visible when clicking on appointments

                        // Make draggable
                        block.draggable = true;
                        block.dataset.appointmentId = apt.id;

                        block.onclick = () => {
                            showAppointmentDetails(apt);
                        };

                        block.ondragstart = (e) => {
                            e.dataTransfer.effectAllowed = 'move';
                            e.dataTransfer.setData('appointmentId', apt.id);
                            block.classList.add('dragging');
                        };

                        block.ondragend = () => {
                            block.classList.remove('dragging');
                        };

                        targetSlot.appendChild(block);
                    }
                }
            });

            // Render blocked times
            renderBlockedTimes();

            // Update the service legend
            generateServiceLegend();

            // Setup blocking selection for the new time slots
            // Removed block time creation feature
            // setupBlockingSelection();

            // Setup drag and drop for appointments
            setupDragAndDrop();
        }

        function renderBlockedTimes() {
            // Get blocked times for the current week
            for (let day = 0; day < 7; day++) {
                const currentDate = new Date(currentWeekStart);
                currentDate.setDate(currentWeekStart.getDate() + day);

                const blockedTimes = SharedData.getBlockedTimesByDate(currentDate);

                blockedTimes.forEach(block => {
                    const startMinutes = SharedData.timeToMinutes(block.startTime);
                    const endMinutes = SharedData.timeToMinutes(block.endTime);
                    const startHour = Math.floor(startMinutes / 60);
                    const endHour = Math.ceil(endMinutes / 60);

                    const heightPerHour = 50;

                    // Find the starting time slot
                    const targetSlot = document.querySelector(`.time-slot[data-hour="${startHour}"][data-day="${day}"]`);

                    if (targetSlot) {
                        // Create the blocked time visual
                        const blockedDiv = document.createElement('div');
                        blockedDiv.className = 'blocked-time-block';
                        blockedDiv.dataset.blockId = block.id;

                        const topOffset = (startMinutes % 60) / 60 * heightPerHour;
                        const height = ((endMinutes - startMinutes) / 60) * heightPerHour;

                        blockedDiv.style.top = topOffset + 'px';
                        blockedDiv.style.height = (height - 4) + 'px';

                        const startTimeStr = block.startTime;
                        const endTimeStr = block.endTime;
                        blockedDiv.innerHTML = '';
                        blockedDiv.title = `${startTimeStr} - ${endTimeStr}`;

                        // Make draggable
                        blockedDiv.draggable = true;
                        blockedDiv.dataset.blockDate = block.date;
                        blockedDiv.dataset.blockStart = block.startTime;
                        blockedDiv.dataset.blockEnd = block.endTime;
                        blockedDiv.dataset.blockReason = block.reason || 'Blocked by owner';

                        // Add click to show details
                        blockedDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showBlockedTimeDetails(block);
                        });

                        // Add drag handlers
                        blockedDiv.ondragstart = (e) => {
                            e.dataTransfer.effectAllowed = 'move';
                            e.dataTransfer.setData('blockId', block.id);
                            e.dataTransfer.setData('blockType', 'blocked');
                            blockedDiv.classList.add('dragging');
                        };

                        blockedDiv.ondragend = () => {
                            blockedDiv.classList.remove('dragging');
                        };

                        targetSlot.appendChild(blockedDiv);
                    }
                });
            }
        }

        function prevWeek() {
            if (calendarViewMode === 'day') {
                // Navigate by day in day view
                currentWeekStart.setDate(currentWeekStart.getDate() - 1);
                generateDayViewCalendar();
            } else {
                // Navigate by week in week view
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                generateWeeklyCalendar();
            }
        }

        function nextWeek() {
            if (calendarViewMode === 'day') {
                // Navigate by day in day view
                currentWeekStart.setDate(currentWeekStart.getDate() + 1);
                generateDayViewCalendar();
            } else {
                // Navigate by week in week view
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                generateWeeklyCalendar();
            }
        }

        // Add swipe support for week navigation
        function setupSwipeNavigation() {
            const timeGrid = document.getElementById('time-grid');
            if (!timeGrid) return;

            timeGrid.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });

            timeGrid.addEventListener('touchend', (e) => {
                if (!touchStartX) return;

                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchStartX - touchEndX;

                if (Math.abs(diff) > 50) { // Minimum swipe distance
                    if (diff > 0) {
                        nextWeek(); // Swipe left
                    } else {
                        prevWeek(); // Swipe right
                    }
                }

                touchStartX = null;
            });
        }

        // Check if creating a new appointment would create a conflict
        function checkNewAppointmentConflict(newDate, newTime, duration, activePeriods = null, barberId = null) {
            const appointments = SharedData.getAppointments();

            console.log('Checking conflict for:', { newDate, newTime, duration, barberId });

            // Parse the new time
            const [newHour, newMin] = newTime.split(':').map(Number);
            const newStartMinutes = newHour * 60 + newMin;
            const newEndMinutes = newStartMinutes + duration;

            // Check for conflicts with existing appointments
            for (const apt of appointments) {
                // Skip if different date
                if (apt.date !== newDate) continue;

                console.log('Checking against appointment:', { aptDate: apt.date, aptBarberId: apt.barberId, newBarberId: barberId });

                // Skip if different barber (when barberId is specified)
                // If appointment has no barberId (old data), don't skip it as it might conflict
                if (barberId && apt.barberId) {
                    if (apt.barberId !== barberId) {
                        console.log('  -> Skipping: different barber');
                        continue;
                    }
                } else if (!barberId && apt.barberId) {
                    // If we're not checking for a specific barber but the appointment has one,
                    // we should still check for conflict
                    console.log('  -> Checking: no specific barber requested, checking all');
                }

                // Parse existing appointment time
                const [aptHour, aptMin] = apt.time.split(':').map(Number);
                const aptStartMinutes = aptHour * 60 + aptMin;
                const aptEndMinutes = aptStartMinutes + apt.totalDuration;

                // Check if there's an overlap in active time
                if (apt.activePeriods && apt.activePeriods.length > 0) {
                    // Check each active period for conflicts
                    for (const period of apt.activePeriods) {
                        const periodStart = aptStartMinutes + period.start;
                        const periodEnd = aptStartMinutes + period.end;

                        // Check if new appointment's active periods would overlap
                        if (activePeriods && activePeriods.length > 0) {
                            for (const newPeriod of activePeriods) {
                                const newPeriodStart = newStartMinutes + newPeriod.start;
                                const newPeriodEnd = newStartMinutes + newPeriod.end;

                                // Check for overlap
                                if (newPeriodStart < periodEnd && newPeriodEnd > periodStart) {
                                    console.log('  -> CONFLICT: active periods overlap');
                                    return true; // Conflict detected
                                }
                            }
                        } else {
                            // New appointment has no active periods, check full duration
                            if (newStartMinutes < periodEnd && newEndMinutes > periodStart) {
                                console.log('  -> CONFLICT: new appointment overlaps with active period');
                                return true; // Conflict detected
                            }
                        }
                    }
                } else {
                    // Existing appointment has no active periods, check full duration
                    if (activePeriods && activePeriods.length > 0) {
                        for (const newPeriod of activePeriods) {
                            const newPeriodStart = newStartMinutes + newPeriod.start;
                            const newPeriodEnd = newStartMinutes + newPeriod.end;

                            // Check for overlap with full appointment
                            if (newPeriodStart < aptEndMinutes && newPeriodEnd > aptStartMinutes) {
                                console.log('  -> CONFLICT: new active period overlaps with appointment');
                                return true; // Conflict detected
                            }
                        }
                    } else {
                        // Neither has active periods, check full duration overlap
                        if (newStartMinutes < aptEndMinutes && newEndMinutes > aptStartMinutes) {
                            console.log('  -> CONFLICT: appointments overlap', { newStart: newStartMinutes, newEnd: newEndMinutes, aptStart: aptStartMinutes, aptEnd: aptEndMinutes });
                            return true; // Conflict detected
                        }
                    }
                }
            }

            // Also check for conflicts with blocked times
            const blockedTimes = SharedData.getBlockedTimesByDate(new Date(newDate));
            for (const block of blockedTimes) {
                // Skip if different barber (when barberId is specified)
                if (barberId && block.barberId && block.barberId !== barberId) continue;

                const blockStartMinutes = SharedData.timeToMinutes(block.startTime);
                const blockEndMinutes = SharedData.timeToMinutes(block.endTime);

                // Check if new appointment overlaps with blocked time
                if (newStartMinutes < blockEndMinutes && newEndMinutes > blockStartMinutes) {
                    console.log('  -> CONFLICT: overlaps with blocked time');
                    return true; // Conflict with blocked time
                }
            }

            console.log('  -> No conflict found');
            return false; // No conflict
        }

        // Check if moving an appointment would create a conflict
        function checkAppointmentConflict(appointmentId, newDate, newTime, duration) {
            const appointments = SharedData.getAppointments();
            const movingAppointment = appointments.find(apt => apt.id === appointmentId);
            if (!movingAppointment) return false;

            // Parse the new time
            const [newHour, newMin] = newTime.split(':').map(Number);
            const newStartMinutes = newHour * 60 + newMin;
            const newEndMinutes = newStartMinutes + duration;

            // Check for conflicts with other appointments
            for (const apt of appointments) {
                // Skip the appointment being moved
                if (apt.id === appointmentId) continue;

                // Skip if different date
                if (apt.date !== newDate) continue;

                // Skip if different barber (when both have barberId)
                if (movingAppointment.barberId && apt.barberId && movingAppointment.barberId !== apt.barberId) {
                    continue;
                }

                // Parse existing appointment time
                const [aptHour, aptMin] = apt.time.split(':').map(Number);
                const aptStartMinutes = aptHour * 60 + aptMin;
                const aptEndMinutes = aptStartMinutes + apt.totalDuration;

                // First check if they overlap in time at all
                if (newStartMinutes >= aptEndMinutes || newEndMinutes <= aptStartMinutes) {
                    // No overlap, skip this appointment
                    continue;
                }

                // They overlap in time, now check active periods
                if (apt.activePeriods && apt.activePeriods.length > 0) {
                    // The existing appointment has active periods - check if we conflict with any
                    for (const period of apt.activePeriods) {
                        const periodStart = aptStartMinutes + period.start;
                        const periodEnd = aptStartMinutes + period.end;

                        // Check if new appointment's active periods would overlap
                        if (movingAppointment.activePeriods && movingAppointment.activePeriods.length > 0) {
                            for (const movingPeriod of movingAppointment.activePeriods) {
                                const movingPeriodStart = newStartMinutes + movingPeriod.start;
                                const movingPeriodEnd = newStartMinutes + movingPeriod.end;

                                // Check for overlap
                                if (movingPeriodStart < periodEnd && movingPeriodEnd > periodStart) {
                                    return true; // Conflict detected
                                }
                            }
                        } else {
                            // Moving appointment has no active periods, check full duration
                            if (newStartMinutes < periodEnd && newEndMinutes > periodStart) {
                                return true; // Conflict detected
                            }
                        }
                    }
                } else {
                    // Existing appointment has no active periods, check full duration
                    // Only check if moving appointment also has active time
                    if (movingAppointment.activePeriods && movingAppointment.activePeriods.length > 0) {
                        for (const movingPeriod of movingAppointment.activePeriods) {
                            const movingPeriodStart = newStartMinutes + movingPeriod.start;
                            const movingPeriodEnd = newStartMinutes + movingPeriod.end;

                            // Check for overlap with full appointment
                            if (movingPeriodStart < aptEndMinutes && movingPeriodEnd > aptStartMinutes) {
                                return true; // Conflict detected
                            }
                        }
                    } else {
                        // Neither has active periods, check full duration overlap
                        if (newStartMinutes < aptEndMinutes && newEndMinutes > aptStartMinutes) {
                            console.log('  -> CONFLICT: appointments overlap', { newStart: newStartMinutes, newEnd: newEndMinutes, aptStart: aptStartMinutes, aptEnd: aptEndMinutes });
                            return true; // Conflict detected
                        }
                    }
                }
            }

            // Also check for conflicts with blocked times when moving appointments
            const blockedTimes = SharedData.getBlockedTimesByDate(new Date(newDate));
            for (const block of blockedTimes) {
                const blockStartMinutes = SharedData.timeToMinutes(block.startTime);
                const blockEndMinutes = SharedData.timeToMinutes(block.endTime);

                // Check if moving appointment's active periods overlap with blocked time
                if (movingAppointment.activePeriods && movingAppointment.activePeriods.length > 0) {
                    for (const period of movingAppointment.activePeriods) {
                        const periodStart = newStartMinutes + period.start;
                        const periodEnd = newStartMinutes + period.end;

                        if (periodStart < blockEndMinutes && periodEnd > blockStartMinutes) {
                            return true; // Conflict with blocked time
                        }
                    }
                } else {
                    // Check full appointment duration against blocked time
                    if (newStartMinutes < blockEndMinutes && newEndMinutes > blockStartMinutes) {
                        return true; // Conflict with blocked time
                    }
                }
            }

            return false; // No conflict
        }

        // Setup drag and drop for time slots
        function setupDragAndDrop() {
            // Add drop listeners to all time slots
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.ondragover = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    // Calculate which 15-minute interval is being hovered
                    const rect = slot.getBoundingClientRect();
                    const relativeY = e.clientY - rect.top;
                    const slotHeight = rect.height;
                    const quarterHeight = slotHeight / 4;

                    // Determine which quarter we're in
                    const quarter = Math.floor(relativeY / quarterHeight);

                    // Set background with gradient to show the drop zone
                    const gradientPercent = (quarter * 25) + 12.5; // Center of each quarter
                    slot.style.background = `linear-gradient(to bottom,
                        transparent ${quarter * 25}%,
                        #E3F2FD ${quarter * 25}%,
                        #E3F2FD ${(quarter + 1) * 25}%,
                        transparent ${(quarter + 1) * 25}%)`;
                };

                slot.ondragleave = () => {
                    slot.style.background = '';
                };

                slot.ondrop = (e) => {
                    e.preventDefault();
                    slot.style.background = '';

                    // Calculate which 15-minute interval was dropped on
                    const rect = slot.getBoundingClientRect();
                    const relativeY = e.clientY - rect.top;
                    const slotHeight = rect.height;
                    const quarterHeight = slotHeight / 4;

                    // Determine which quarter (0-3) for minutes (00, 15, 30, 45)
                    let quarter = Math.floor(relativeY / quarterHeight);
                    // Clamp to valid range
                    quarter = Math.max(0, Math.min(3, quarter));

                    const minutes = quarter * 15;

                    const appointmentId = e.dataTransfer.getData('appointmentId');
                    const blockId = e.dataTransfer.getData('blockId');
                    const blockType = e.dataTransfer.getData('blockType');
                    const newHour = parseInt(slot.dataset.hour);
                    const newDay = parseInt(slot.dataset.day);

                    // Calculate new date correctly
                    const newDate = new Date(currentWeekStart);
                    newDate.setDate(currentWeekStart.getDate() + newDay);

                    // Format date as YYYY-MM-DD
                    const year = newDate.getFullYear();
                    const month = String(newDate.getMonth() + 1).padStart(2, '0');
                    const day = String(newDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;

                    // Format time as HH:MM with calculated minutes
                    const timeStr = `${String(newHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

                    // Handle blocked time drag and drop
                    if (blockType === 'blocked' && blockId) {
                        const blockedTimes = SharedData.getBlockedTimes();
                        const block = blockedTimes.find(b => b.id === blockId);

                        if (block) {
                            // Calculate duration
                            const startMinutes = SharedData.timeToMinutes(block.startTime);
                            const endMinutes = SharedData.timeToMinutes(block.endTime);
                            const duration = endMinutes - startMinutes;

                            // Calculate new end time
                            const newStartMinutes = newHour * 60 + minutes;
                            const newEndMinutes = newStartMinutes + duration;
                            const newEndHour = Math.floor(newEndMinutes / 60);
                            const newEndMinute = newEndMinutes % 60;
                            const newEndTimeStr = `${newEndHour.toString().padStart(2, '0')}:${newEndMinute.toString().padStart(2, '0')}`;

                            // Check for conflicts with appointments and other blocked times
                            const hasConflict = checkNewAppointmentConflict(dateStr, timeStr, duration, null);
                            if (hasConflict) {
                                alert(isZh ? '无法移动：该时间段与现有预约冲突' : 'Cannot move: This time conflicts with an existing appointment');
                                return;
                            }

                            // Also check for conflicts with other blocked times (excluding self)
                            const otherBlockedTimes = SharedData.getBlockedTimesByDate(new Date(dateStr))
                                .filter(b => b.id !== blockId);
                            for (const otherBlock of otherBlockedTimes) {
                                const otherStartMinutes = SharedData.timeToMinutes(otherBlock.startTime);
                                const otherEndMinutes = SharedData.timeToMinutes(otherBlock.endTime);

                                if (newStartMinutes < otherEndMinutes && newEndMinutes > otherStartMinutes) {
                                    alert(isZh ? '无法移动：该时间段与另一个屏蔽时间冲突' : 'Cannot move: This time conflicts with another blocked time');
                                    return;
                                }
                            }

                            // Update the blocked time
                            SharedData.deleteBlockedTime(blockId);
                            SharedData.saveBlockedTime({
                                date: dateStr,
                                startTime: timeStr,
                                endTime: newEndTimeStr,
                                reason: block.reason
                            });

                            // Refresh calendar
                            generateWeeklyCalendar();
                        }
                        return;
                    }

                    // Update appointment
                    const appointments = SharedData.getAppointments();
                    const appointment = appointments.find(apt => apt.id === appointmentId);

                    if (appointment) {
                        // Check for conflicts before allowing the drop
                        if (checkAppointmentConflict(appointmentId, dateStr, timeStr, appointment.totalDuration)) {
                            // Show error message
                            const errorMsg = isZh ?
                                '无法移动：该时间段与另一个预约的活动时间冲突' :
                                'Cannot move: This time conflicts with another appointment\'s active time';
                            alert(errorMsg);
                            return;
                        }

                        // No conflict, proceed with the move
                        // Store old appointment details for the email
                        const oldAppointment = {...appointment};

                        appointment.date = dateStr;
                        appointment.time = timeStr;

                        localStorage.setItem('appointments', JSON.stringify(appointments));

                        // Send reschedule email if customer has email
                        if (appointment.customerEmail) {
                            SharedData.sendRescheduledEmail(appointment, oldAppointment);
                        }

                        // Trigger storage event
                        window.dispatchEvent(new StorageEvent('storage', {
                            key: 'appointments',
                            newValue: JSON.stringify(appointments),
                            url: window.location.href
                        }));

                        // Refresh calendar
                        generateWeeklyCalendar();
                    }
                };
            });
        }

        // Setup mouse events for blocking time
        function setupBlockingSelection() {
            document.querySelectorAll('.time-slot').forEach(slot => {
                // Mouse events for desktop
                slot.addEventListener('mousedown', (e) => {
                    // Only start selection if not clicking on an existing appointment or block
                    if (e.target.classList.contains('time-slot')) {
                        e.preventDefault();
                        startSelection(slot, e);
                    }
                });

                slot.addEventListener('mousemove', (e) => {
                    if (isSelecting) {
                        updateSelection(slot, e);
                    }
                });

                slot.addEventListener('mouseenter', (e) => {
                    if (isSelecting) {
                        extendSelection(slot);
                    }
                });
            });

            // Global mouse up to end selection
            document.addEventListener('mouseup', (e) => {
                if (isSelecting) {
                    endSelection();
                }
            });

            // ESC key to cancel selection
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isSelecting) {
                    cancelSelection();
                }
            });
        }

        function startSelection(slot, event) {
            isSelecting = true;
            selectionStart = {
                day: parseInt(slot.dataset.day),
                hour: parseInt(slot.dataset.hour),
                slot: slot
            };
            selectionEnd = selectionStart;

            // Create selection overlay
            if (!selectionOverlay) {
                selectionOverlay = document.createElement('div');
                selectionOverlay.className = 'selection-overlay';
            }

            // Calculate the 15-minute interval based on click position
            const rect = slot.getBoundingClientRect();
            const relativeY = event.clientY - rect.top;
            const slotHeight = rect.height;
            const quarter = Math.floor((relativeY / slotHeight) * 4);
            selectionStart.minutes = quarter * 15;
            selectionEnd.minutes = (quarter + 1) * 15;

            updateSelectionOverlay();
            slot.appendChild(selectionOverlay);
        }

        function extendSelection(slot) {
            if (!isSelecting || !selectionStart) return;

            const day = parseInt(slot.dataset.day);
            const hour = parseInt(slot.dataset.hour);

            // Only allow selection within the same day
            if (day === selectionStart.day) {
                selectionEnd = {
                    day: day,
                    hour: hour,
                    minutes: 0,
                    slot: slot
                };
                updateSelectionOverlay();
            }
        }

        function updateSelection(slot, event) {
            if (!isSelecting || !selectionStart) return;

            const rect = slot.getBoundingClientRect();
            const relativeY = event.clientY - rect.top;
            const slotHeight = rect.height;
            const quarter = Math.floor((relativeY / slotHeight) * 4);

            if (slot === selectionEnd.slot) {
                selectionEnd.minutes = (quarter + 1) * 15;
                updateSelectionOverlay();
            }
        }

        function updateSelectionOverlay() {
            if (!selectionOverlay || !selectionStart || !selectionEnd) return;

            const startHour = selectionStart.hour;
            const endHour = selectionEnd.hour;
            const startMinutes = selectionStart.minutes || 0;
            const endMinutes = selectionEnd.minutes || 60;

            // Calculate position and height
            const minHour = Math.min(startHour, endHour);
            const maxHour = Math.max(startHour, endHour);

            const startTotalMinutes = (minHour === startHour ? startMinutes : 0);
            const endTotalMinutes = (maxHour === endHour ? endMinutes : 60);

            const totalSlots = maxHour - minHour + 1;
            const heightPerHour = 50; // Height of one time slot

            // Position from the start
            const topOffset = (minHour === startHour ? startMinutes : 0) / 60 * heightPerHour;

            // Calculate total height
            let height;
            if (minHour === maxHour) {
                height = (endMinutes - startMinutes) / 60 * heightPerHour;
            } else {
                height = ((60 - startTotalMinutes) / 60 * heightPerHour) + // First hour
                        ((maxHour - minHour - 1) * heightPerHour) + // Middle hours
                        (endTotalMinutes / 60 * heightPerHour); // Last hour
            }

            // Find the starting slot
            const startSlot = document.querySelector(`.time-slot[data-hour="${minHour}"][data-day="${selectionStart.day}"]`);
            if (startSlot) {
                if (selectionOverlay.parentElement !== startSlot) {
                    startSlot.appendChild(selectionOverlay);
                }
                selectionOverlay.style.top = topOffset + 'px';
                selectionOverlay.style.height = height + 'px';
            }
        }

        function endSelection() {
            if (!isSelecting || !selectionStart || !selectionEnd) {
                cancelSelection();
                return;
            }

            // Helper function to format time correctly when minutes might be 60
            const formatTimeWithMinutes = (hour, minutes) => {
                if (minutes === 60) {
                    hour = hour + 1;
                    minutes = 0;
                }
                return `${String(hour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            };

            let startTime, endTime;

            if (selectionStart.hour <= selectionEnd.hour) {
                startTime = formatTimeWithMinutes(selectionStart.hour, selectionStart.minutes || 0);
                endTime = formatTimeWithMinutes(selectionEnd.hour, selectionEnd.minutes || 0);
            } else {
                startTime = formatTimeWithMinutes(selectionEnd.hour, selectionEnd.minutes || 0);
                endTime = formatTimeWithMinutes(selectionStart.hour, selectionStart.minutes || 0);
            }

            // Calculate the date for this slot
            const selectedDate = new Date(currentWeekStart);
            selectedDate.setDate(currentWeekStart.getDate() + selectionStart.day);

            // Show confirmation dialog
            confirmBlockTime(selectedDate, startTime, endTime);

            cancelSelection();
        }

        function cancelSelection() {
            isSelecting = false;
            selectionStart = null;
            selectionEnd = null;
            if (selectionOverlay && selectionOverlay.parentElement) {
                selectionOverlay.parentElement.removeChild(selectionOverlay);
            }
        }

        function confirmBlockTime(date, startTime, endTime) {
            const formatDate = (d) => {
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${d.getFullYear()}-${month}-${day}`;
            };

            const dateStr = formatDate(date);
            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });

            const message = isZh
                ? `确认屏蔽时间？\n\n日期: ${dayName}, ${dateStr}\n时间: ${startTime} - ${endTime}`
                : `Block this time?\n\nDate: ${dayName}, ${dateStr}\nTime: ${startTime} - ${endTime}`;

            if (confirm(message)) {
                const block = {
                    date: dateStr,
                    startTime: startTime,
                    endTime: endTime,
                    reason: 'Blocked by owner'
                };

                SharedData.saveBlockedTime(block);
                generateWeeklyCalendar();
                loadAppointments();
            }
        }

        function loadAppointments() {
            const appointmentsList = document.getElementById('appointments-list');
            if (!appointmentsList) return;

            const today = new Date();
            const todayStr = today.toLocaleDateString('en-US');

            try {
                const appointments = SharedData.getAppointmentsByDate(today);

                if (appointments.length === 0) {
                    appointmentsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No appointments today</div>';
                } else {
                    appointmentsList.innerHTML = '';

                    // Sort appointments by time
                    appointments.sort((a, b) => {
                        const timeA = SharedData.timeToMinutes(a.time);
                        const timeB = SharedData.timeToMinutes(b.time);
                        return timeA - timeB;
                    });

                    appointments.forEach(apt => {
                        const card = document.createElement('div');
                        card.className = 'appointment-card';

                        // Get the service color
                        const serviceColor = apt.services && apt.services.length > 0
                            ? SharedData.getServiceColor(apt.services[0])
                            : '#2196F3';

                        // Add colored left border
                        card.style.borderLeft = `4px solid ${serviceColor}`;

                        // Format time display
                        const displayTime = SharedData.formatTime(apt.time) || apt.time;

                        card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold;">${apt.customerName || 'Guest'}</div>
                                    <div style="display: none;">
                                        <span style="display: inline-block; width: 12px; height: 12px; background: ${serviceColor}; border-radius: 2px; margin-right: 5px; vertical-align: middle;"></span>
                                        ${apt.serviceNames.join(', ')}
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-top: 2px;">Duration: ${apt.totalDuration} min | $${apt.totalPrice}</div>
                                </div>
                                <div>
                                    <div class="time-badge">${displayTime}</div>
                                    <button onclick="deleteAppointment('${apt.id}')" style="background: #f44336; color: white; border: none; padding: 3px 8px; border-radius: 3px; font-size: 11px; margin-top: 5px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        `;
                        appointmentsList.appendChild(card);
                    });
                }

                // Update dashboard metrics
                updateDashboardMetrics();
            } catch (e) {
                appointmentsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No appointments today</div>';
            }
        }

        // Dashboard update functions
        function updateDashboardMetrics() {
            try {
                const today = new Date();
                let appointments = SharedData.getAppointments();

                // Filter by selected barber if one is selected
                if (dashboardBarberId) {
                    appointments = appointments.filter(apt => apt.barberId === dashboardBarberId);
                }

                console.log('Updating dashboard metrics...');
                console.log('Total appointments:', appointments.length);
                console.log('Today:', today.toDateString());

                // Update Today's Appointments
                let todayAppointments = SharedData.getAppointmentsByDate(today);
                // Filter by selected barber if needed
                if (dashboardBarberId) {
                    todayAppointments = todayAppointments.filter(apt => apt.barberId === dashboardBarberId);
                }
                const todayAppointmentsEl = document.getElementById('today-appointments');
                if (todayAppointmentsEl) {
                    todayAppointmentsEl.textContent = todayAppointments.length;
                }
                console.log("Today's appointments:", todayAppointments.length);

                // Calculate This Week's Revenue
                const weekStart = getWeekStart(today);
                const weekEnd = getWeekEnd(today);
                console.log('Week start:', weekStart.toDateString());
                console.log('Week end:', weekEnd.toDateString());

                const weekRevenue = calculateWeekRevenue(weekStart, weekEnd);
                const weekRevenueEl = document.getElementById('week-revenue');
                if (weekRevenueEl) {
                    weekRevenueEl.textContent = '$' + weekRevenue.toFixed(0);
                }
                console.log('This week revenue:', weekRevenue);

                // Calculate Next Week's Revenue
                const nextWeekStart = new Date(today);
                nextWeekStart.setDate(today.getDate() - today.getDay() + 7); // Go to next Sunday
                nextWeekStart.setHours(0, 0, 0, 0);
                const nextWeekEnd = new Date(nextWeekStart);
                nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                nextWeekEnd.setHours(23, 59, 59, 999);
                const nextWeekRevenue = calculateWeekRevenue(nextWeekStart, nextWeekEnd);
                const nextWeekRevenueEl = document.getElementById('next-week-revenue');
                if (nextWeekRevenueEl) {
                    nextWeekRevenueEl.textContent = '$' + nextWeekRevenue.toFixed(0);
                }

                // Calculate Utilization Rate
                const utilizationRate = calculateUtilizationRate();
                const utilizationRateEl = document.getElementById('utilization-rate');
                if (utilizationRateEl) {
                    utilizationRateEl.textContent = utilizationRate.toFixed(0) + '%';
                }

                // Update Weekly Revenue Chart
                updateWeeklyRevenueChart();

                // Update Service Breakdown
                updateServiceBreakdownChart();
            } catch (error) {
                console.error('Error updating dashboard metrics:', error);
            }
        }

        function getWeekEnd(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + 6;
            const result = new Date(d.setDate(diff));
            result.setHours(23, 59, 59, 999);
            return result;
        }

        function calculateWeekRevenue(startDate, endDate) {
            let appointments = SharedData.getAppointments();

            // Filter by selected barber if one is selected
            if (dashboardBarberId) {
                appointments = appointments.filter(apt => apt.barberId === dashboardBarberId);
            }

            let totalRevenue = 0;

            console.log(`Calculating revenue from ${startDate.toDateString()} to ${endDate.toDateString()}`);

            appointments.forEach(apt => {
                // Parse date properly to avoid timezone issues
                const [year, month, day] = apt.date.split('-').map(Number);
                const aptDate = new Date(year, month - 1, day);
                aptDate.setHours(0, 0, 0, 0);

                if (aptDate >= startDate && aptDate <= endDate) {
                    const price = apt.totalPrice || 0;
                    totalRevenue += price;
                    console.log(`  - Appointment on ${apt.date}: $${price} (included)`);
                } else {
                    console.log(`  - Appointment on ${apt.date}: $${apt.totalPrice || 0} (excluded - outside date range)`);
                }
            });

            console.log(`Total revenue: $${totalRevenue}`);
            return totalRevenue;
        }

        function calculateUtilizationRate() {
            const today = new Date();
            const startOfWeek = getWeekStart(today);
            const endOfWeek = getWeekEnd(today);
            let appointments = SharedData.getAppointments();

            // Filter by selected barber if one is selected
            if (dashboardBarberId) {
                appointments = appointments.filter(apt => apt.barberId === dashboardBarberId);
            }

            const storeHours = SharedData.getStoreHours();

            let totalAvailableMinutes = 0;
            let totalBookedMinutes = 0;

            // Calculate for each day of the week
            for (let i = 0; i < 7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);

                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const dayName = dayNames[d.getDay()];
                const dayHours = storeHours[dayName];

                if (!dayHours.closed) {
                    const openMinutes = SharedData.timeToMinutes(dayHours.open);
                    const closeMinutes = SharedData.timeToMinutes(dayHours.close);
                    totalAvailableMinutes += (closeMinutes - openMinutes);

                    // Get appointments for this day
                    const dayAppointments = SharedData.getAppointmentsByDate(d);
                    dayAppointments.forEach(apt => {
                        // Count only active time if service has active periods
                        if (apt.activePeriods && apt.activePeriods.length > 0) {
                            apt.activePeriods.forEach(period => {
                                totalBookedMinutes += (period.end - period.start);
                            });
                        } else {
                            totalBookedMinutes += apt.totalDuration || 0;
                        }
                    });
                }
            }

            if (totalAvailableMinutes === 0) return 0;
            return (totalBookedMinutes / totalAvailableMinutes) * 100;
        }

        function updateWeeklyRevenueChart() {
            const container = document.getElementById('weekly-revenue-bars');
            if (!container) return;

            const today = new Date();
            const startOfWeek = getWeekStart(today);
            const dailyRevenues = [];
            let maxRevenue = 0;

            // Calculate revenue for each day
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(startOfWeek);
                currentDay.setDate(startOfWeek.getDate() + i);

                let dayAppointments = SharedData.getAppointmentsByDate(currentDay);

                // Filter by selected barber if one is selected
                if (dashboardBarberId) {
                    dayAppointments = dayAppointments.filter(apt => apt.barberId === dashboardBarberId);
                }

                const dayRevenue = dayAppointments.reduce((sum, apt) => sum + (apt.totalPrice || 0), 0);
                dailyRevenues.push(dayRevenue);
                maxRevenue = Math.max(maxRevenue, dayRevenue);
            }

            // Generate bars
            container.innerHTML = '';
            const dayNames = isZh
                ? ['周日', '周一', '周二', '周三', '周四', '周五', '周六']
                : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            dailyRevenues.forEach((revenue, index) => {
                const height = maxRevenue > 0 ? (revenue / maxRevenue * 100) : 0;
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = height + '%';
                // Adjust label position for Chinese to prevent overlap
                const labelBottom = isZh ? '-28px' : '-20px';
                bar.innerHTML = `
                    <div class="bar-label" style="bottom: ${labelBottom};">${dayNames[index]}</div>
                    <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; white-space: nowrap;">
                        ${revenue > 0 ? '$' + revenue : ''}
                    </div>
                `;
                container.appendChild(bar);
            });
        }

        function updateServiceBreakdownChart() {
            const canvas = document.getElementById('service-pie-chart');
            const legendContainer = document.getElementById('service-legend-pie');
            if (!canvas || !legendContainer) return;

            const ctx = canvas.getContext('2d');
            let appointments = SharedData.getAppointments();

            // Filter by selected barber if one is selected
            if (dashboardBarberId) {
                appointments = appointments.filter(apt => apt.barberId === dashboardBarberId);
            }

            const services = SharedData.getServicesWithColors();

            // Calculate total active time per service
            const serviceTime = {};
            let totalMinutes = 0;

            appointments.forEach(apt => {
                // Ensure apt.services exists and is an array
                if (!apt.services || !Array.isArray(apt.services)) {
                    console.warn('Appointment missing services field:', apt);
                    return;
                }

                apt.services.forEach(serviceId => {
                    if (!serviceTime[serviceId]) {
                        serviceTime[serviceId] = 0;
                    }

                    // Calculate active time
                    const service = services[serviceId];
                    if (service && apt.activePeriods && apt.activePeriods.length > 0) {
                        apt.activePeriods.forEach(period => {
                            serviceTime[serviceId] += (period.end - period.start);
                            totalMinutes += (period.end - period.start);
                        });
                    } else if (service) {
                        serviceTime[serviceId] += service.duration || 0;
                        totalMinutes += service.duration || 0;
                    }
                });
            });

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (totalMinutes === 0) {
                // No data to show
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('No service data', canvas.width / 2, canvas.height / 2);
                legendContainer.innerHTML = '';
                return;
            }

            // Draw pie chart
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 80;
            let currentAngle = -Math.PI / 2; // Start at top

            legendContainer.innerHTML = '';

            Object.keys(serviceTime).forEach(serviceId => {
                if (serviceTime[serviceId] === 0) return;

                const service = services[serviceId];
                const percentage = (serviceTime[serviceId] / totalMinutes) * 100;
                const sliceAngle = (serviceTime[serviceId] / totalMinutes) * 2 * Math.PI;

                // Draw slice
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = service.color || '#757575';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                currentAngle += sliceAngle;

                // Add to legend
                const legendItem = document.createElement('div');
                legendItem.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 12px;';
                const serviceName = translateServiceName(service.name);
                legendItem.innerHTML = `
                    <div style="width: 16px; height: 16px; background: ${service.color}; border-radius: 2px;"></div>
                    <span>${serviceName}: ${Math.round(percentage)}%</span>
                `;
                legendContainer.appendChild(legendItem);
            });
        }

        let currentAppointment = null;
        let ownerBookingData = {
            day: 0,
            hour: 0,
            date: null
        };

        function openOwnerBookingModal(day, hour, minutes = 0, barberId = null) {
            // Calculate the date based on current week and day
            const date = new Date(currentWeekStart);
            date.setDate(currentWeekStart.getDate() + day);

            ownerBookingData.day = day;
            ownerBookingData.hour = hour;
            ownerBookingData.date = date;

            // Set date field(s) - no limits for owners
            const dateStr = date.toISOString().split('T')[0];

            document.getElementById('owner-booking-date').value = dateStr;
            document.getElementById('owner-booking-start-date').value = dateStr;
            document.getElementById('owner-booking-end-date').value = dateStr;

            // Reset date sections visibility
            document.getElementById('date-single-section').style.display = 'block';
            document.getElementById('date-range-section').style.display = 'none';

            // Set start time (clicked slot time with minutes)
            const startHour = hour.toString().padStart(2, '0');
            const startMinutes = minutes.toString().padStart(2, '0');
            document.getElementById('owner-booking-start').value = `${startHour}:${startMinutes}`;

            // Set default end time (15 minutes later)
            const totalMinutes = hour * 60 + minutes + 15;
            const endHour = Math.floor(totalMinutes / 60);
            const endMinutes = totalMinutes % 60;
            document.getElementById('owner-booking-end').value =
                `${endHour.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;

            // Reset form
            document.getElementById('owner-booking-service').value = '';
            document.getElementById('owner-booking-name').value = '';
            document.getElementById('owner-booking-phone').value = '';
            document.getElementById('owner-booking-email').value = '';
            document.getElementById('booking-summary').style.display = 'none';

            // Populate dropdowns
            populateOwnerBarberDropdown(barberId);
            populateOwnerServiceDropdown();

            // Show modal
            document.getElementById('owner-booking-modal').style.display = 'flex';
        }

        function populateOwnerBarberDropdown(barberId = null) {
            const select = document.getElementById('owner-booking-barber');
            const barbers = SharedData.getBarbers();

            // Clear existing options
            select.innerHTML = '';

            // Determine which barber to pre-select
            let selectedBarberId = barberId || calendarBarberId;

            // If in weekly view with a specific barber, don't show dropdown at all - just use that barber
            if (calendarBarberId && calendarViewMode === 'week') {
                // Only show the current barber as the only option
                const currentBarber = barbers.find(b => b.id === calendarBarberId);
                if (currentBarber) {
                    const option = document.createElement('option');
                    option.value = currentBarber.id;
                    option.textContent = currentBarber.name;
                    option.selected = true;
                    select.appendChild(option);
                    select.value = currentBarber.id; // Explicitly set the value
                    select.disabled = true; // Disable the dropdown since there's only one option
                }
            } else {
                // Add "Select barber" option for day view
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = isZh ? '选择理发师...' : 'Choose a barber...';
                select.appendChild(defaultOption);

                // Add all barber options
                barbers.forEach(barber => {
                    const option = document.createElement('option');
                    option.value = barber.id;
                    option.textContent = barber.name;
                    select.appendChild(option);
                });

                select.disabled = false; // Enable the dropdown

                // Pre-select if we have a barberId (from clicking on a specific barber's column in day view)
                if (selectedBarberId) {
                    select.value = selectedBarberId;
                }
            }
        }

        function populateOwnerServiceDropdown() {
            const select = document.getElementById('owner-booking-service');
            const services = SharedData.getServices();

            // Clear existing options except first and last
            while (select.options.length > 2) {
                select.remove(1);
            }

            // Add service options
            Object.keys(services).forEach(serviceId => {
                if (services[serviceId].enabled) {
                    const option = document.createElement('option');
                    option.value = serviceId;
                    option.textContent = translateServiceName(services[serviceId].name);
                    select.insertBefore(option, select.lastElementChild);
                }
            });
        }

        function onOwnerServiceChange() {
            const serviceId = document.getElementById('owner-booking-service').value;
            const endTimeInput = document.getElementById('owner-booking-end');
            const summaryDiv = document.getElementById('booking-summary');
            const customerSection = document.getElementById('customer-info-section');
            const singleDateSection = document.getElementById('date-single-section');
            const dateRangeSection = document.getElementById('date-range-section');

            if (serviceId === 'custom') {
                // Custom booking - show date range and allow manual end time entry
                singleDateSection.style.display = 'none';
                dateRangeSection.style.display = 'block';

                // Copy single date to start date if switching to custom
                const singleDate = document.getElementById('owner-booking-date').value;
                if (singleDate) {
                    document.getElementById('owner-booking-start-date').value = singleDate;
                    document.getElementById('owner-booking-end-date').value = singleDate;
                }

                endTimeInput.removeAttribute('readonly');
                summaryDiv.style.display = 'none';
                // For custom bookings, name field becomes optional
                document.getElementById('label-customer-name').textContent = isZh ? '客户姓名（可选）' : 'Customer Name (Optional)';
            } else if (serviceId) {
                // Regular service selected - show single date
                singleDateSection.style.display = 'block';
                dateRangeSection.style.display = 'none';

                const services = SharedData.getServices();
                const service = services[serviceId];

                if (service) {
                    // Calculate end time based on service duration
                    updateEndTimeForService(service.duration);
                    endTimeInput.setAttribute('readonly', 'readonly');

                    // Show summary
                    document.getElementById('summary-service').textContent = translateServiceName(service.name);
                    document.getElementById('summary-duration').textContent = `${service.duration} ${isZh ? '分钟' : 'minutes'}`;
                    summaryDiv.style.display = 'block';
                }

                // Make name required for regular bookings
                document.getElementById('label-customer-name').textContent = isZh ? '客户姓名 *' : 'Customer Name *';
            } else {
                // No service selected - show single date
                singleDateSection.style.display = 'block';
                dateRangeSection.style.display = 'none';
                endTimeInput.setAttribute('readonly', 'readonly');
                summaryDiv.style.display = 'none';
            }
        }

        // formatTimeWithAMPM removed - using native HTML5 time input display

        // Time display function removed - using native HTML5 time input display

        function updateEndTimeForService(duration) {
            const startTime = document.getElementById('owner-booking-start').value;
            if (startTime && duration) {
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const totalMinutes = startHour * 60 + startMinute + duration;
                const endHour = Math.floor(totalMinutes / 60);
                const endMinute = totalMinutes % 60;
                document.getElementById('owner-booking-end').value =
                    `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
            }
        }

        function onOwnerStartTimeChange() {
            const serviceId = document.getElementById('owner-booking-service').value;

            // If a regular service is selected, update the end time
            if (serviceId && serviceId !== 'custom') {
                const services = SharedData.getServices();
                const service = services[serviceId];
                if (service) {
                    updateEndTimeForService(service.duration);
                }
            }
        }

        function closeOwnerBookingModal() {
            document.getElementById('owner-booking-modal').style.display = 'none';
        }

        function confirmOwnerBooking() {
            const barberId = document.getElementById('owner-booking-barber').value;
            const serviceId = document.getElementById('owner-booking-service').value;
            const customerName = document.getElementById('owner-booking-name').value.trim();
            const phone = document.getElementById('owner-booking-phone').value.trim();
            const email = document.getElementById('owner-booking-email').value.trim();
            const date = document.getElementById('owner-booking-date').value;
            const startTime = document.getElementById('owner-booking-start').value;
            const endTime = document.getElementById('owner-booking-end').value;

            // Validation
            if (!barberId) {
                alert(isZh ? '请选择理发师' : 'Please select a barber');
                return;
            }

            if (!serviceId) {
                alert(isZh ? '请选择服务' : 'Please select a service');
                return;
            }

            if (serviceId !== 'custom' && !customerName) {
                alert(isZh ? '请输入客户姓名' : 'Please enter customer name');
                return;
            }

            if (serviceId !== 'custom' && (!date || !startTime || !endTime)) {
                alert(isZh ? '请填写日期和时间' : 'Please fill in date and time');
                return;
            }

            // No booking limits for owners - they can book any date

            // Check for conflicts
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);
            const startMinutes = startHour * 60 + startMinute;
            const endMinutes = endHour * 60 + endMinute;

            if (endMinutes <= startMinutes) {
                alert(isZh ? '结束时间必须晚于开始时间' : 'End time must be after start time');
                return;
            }

            if (serviceId === 'custom') {
                // Get date range for custom bookings
                const startDate = document.getElementById('owner-booking-start-date').value;
                const endDate = document.getElementById('owner-booking-end-date').value;

                if (!startDate || !endDate) {
                    alert(isZh ? '请选择开始和结束日期' : 'Please select start and end dates');
                    return;
                }

                // Check that end date is not before start date
                if (new Date(endDate) < new Date(startDate)) {
                    alert(isZh ? '结束日期不能早于开始日期' : 'End date cannot be before start date');
                    return;
                }

                // Create blocked time entries for the date range
                const currentDate = new Date(startDate);
                const lastDate = new Date(endDate);
                const duration = endMinutes - startMinutes;
                let hasAnyConflict = false;
                const blocksToCreate = [];

                // Check each day in the range for conflicts
                while (currentDate <= lastDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];

                    // Check for conflicts for this specific barber
                    const hasConflict = checkNewAppointmentConflict(dateStr, startTime, duration, null, barberId);
                    if (hasConflict) {
                        hasAnyConflict = true;
                        const conflictDateStr = currentDate.toLocaleDateString();
                        alert(isZh ? `${conflictDateStr} 的时间段与现有预约或屏蔽时间冲突` : `Time slot on ${conflictDateStr} conflicts with an existing appointment or blocked time`);
                        break;
                    }

                    blocksToCreate.push({
                        date: dateStr,
                        startTime: startTime,
                        endTime: endTime,
                        barberId: barberId,
                        reason: customerName || 'Blocked by owner'
                    });

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // If no conflicts, save all blocked times
                if (!hasAnyConflict) {
                    blocksToCreate.forEach(block => {
                        SharedData.saveBlockedTime(block);
                    });
                }
            } else {
                // Create a regular appointment
                const services = SharedData.getServices();
                const service = services[serviceId];

                if (!service) {
                    alert(isZh ? '无效的服务' : 'Invalid service');
                    return;
                }

                // Check for conflicts with existing appointments for this specific barber
                const duration = (endMinutes - startMinutes);
                const hasConflict = checkNewAppointmentConflict(date, startTime, duration, service.activePeriods || null, barberId);
                if (hasConflict) {
                    alert(isZh ? '该时间段与现有预约冲突' : 'This time slot conflicts with an existing appointment');
                    return;
                }

                // Create appointment object
                // Use actual duration from the time range selected, not service duration
                const actualDuration = endMinutes - startMinutes;
                const appointment = {
                    id: 'APT' + Date.now(),
                    customerName: customerName,
                    customerPhone: phone,
                    customerEmail: email,
                    barberId: barberId,
                    date: date,
                    time: startTime,
                    services: [serviceId],
                    serviceNames: [service.name],
                    totalDuration: actualDuration, // Use the actual duration based on start/end times
                    totalPrice: service.price,
                    createdBy: 'owner',
                    createdAt: new Date().toISOString()
                };

                // Only add activePeriods if they exist and have content
                if (service.activePeriods && service.activePeriods.length > 0) {
                    appointment.activePeriods = service.activePeriods;
                }

                SharedData.saveAppointment(appointment);

                // Send confirmation email if customer email is provided
                if (appointment.customerEmail) {
                    SharedData.sendConfirmationEmail(appointment);
                }
            }

            // Close modal and refresh calendar
            closeOwnerBookingModal();
            generateWeeklyCalendar();
            loadAppointments();
            updateDashboardMetrics();
        }

        function showBlockedTimeDetails(block) {
            // Create a temporary appointment-like object for the modal
            const blockAsAppointment = {
                id: block.id,
                customerName: block.reason || 'Blocked Time',
                customerPhone: '',
                customerEmail: '',
                date: block.date,
                time: block.startTime,
                endTime: block.endTime,
                services: [],
                serviceNames: ['Blocked'],
                totalDuration: SharedData.timeToMinutes(block.endTime) - SharedData.timeToMinutes(block.startTime),
                totalPrice: 0,
                isBlocked: true
            };

            currentAppointment = blockAsAppointment;

            // Populate modal with blocked time details
            document.getElementById('modal-customer-name').textContent = block.reason || (isZh ? '屏蔽时间' : 'Blocked Time');
            document.getElementById('modal-services').textContent = isZh ? '屏蔽时间' : 'Blocked Time';

            // Format date and time
            const [year, month, day] = block.date.split('-').map(Number);
            const aptDate = new Date(year, month - 1, day);
            const dateStr = isZh ?
                `${aptDate.getFullYear()}年${aptDate.getMonth() + 1}月${aptDate.getDate()}日` :
                aptDate.toLocaleDateString();
            document.getElementById('modal-datetime').textContent = `${dateStr} ${block.startTime} - ${block.endTime}`;

            // Calculate and display duration
            const duration = SharedData.timeToMinutes(block.endTime) - SharedData.timeToMinutes(block.startTime);
            document.getElementById('modal-duration').textContent = `${duration} ${isZh ? '分钟' : 'minutes'}`;

            document.getElementById('modal-price').textContent = '-';
            document.getElementById('modal-phone').textContent = '-';
            document.getElementById('modal-email').textContent = '-';

            // Show modal (use the same method as regular appointments)
            document.getElementById('appointment-modal').classList.add('active');
        }

        function showAppointmentDetails(apt) {
            currentAppointment = apt;

            // Populate modal with appointment details
            document.getElementById('modal-customer-name').textContent = apt.customerName || 'Guest';
            const translatedServices = apt.serviceNames.map(name => translateServiceName(name));
            document.getElementById('modal-services').textContent = translatedServices.join(', ');

            // Add barber name
            document.getElementById('modal-barber').textContent = apt.barberName || 'Staff';

            // Format date and time without timezone shift
            const [year, month, day] = apt.date.split('-').map(Number);
            const aptDate = new Date(year, month - 1, day);
            const dateStr = aptDate.toLocaleDateString(isZh ? 'zh-CN' : 'en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = SharedData.formatTime(apt.time) || apt.time;
            document.getElementById('modal-datetime').textContent = `${dateStr} at ${timeStr}`;

            document.getElementById('modal-duration').textContent = `${apt.totalDuration} ${isZh ? '分钟' : 'minutes'}`;
            document.getElementById('modal-price').textContent = '$' + apt.totalPrice;
            document.getElementById('modal-phone').textContent = apt.customerPhone || 'Not provided';
            document.getElementById('modal-email').textContent = apt.customerEmail || 'Not provided';

            // Update modal labels
            document.getElementById('modal-title').textContent = isZh ? '预约详情' : 'Appointment Details';
            document.getElementById('label-customer').textContent = isZh ? '客户' : 'Customer';
            document.getElementById('label-services').textContent = isZh ? '服务项目' : 'Services';
            document.getElementById('label-barber').textContent = isZh ? '理发师' : 'Barber';
            document.getElementById('label-datetime').textContent = isZh ? '日期时间' : 'Date & Time';
            document.getElementById('label-duration').textContent = isZh ? '时长' : 'Duration';
            document.getElementById('label-price').textContent = isZh ? '价格' : 'Price';
            document.getElementById('label-contact').textContent = isZh ? '联系方式' : 'Contact';
            document.getElementById('btn-reschedule').textContent = isZh ? '重新安排' : 'Reschedule';
            document.getElementById('btn-cancel').textContent = isZh ? '取消' : 'Cancel';

            // Show modal
            document.getElementById('appointment-modal').classList.add('active');
        }

        function closeModal() {
            // Restore original modal structure if needed
            const modalContent = document.querySelector('#appointment-modal .modal-content');
            if (!modalContent.querySelector('#modal-customer-name')) {
                // Rebuild the original modal structure
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h3 id="modal-title">Appointment Details</h3>
                        <button class="modal-close" onclick="closeModal()">×</button>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label" id="label-customer">Customer</div>
                        <div class="detail-value" id="modal-customer-name"></div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label" id="label-services">Services</div>
                        <div class="detail-value" id="modal-services"></div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label" id="label-barber">Barber</div>
                        <div class="detail-value" id="modal-barber"></div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label" id="label-datetime">Date & Time</div>
                        <div class="detail-value" id="modal-datetime"></div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label" id="label-duration">Duration</div>
                        <div class="detail-value" id="modal-duration"></div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label" id="label-price">Price</div>
                        <div class="detail-value" id="modal-price"></div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-label" id="label-contact">Contact</div>
                        <div class="detail-value" id="modal-phone"></div>
                        <div class="detail-value" id="modal-email"></div>
                    </div>

                    <div class="modal-actions">
                        <button class="modal-btn reschedule" id="btn-reschedule" onclick="rescheduleAppointment()">Reschedule</button>
                        <button class="modal-btn cancel" id="btn-cancel" onclick="cancelAppointment()">Cancel</button>
                    </div>
                `;
            }

            document.getElementById('appointment-modal').classList.remove('active');
            currentAppointment = null;
            window.originalModalContent = null;
        }

        function rescheduleAppointment() {
            if (!currentAppointment) return;

            // Store the original modal content
            const originalContent = document.querySelector('#appointment-modal .modal-content').innerHTML;

            // Create reschedule modal HTML
            const rescheduleHtml = `
                <div style="padding: 10px;">
                    <h4>${isZh ? '选择新时间' : 'Select New Time'}</h4>
                    <div style="margin: 15px 0;">
                        <label>${isZh ? '日期' : 'Date'}:</label>
                        <input type="date" id="reschedule-date" style="width: 100%; padding: 8px; margin-top: 5px;"
                            min="${new Date().toISOString().split('T')[0]}"
                            value="${currentAppointment.date}">
                    </div>
                    <div style="margin: 15px 0;">
                        <label>${isZh ? '时间' : 'Time'}:</label>
                        <input type="time" id="reschedule-time" style="width: 100%; padding: 8px; margin-top: 5px;"
                            value="${currentAppointment.time}">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="confirmReschedule()" style="flex: 1; padding: 10px; background: #4A90E2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ${isZh ? '确认' : 'Confirm'}
                        </button>
                        <button onclick="restoreModalContent()" style="flex: 1; padding: 10px; background: #ccc; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ${isZh ? '取消' : 'Cancel'}
                        </button>
                    </div>
                </div>
            `;

            // Store original content for restoration
            window.originalModalContent = originalContent;

            // Update modal content
            document.querySelector('#appointment-modal .modal-content').innerHTML = rescheduleHtml;
        }

        function restoreModalContent() {
            if (window.originalModalContent) {
                document.querySelector('#appointment-modal .modal-content').innerHTML = window.originalModalContent;
                window.originalModalContent = null;
            } else {
                closeModal();
            }
        }

        window.restoreModalContent = restoreModalContent;

        window.confirmReschedule = function() {
            const newDate = document.getElementById('reschedule-date').value;
            const newTime = document.getElementById('reschedule-time').value;

            if (!newDate || !newTime) {
                alert(isZh ? '请选择日期和时间' : 'Please select both date and time');
                return;
            }

            if (currentAppointment) {
                // Handle blocked time rescheduling
                if (currentAppointment.isBlocked) {
                    // Calculate duration
                    const startMinutes = SharedData.timeToMinutes(currentAppointment.time);
                    const endMinutes = SharedData.timeToMinutes(currentAppointment.endTime);
                    const duration = endMinutes - startMinutes;

                    // Calculate new end time
                    const [newHour, newMin] = newTime.split(':').map(Number);
                    const newStartMinutes = newHour * 60 + newMin;
                    const newEndMinutes = newStartMinutes + duration;
                    const newEndHour = Math.floor(newEndMinutes / 60);
                    const newEndMinute = newEndMinutes % 60;
                    const newEndTime = `${newEndHour.toString().padStart(2, '0')}:${newEndMinute.toString().padStart(2, '0')}`;

                    // Check for conflicts
                    const hasConflict = checkNewAppointmentConflict(newDate, newTime, duration, null);
                    if (hasConflict) {
                        alert(isZh ? '该时间段与现有预约或屏蔽时间冲突' : 'This time conflicts with an existing appointment or blocked time');
                        return;
                    }

                    // Update blocked time
                    SharedData.deleteBlockedTime(currentAppointment.id);
                    SharedData.saveBlockedTime({
                        date: newDate,
                        startTime: newTime,
                        endTime: newEndTime,
                        reason: currentAppointment.customerName === 'Blocked Time' ? 'Blocked by owner' : currentAppointment.customerName
                    });

                    alert(isZh ? '屏蔽时间已重新安排' : 'Blocked time has been rescheduled');
                    closeModal();
                    generateWeeklyCalendar();
                    loadAppointments();
                    return;
                }
                // Check for conflicts when rescheduling appointments
                const hasConflict = checkAppointmentConflict(currentAppointment.id, newDate, newTime, currentAppointment.totalDuration);
                if (hasConflict) {
                    alert(isZh ? '该时间段与现有预约或屏蔽时间冲突' : 'This time conflicts with an existing appointment or blocked time');
                    return;
                }

                // Update appointment
                const appointments = SharedData.getAppointments();
                const index = appointments.findIndex(apt => apt.id === currentAppointment.id);

                if (index !== -1) {
                    // Store old appointment details for the email
                    const oldAppointment = {...appointments[index]};

                    appointments[index].date = newDate;
                    appointments[index].time = newTime;
                    localStorage.setItem('appointments', JSON.stringify(appointments));

                    // Send reschedule email if customer has email
                    if (appointments[index].customerEmail) {
                        SharedData.sendRescheduledEmail(appointments[index], oldAppointment);
                    }

                    // Trigger storage event
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: 'appointments',
                        newValue: JSON.stringify(appointments),
                        url: window.location.href
                    }));

                    alert(isZh ? '预约已重新安排' : 'Appointment has been rescheduled');
                    closeModal();
                    generateWeeklyCalendar();
                    loadAppointments();
                }
            }
        }

        function cancelAppointment() {
            if (!currentAppointment) return;

            // Handle blocked time
            if (currentAppointment.isBlocked) {
                if (confirm(isZh ? '确定要删除这个屏蔽时间吗？' : 'Are you sure you want to delete this blocked time?')) {
                    SharedData.deleteBlockedTime(currentAppointment.id);
                    closeModal();
                    generateWeeklyCalendar();
                    loadAppointments();
                }
            } else {
                if (confirm(isZh ? '确定要取消这个预约吗？' : 'Are you sure you want to cancel this appointment?')) {
                    // Send cancellation email before deleting if customer has email
                    if (currentAppointment.customerEmail) {
                        SharedData.sendCancellationEmail(currentAppointment);
                    }
                    SharedData.deleteAppointment(currentAppointment.id);
                    closeModal();
                    generateWeeklyCalendar();
                    loadAppointments();
                }
            }
        }

        function deleteAppointment(appointmentId) {
            if (confirm(isZh ? '确定要取消这个预约吗？' : 'Are you sure you want to cancel this appointment?')) {
                // Get the appointment details before deleting
                const appointment = SharedData.getAppointmentById(appointmentId);
                if (appointment && appointment.customerEmail) {
                    SharedData.sendCancellationEmail(appointment);
                }
                SharedData.deleteAppointment(appointmentId);
                loadAppointments();
            }
        }


        // Staff Management Variables
        window.currentBarberId = 'owner';
        let barbers = [];

        // Calendar and Dashboard barber selection
        let calendarBarberId = '';  // Empty string means all staff
        let dashboardBarberId = '';  // Empty string means all staff
        let calendarViewMode = 'week';  // 'week' or 'day'

        // Initialize and load staff
        function initializeStaff() {
            barbers = SharedData.getBarbers();
            renderStaffTabs();
            selectBarber('owner');
            populateBarberSelectors();  // Populate calendar and dashboard dropdowns

            // Set initial calendar view to day view for "All Staff"
            if (calendarBarberId === '') {
                calendarViewMode = 'day';
            }
        }

        // Populate barber selectors for calendar and dashboard
        function populateBarberSelectors() {
            const calendarSelect = document.getElementById('calendar-barber-select');
            const dashboardSelect = document.getElementById('dashboard-barber-select');

            const t = isZh ? translations.zh : translations.en;

            // Ensure barbers array is initialized
            if (barbers.length === 0) {
                barbers = SharedData.getBarbers();
            }

            // Preserve current selections before rebuilding
            const currentCalendarValue = calendarSelect ? calendarSelect.value : '';
            const currentDashboardValue = dashboardSelect ? dashboardSelect.value : '';

            if (calendarSelect) {
                // Clear and rebuild options
                calendarSelect.innerHTML = '';

                // Add "All Staff" option
                const allStaffOption = document.createElement('option');
                allStaffOption.value = '';
                allStaffOption.textContent = t.allStaff;
                calendarSelect.appendChild(allStaffOption);

                // Add barber options
                barbers.forEach(barber => {
                    const option = document.createElement('option');
                    option.value = barber.id;
                    option.textContent = barber.name;
                    calendarSelect.appendChild(option);
                });

                // Restore previous selection
                calendarSelect.value = currentCalendarValue;
            }

            if (dashboardSelect) {
                // Clear and rebuild options
                dashboardSelect.innerHTML = '';

                // Add "All Staff" option
                const allStaffOption = document.createElement('option');
                allStaffOption.value = '';
                allStaffOption.textContent = t.allStaff;
                dashboardSelect.appendChild(allStaffOption);

                // Add barber options
                barbers.forEach(barber => {
                    const option = document.createElement('option');
                    option.value = barber.id;
                    option.textContent = barber.name;
                    dashboardSelect.appendChild(option);
                });

                // Restore previous selection
                dashboardSelect.value = currentDashboardValue;
            }
        }

        // Calendar barber selection
        function selectCalendarBarber(barberId) {
            calendarBarberId = barberId;

            // Switch to day view for "All Staff", week view for individual barbers
            if (barberId === '') {
                calendarViewMode = 'day';
                generateDayViewCalendar();  // New function for day view with staff columns
            } else {
                calendarViewMode = 'week';
                generateWeeklyCalendar();
            }
        }

        // Dashboard barber selection
        function selectDashboardBarber(barberId) {
            dashboardBarberId = barberId;
            updateDashboardMetrics();
        }

        // Render staff list
        function renderStaffTabs() {
            // First try to render in the new staff-list container
            let container = document.getElementById('staff-list');

            // Fall back to old staff-tabs if new container doesn't exist yet
            if (!container) {
                container = document.getElementById('staff-tabs');
            }

            if (!container) return;

            container.innerHTML = '';

            // If using the new staff-list layout
            if (container.id === 'staff-list') {
                barbers.forEach(barber => {
                    const item = document.createElement('div');
                    item.className = 'staff-item';
                    if (barber.id === window.currentBarberId) {
                        item.classList.add('active');
                    }

                    item.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <div style="width: 40px; height: 40px; background: #E3F2FD; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                <span style="font-size: 20px;">👤</span>
                            </div>
                            <div>
                                <div style="font-weight: bold; font-size: 16px;">${barber.name}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${!barber.isOwner ? `<button onclick="deleteStaff('${barber.id}'); event.stopPropagation();" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 12px;">Delete</button>` : ''}
                            <span style="color: #999; font-size: 20px;">›</span>
                        </div>
                    `;

                    item.onclick = () => {
                        selectBarber(barber.id);
                        // Show the configuration section
                        const configSection = document.getElementById('current-staff-config');
                        if (configSection) {
                            configSection.style.display = 'block';
                        }
                    };

                    container.appendChild(item);
                });
            }
            // Old tab layout (fallback)
            else {
                barbers.forEach(barber => {
                    const tab = document.createElement('div');
                    tab.style.cssText = `
                        padding: 10px 15px;
                        background: ${barber.id === window.currentBarberId ? '#2196F3' : '#f0f0f0'};
                        color: ${barber.id === window.currentBarberId ? 'white' : '#333'};
                        border-radius: 5px;
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        gap: 10px;
                    `;

                    tab.innerHTML = `
                        <span>${barber.name}</span>
                        ${!barber.isOwner ? `<button onclick="deleteStaff('${barber.id}'); event.stopPropagation();" style="background: #ff4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 12px;">×</button>` : ''}
                    `;

                    tab.onclick = () => selectBarber(barber.id);
                    container.appendChild(tab);
                });
            }
        }

            // Back to staff list
            function backToStaffList() {
                const staffList = document.getElementById('staff-list-section');
                const configHeader = document.getElementById('current-staff-config');
                const configContainer = document.getElementById('services-config-container');

                if (staffList) staffList.style.display = 'block';
                if (configHeader) configHeader.style.display = 'none';
                if (configContainer) configContainer.style.display = 'none';
            }

            // Select a barber
            function selectBarber(barberId) {
                window.currentBarberId = barberId;
                const barber = SharedData.getBarberById(barberId);

                // Update UI
                document.getElementById('selected-staff-name').textContent = barber.name;
                renderStaffTabs();

                // Hide staff list and show configuration sections
                const staffList = document.getElementById('staff-list-section');
                const configHeader = document.getElementById('current-staff-config');
                const configContainer = document.getElementById('services-config-container');

                if (staffList) staffList.style.display = 'none';
                if (configHeader) configHeader.style.display = 'block';
                if (configContainer) configContainer.style.display = 'block';

                // Show "Same as store hours?" checkbox for everyone
                const sameAsStoreContainer = document.getElementById('same-as-store-hours-container');
                if (sameAsStoreContainer) {
                    sameAsStoreContainer.style.display = 'block';
                    // Check if this barber uses store hours
                    const checkbox = document.getElementById('same-as-store-hours');
                    if (checkbox && barber.usesStoreHours) {
                        checkbox.checked = true;
                    } else if (checkbox) {
                        checkbox.checked = false;
                    }
                }

                // Load this barber's services and hours
                loadServicesForBarber(barberId);
                loadHoursForBarber(barberId);
            }

            // Add new staff
            function addNewStaff() {
                const name = prompt('Enter staff member name:');
                if (!name) return;

                // Ask if they want to copy settings
                const copyOptions = ['Start with default settings'];
                barbers.forEach(b => {
                    copyOptions.push(`Copy from ${b.name}`);
                });

                const choice = confirm(`Copy settings from another staff member?\nOK = Choose who to copy from\nCancel = Start with defaults`);

                let copyFromId = null;
                if (choice && barbers.length > 0) {
                    const copyFrom = prompt(`Copy settings from:\n${barbers.map((b, i) => `${i+1}. ${b.name}`).join('\n')}\n\nEnter number:`);
                    if (copyFrom && parseInt(copyFrom) > 0 && parseInt(copyFrom) <= barbers.length) {
                        copyFromId = barbers[parseInt(copyFrom) - 1].id;
                    }
                }

                const newBarberId = SharedData.addBarber(name, copyFromId);
                barbers = SharedData.getBarbers();
                renderStaffTabs();
                populateBarberSelectors();  // Update dropdowns
                selectBarber(newBarberId);
            }

            // Delete staff
            function deleteStaff(barberId) {
                if (confirm('Delete this staff member? Their configuration will be lost.')) {
                    SharedData.deleteBarber(barberId);
                    barbers = SharedData.getBarbers();
                    renderStaffTabs();
                    populateBarberSelectors();  // Update dropdowns
                    selectBarber('owner');
                }
            }

            // Load services for specific barber
            function loadServicesForBarber(barberId) {
                const barber = SharedData.getBarberById(barberId);
                if (!barber) return;

                // Update the existing loadServices function to use barber's services
                window.currentBarberServices = barber.services || {};
                loadServices();
            }

            // Load hours for specific barber
            function loadHoursForBarber(barberId) {
                const barber = SharedData.getBarberById(barberId);
                if (!barber) return;

                // Check if barber uses store hours
                const checkbox = document.getElementById('same-as-store-hours');
                if (checkbox && barber.usesStoreHours) {
                    checkbox.checked = true;
                    // Trigger to apply store hours
                    toggleSameAsStoreHours();
                } else {
                    // Update the existing loadStoreHours function to use barber's hours
                    window.currentBarberHours = barber.hours || {};
                    loadStoreHours();
                }
            }

            // Override saveServices to save to current barber
            const originalSaveServices = window.saveServices;
            window.saveServices = function() {
                if (window.currentBarberId && window.currentBarberId !== 'owner') {
                    // Save to specific barber
                    const services = {};
                    document.querySelectorAll('.service-item').forEach(item => {
                        const serviceId = item.getAttribute('data-service');
                        const nameInput = item.querySelector('.service-name-input');
                        const durationInput = item.querySelector('.service-duration');
                        const priceInput = item.querySelector('.service-price');
                        const toggle = item.querySelector('.toggle-switch');
                        const hasActiveTime = item.querySelector('.active-time-toggle')?.checked || false;

                        services[serviceId] = {
                            name: nameInput.value,
                            duration: parseInt(durationInput.value),
                            price: parseFloat(priceInput.value),
                            enabled: toggle.classList.contains('active'),
                            hasActiveTime: hasActiveTime
                        };

                        if (hasActiveTime) {
                            const periods = [];
                            item.querySelectorAll(`#periods-${serviceId} .active-period-item`).forEach(periodItem => {
                                const start = parseInt(periodItem.querySelector('.period-start').value);
                                const end = parseInt(periodItem.querySelector('.period-end').value);
                                periods.push({ start, end });
                            });
                            services[serviceId].activePeriods = periods;
                        }
                    });

                    SharedData.updateBarber(window.currentBarberId, { services });
                } else {
                    // Save to main store services (owner)
                    originalSaveServices();
                    // Also update owner barber
                    const services = SharedData.getServices();
                    SharedData.updateBarber('owner', { services });
                }
            };

            // Note: saveStoreHours function already handles saving for both owner and staff
            // with proper validation and feedback, so no override is needed

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateLanguage();
                // Don't generate calendar on page load - only when calendar tab is clicked
                setupSwipeNavigation();
                initializeStaff();  // Initialize staff management
                loadStoreHours();
                loadServices();
                loadAppointments();

                // Delay dashboard update to ensure DOM and data are ready
                setTimeout(() => {
                    updateDashboardMetrics();
                }, 100);
            });
        } else {
            // DOM is already loaded
            updateLanguage();
            // Don't generate calendar on page load - only when calendar tab is clicked
            setupSwipeNavigation();
            initializeStaff();  // Initialize staff management
            loadStoreHours();
            loadServices();
            loadAppointments();

            // Delay dashboard update to ensure DOM and data are ready
            setTimeout(() => {
                updateDashboardMetrics();
            }, 100);
        }

        // Listen for changes from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === 'storeHours') {
                loadStoreHours();
                updateDashboardMetrics();
            } else if (e.key === 'services') {
                // Only reload if changed from another tab (not this one)
                if (e.storageArea !== localStorage) {
                    loadServices();
                }
                updateDashboardMetrics();
            } else if (e.key === 'appointments' || e.key === 'blockedTimes') {
                // Just reload appointments, not services
                loadAppointments();
                updateDashboardMetrics();
                if (document.getElementById('calendar-section').classList.contains('active')) {
                    generateWeeklyCalendar();
                }
            }
        });

        // Auto-refresh appointments and dashboard every 5 seconds
        setInterval(() => {
            loadAppointments();
            updateDashboardMetrics();
            if (document.getElementById('calendar-section').classList.contains('active')) {
                // Refresh appropriate calendar view based on current mode
                if (calendarViewMode === 'day') {
                    generateDayViewCalendar();
                } else {
                    generateWeeklyCalendar();
                }
            }
        }, 5000);
    </script>
</body>
</html>