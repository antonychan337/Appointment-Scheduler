<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Slug Column to Shops Table</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 20px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #357ABD;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Add Slug Column to Shops Table</h1>

    <div id="status"></div>

    <button onclick="checkColumn()">Check if Slug Column Exists</button>
    <button onclick="addSlugColumn()">Add Slug Column</button>
    <button onclick="generateSlugsForExistingShops()">Generate Slugs for Existing Shops</button>

    <div id="output"></div>

    <script>
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function showOutput(data) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }

        async function checkColumn() {
            try {
                showStatus('Checking column existence...', 'info');

                // Try to query the slug column
                const { data, error } = await supabaseClient
                    .from('shops')
                    .select('id, name, slug')
                    .limit(5);

                if (error) {
                    if (error.message.includes('slug')) {
                        showStatus('Slug column does not exist yet', 'error');
                        showOutput({ error: error.message, hint: 'Click "Add Slug Column" to create it' });
                    } else {
                        throw error;
                    }
                } else {
                    showStatus('Slug column exists!', 'success');
                    showOutput({ shops_with_slug: data });
                }
            } catch (error) {
                showStatus('Error checking column: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function addSlugColumn() {
            showStatus('Note: Column creation must be done in Supabase SQL Editor', 'info');

            const sql = `
-- Add the slug column to shops table
ALTER TABLE shops
ADD COLUMN IF NOT EXISTS slug TEXT UNIQUE;

-- Create an index on slug for faster lookups
CREATE INDEX IF NOT EXISTS idx_shops_slug ON shops(slug);

-- Add a comment to document the column
COMMENT ON COLUMN shops.slug IS 'Unique URL identifier for the shop booking page';`;

            showOutput({
                instructions: [
                    "1. Go to your Supabase project dashboard",
                    "2. Click on 'SQL Editor' in the left sidebar",
                    "3. Click 'New Query'",
                    "4. Copy and paste the SQL below",
                    "5. Click 'Run' to execute the migration"
                ],
                sql_to_run: sql
            });

            // Copy SQL to clipboard
            navigator.clipboard.writeText(sql).then(() => {
                showStatus('SQL copied to clipboard! Paste it in Supabase SQL Editor', 'success');
            });
        }

        async function generateSlugsForExistingShops() {
            try {
                showStatus('Loading shops...', 'info');

                // Get all shops without slugs
                const { data: shops, error } = await supabaseClient
                    .from('shops')
                    .select('id, name, slug')
                    .or('slug.is.null,slug.eq.""');

                if (error) throw error;

                if (!shops || shops.length === 0) {
                    showStatus('No shops need slug generation', 'success');
                    return;
                }

                showStatus(`Found ${shops.length} shops without slugs. Generating...`, 'info');

                const updates = [];
                const usedSlugs = new Set();

                // Get existing slugs to avoid duplicates
                const { data: existingSlugs } = await supabaseClient
                    .from('shops')
                    .select('slug')
                    .not('slug', 'is', null);

                if (existingSlugs) {
                    existingSlugs.forEach(shop => {
                        if (shop.slug) usedSlugs.add(shop.slug);
                    });
                }

                // Generate unique slugs
                for (const shop of shops) {
                    if (!shop.slug && shop.name) {
                        let baseSlug = shop.name
                            .toLowerCase()
                            .replace(/'/g, '')
                            .replace(/[^a-z0-9]+/g, '_')
                            .replace(/^_|_$/g, '');

                        let slug = baseSlug;
                        let counter = 1;

                        // Ensure uniqueness
                        while (usedSlugs.has(slug)) {
                            slug = `${baseSlug}_${counter}`;
                            counter++;
                        }

                        usedSlugs.add(slug);

                        // Update the shop
                        const { error: updateError } = await supabaseClient
                            .from('shops')
                            .update({ slug: slug })
                            .eq('id', shop.id);

                        if (updateError) {
                            console.error(`Failed to update shop ${shop.id}:`, updateError);
                            updates.push({ shop: shop.name, status: 'error', error: updateError.message });
                        } else {
                            updates.push({ shop: shop.name, slug: slug, status: 'success' });
                        }
                    }
                }

                showStatus(`Updated ${updates.filter(u => u.status === 'success').length} shops`, 'success');
                showOutput({ updates });

            } catch (error) {
                showStatus('Error generating slugs: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Check on load
        window.addEventListener('load', () => {
            checkColumn();
        });
    </script>
</body>
</html>