<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Check Barbers in Database</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-bridge.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
        }
        .box {
            background: white;
            border: 2px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Check Barbers in Database</h1>

    <div class="box">
        <h3>Shop Information:</h3>
        <pre id="shop-info">Loading...</pre>
    </div>

    <div class="box">
        <h3>Barbers in Database:</h3>
        <pre id="barbers-list">Loading...</pre>
    </div>

    <div class="box">
        <h3>Actions:</h3>
        <button onclick="createOwnerBarber()">Create Owner Barber</button>
        <button onclick="fixBarberStatus()">Fix Barber Active Status</button>
        <button onclick="refreshData()">Refresh Data</button>
    </div>

    <div id="status"></div>

    <script>
        async function checkBarbers() {
            const shopId = localStorage.getItem('supabase_shop_id');
            const shopInfoDiv = document.getElementById('shop-info');
            const barbersDiv = document.getElementById('barbers-list');

            if (!shopId) {
                shopInfoDiv.innerHTML = '<span class="error">No shop ID found!</span>';
                return;
            }

            shopInfoDiv.innerHTML = `Shop ID: ${shopId}\n`;

            try {
                // Get shop details
                const { data: shop, error: shopError } = await supabaseClient
                    .from('shops')
                    .select('*')
                    .eq('id', shopId)
                    .single();

                if (shop) {
                    shopInfoDiv.innerHTML += `Shop Name: ${shop.name}\n`;
                    shopInfoDiv.innerHTML += `Shop Email: ${shop.email}\n`;
                    shopInfoDiv.innerHTML += `Shop Slug: ${shop.slug || 'NOT SET'}\n`;
                }

                // Get ALL barbers (not just active ones)
                const { data: barbers, error } = await supabaseClient
                    .from('barbers')
                    .select('*')
                    .eq('shop_id', shopId);

                if (error) {
                    barbersDiv.innerHTML = `<span class="error">Error loading barbers: ${JSON.stringify(error)}</span>`;
                    return;
                }

                if (!barbers || barbers.length === 0) {
                    barbersDiv.innerHTML = '<span class="warning">NO BARBERS FOUND IN DATABASE!</span>\n';
                    barbersDiv.innerHTML += 'Click "Create Owner Barber" to add one.';
                    return;
                }

                barbersDiv.innerHTML = `Total barbers found: ${barbers.length}\n\n`;

                barbers.forEach(barber => {
                    const status = barber.is_active ? '✅ ACTIVE' : '❌ INACTIVE';
                    barbersDiv.innerHTML += `${status} - ${barber.name}\n`;
                    barbersDiv.innerHTML += `  ID: ${barber.id}\n`;
                    barbersDiv.innerHTML += `  Is Owner: ${barber.is_owner ? 'YES' : 'NO'}\n`;
                    barbersDiv.innerHTML += `  Created: ${new Date(barber.created_at).toLocaleString()}\n`;
                    barbersDiv.innerHTML += `  Services: ${barber.service_ids ? barber.service_ids.length + ' services' : 'None'}\n`;
                    barbersDiv.innerHTML += '\n';
                });

                // Check for active barbers
                const activeBarbers = barbers.filter(b => b.is_active);
                if (activeBarbers.length === 0) {
                    barbersDiv.innerHTML += '<span class="error">\n⚠️ WARNING: No active barbers!</span>\n';
                    barbersDiv.innerHTML += 'Customer app will not work without active barbers.\n';
                    barbersDiv.innerHTML += 'Click "Fix Barber Active Status" to activate all barbers.';
                }
            } catch (error) {
                barbersDiv.innerHTML = `<span class="error">Exception: ${error.message}</span>`;
            }
        }

        async function createOwnerBarber() {
            const shopId = localStorage.getItem('supabase_shop_id');
            const statusDiv = document.getElementById('status');

            if (!shopId) {
                statusDiv.innerHTML = '<div class="box error">No shop ID found!</div>';
                return;
            }

            try {
                // Get owner profile
                const ownerProfile = JSON.parse(localStorage.getItem('ownerProfile') || '{}');
                const ownerName = ownerProfile.firstName ?
                    `${ownerProfile.firstName} ${ownerProfile.lastName || ''}`.trim() :
                    'Owner';

                // Get services
                const { data: services } = await supabaseClient
                    .from('services')
                    .select('id')
                    .eq('shop_id', shopId);

                const serviceIds = services ? services.map(s => s.id) : [];

                // Create owner barber
                const { data, error } = await supabaseClient
                    .from('barbers')
                    .insert({
                        shop_id: shopId,
                        name: ownerName,
                        is_owner: true,
                        is_active: true,
                        service_ids: serviceIds,
                        uses_store_hours: true,
                        hours: {}
                    })
                    .select()
                    .single();

                if (error) {
                    statusDiv.innerHTML = `<div class="box error">Error creating barber: ${JSON.stringify(error)}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="box success">✅ Owner barber created successfully!</div>`;
                    setTimeout(checkBarbers, 1000);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="box error">Exception: ${error.message}</div>`;
            }
        }

        async function fixBarberStatus() {
            const shopId = localStorage.getItem('supabase_shop_id');
            const statusDiv = document.getElementById('status');

            if (!shopId) {
                statusDiv.innerHTML = '<div class="box error">No shop ID found!</div>';
                return;
            }

            try {
                // Update all barbers to be active
                const { error } = await supabaseClient
                    .from('barbers')
                    .update({ is_active: true })
                    .eq('shop_id', shopId);

                if (error) {
                    statusDiv.innerHTML = `<div class="box error">Error updating barbers: ${JSON.stringify(error)}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="box success">✅ All barbers set to active!</div>`;
                    setTimeout(checkBarbers, 1000);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="box error">Exception: ${error.message}</div>`;
            }
        }

        function refreshData() {
            location.reload();
        }

        // Check on load
        setTimeout(checkBarbers, 500);
    </script>
</body>
</html>