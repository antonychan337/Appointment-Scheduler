<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Store Hours</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-bridge.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .day-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .day-name {
            width: 100px;
            font-weight: bold;
        }
        .time-display {
            flex: 1;
        }
        .old-time {
            color: #f44336;
            text-decoration: line-through;
        }
        .new-time {
            color: #4CAF50;
            font-weight: bold;
        }
        button {
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 0;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        #status {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success {
            background: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724;
        }
        .error {
            background: #f8d7da !important;
            border-color: #f5c6cb !important;
            color: #721c24;
        }
        .warning {
            background: #fff3cd !important;
            border-color: #ffeeba !important;
            color: #856404;
        }
    </style>
</head>
<body>
    <h1>Fix Store Hours Issue</h1>
    <p>This will fix the store hours that are showing incorrect closing times (08:00 instead of 20:00, etc.)</p>

    <div id="status">Loading current store hours...</div>

    <h2>Current Store Hours</h2>
    <div id="current-hours"></div>

    <h2>Corrected Store Hours</h2>
    <div id="new-hours"></div>

    <button onclick="fixHours()">Fix Store Hours Now</button>

    <script>
        const status = document.getElementById('status');
        const currentHoursDiv = document.getElementById('current-hours');
        const newHoursDiv = document.getElementById('new-hours');

        const correctHours = {
            monday: { open: '09:00', close: '18:00', closed: false },
            tuesday: { open: '09:00', close: '18:00', closed: false },
            wednesday: { open: '09:00', close: '19:00', closed: false },  // 7 PM
            thursday: { open: '09:00', close: '20:00', closed: false },   // 8 PM
            friday: { open: '09:00', close: '21:00', closed: false },     // 9 PM
            saturday: { open: '10:00', close: '22:00', closed: false },   // 10 PM
            sunday: { open: '', close: '', closed: true }
        };

        async function loadCurrentHours() {
            try {
                await SharedData.initialize();
                await SharedData.loadStoreHours();
                const hours = SharedData.getStoreHours();

                console.log('Current store hours:', hours);

                // Display current hours
                currentHoursDiv.innerHTML = '';
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                days.forEach(day => {
                    const dayHours = hours[day] || { closed: true };
                    const div = document.createElement('div');
                    div.className = 'day-row';

                    if (dayHours.closed) {
                        div.innerHTML = `
                            <div class="day-name">${day.charAt(0).toUpperCase() + day.slice(1)}</div>
                            <div class="time-display">Closed</div>
                        `;
                    } else {
                        const closeTime = dayHours.close || '';
                        const isWrong = (day === 'thursday' && closeTime === '08:00') ||
                                       (day === 'friday' && closeTime === '09:00') ||
                                       (day === 'saturday' && closeTime === '10:00') ||
                                       (day === 'wednesday' && closeTime === '07:00');

                        div.innerHTML = `
                            <div class="day-name">${day.charAt(0).toUpperCase() + day.slice(1)}</div>
                            <div class="time-display ${isWrong ? 'old-time' : ''}">
                                ${dayHours.open} - ${closeTime}
                                ${isWrong ? ' ❌ INCORRECT' : ''}
                            </div>
                        `;
                    }
                    currentHoursDiv.appendChild(div);
                });

                // Display new hours
                newHoursDiv.innerHTML = '';
                days.forEach(day => {
                    const dayHours = correctHours[day];
                    const div = document.createElement('div');
                    div.className = 'day-row';

                    if (dayHours.closed) {
                        div.innerHTML = `
                            <div class="day-name">${day.charAt(0).toUpperCase() + day.slice(1)}</div>
                            <div class="time-display">Closed</div>
                        `;
                    } else {
                        div.innerHTML = `
                            <div class="day-name">${day.charAt(0).toUpperCase() + day.slice(1)}</div>
                            <div class="time-display new-time">
                                ${dayHours.open} - ${dayHours.close} ✓
                            </div>
                        `;
                    }
                    newHoursDiv.appendChild(div);
                });

                status.textContent = 'Store hours loaded. Review the changes below and click the button to apply the fix.';
                status.className = 'warning';

            } catch (error) {
                console.error('Error loading hours:', error);
                status.textContent = 'Error loading store hours: ' + error.message;
                status.className = 'error';
            }
        }

        async function fixHours() {
            status.textContent = 'Fixing store hours...';
            status.className = '';

            try {
                // Save the corrected hours
                await SharedData.saveStoreHours(correctHours);
                console.log('Store hours saved to database');

                // Also update the owner's hours if they exist
                const barbers = await SharedData.getBarbers();
                const owner = barbers.find(b => b.isOwner);
                if (owner) {
                    await SharedData.updateBarber(owner.id, {
                        hours: correctHours,
                        usesStoreHours: true
                    });
                    console.log('Owner hours updated');
                }

                // Clear and reload cache
                SharedData.storeHoursCache = null;
                await SharedData.loadStoreHours();

                // Verify the fix
                const verifiedHours = SharedData.getStoreHours();
                console.log('Verified hours after fix:', verifiedHours);

                let allCorrect = true;
                if (verifiedHours.thursday.close !== '20:00') allCorrect = false;
                if (verifiedHours.friday.close !== '21:00') allCorrect = false;
                if (verifiedHours.saturday.close !== '22:00') allCorrect = false;

                if (allCorrect) {
                    status.textContent = '✓ Store hours fixed successfully! Refresh the owner-app and customer-app to see the changes.';
                    status.className = 'success';
                } else {
                    status.textContent = 'Partial fix applied. Some hours may need manual adjustment.';
                    status.className = 'warning';
                }

                // Reload to show updated hours
                setTimeout(() => loadCurrentHours(), 2000);

            } catch (error) {
                console.error('Error fixing hours:', error);
                status.textContent = 'Error fixing store hours: ' + error.message;
                status.className = 'error';
            }
        }

        // Load on page load
        loadCurrentHours();
    </script>
</body>
</html>