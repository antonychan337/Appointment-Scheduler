<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Launch Customer App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-bridge.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            background: #2196F3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        button:hover {
            background: #1976D2;
        }
        .info {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #FFEBEE;
            color: #C62828;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Launch Customer App</h1>

    <div id="status" class="info">Checking shop configuration...</div>

    <button onclick="launchWithShopId()">Launch Customer App with Shop ID</button>
    <button onclick="launchWithSlug()">Launch Customer App with Slug (antonys_salon)</button>
    <button onclick="launchDirectly()">Launch Customer App Directly (No Parameters)</button>

    <div id="debug"></div>

    <script>
        async function checkShop() {
            const statusDiv = document.getElementById('status');
            const debugDiv = document.getElementById('debug');

            const shopId = localStorage.getItem('supabase_shop_id');
            const ownerProfile = JSON.parse(localStorage.getItem('ownerProfile') || '{}');

            let html = '<h3>Current Configuration:</h3><pre>';
            html += `Shop ID: ${shopId || 'NOT SET'}\n`;
            html += `Owner Name: ${ownerProfile.storeName || 'NOT SET'}\n`;
            html += `Booking Slug: ${ownerProfile.bookingSlug || 'NOT SET'}\n`;
            html += '</pre>';

            if (shopId && typeof supabaseClient !== 'undefined') {
                try {
                    // Check shop in database
                    const { data: shop, error } = await supabaseClient
                        .from('shops')
                        .select('*')
                        .eq('id', shopId)
                        .single();

                    if (!error && shop) {
                        html += '<h3>Shop in Database:</h3><pre>';
                        html += `Name: ${shop.name}\n`;
                        html += `Slug: ${shop.slug || 'NOT SET'}\n`;
                        html += `Email: ${shop.email}\n`;
                        html += '</pre>';

                        statusDiv.className = 'success';
                        statusDiv.innerHTML = `✅ Shop found: ${shop.name}`;

                        // Check barbers
                        const { data: barbers, error: barbersError } = await supabaseClient
                            .from('barbers')
                            .select('*')
                            .eq('shop_id', shopId)
                            .eq('is_active', true);

                        if (!barbersError && barbers) {
                            html += '<h3>Active Barbers:</h3><pre>';
                            if (barbers.length === 0) {
                                html += 'NO ACTIVE BARBERS FOUND!\n';
                                statusDiv.className = 'error';
                                statusDiv.innerHTML += '<br>⚠️ Warning: No active barbers in database!';
                            } else {
                                barbers.forEach(barber => {
                                    html += `- ${barber.name} (ID: ${barber.id})\n`;
                                });
                            }
                            html += '</pre>';
                        }
                    } else {
                        statusDiv.className = 'error';
                        statusDiv.innerHTML = `❌ Shop not found in database!`;
                    }
                } catch (error) {
                    statusDiv.className = 'error';
                    statusDiv.innerHTML = `❌ Error: ${error.message}`;
                }
            } else {
                statusDiv.className = 'error';
                statusDiv.innerHTML = '❌ No shop ID configured or Supabase not available';
            }

            debugDiv.innerHTML = html;
        }

        function launchWithShopId() {
            const shopId = localStorage.getItem('supabase_shop_id');
            if (!shopId) {
                alert('No shop ID found! Please complete setup first.');
                return;
            }

            // Set customer context
            localStorage.setItem('customer_shop_id', shopId);
            localStorage.setItem('customer_shop_slug', 'antonys_salon');

            // Launch customer app
            window.location.href = 'customer-app.html?shop=antonys_salon';
        }

        function launchWithSlug() {
            const shopId = localStorage.getItem('supabase_shop_id');

            // Set customer context
            if (shopId) {
                localStorage.setItem('customer_shop_id', shopId);
            }
            localStorage.setItem('customer_shop_slug', 'antonys_salon');
            localStorage.setItem('shopSlug', 'antonys_salon');

            // Launch customer app with slug
            window.location.href = 'customer-app.html?shop=antonys_salon';
        }

        function launchDirectly() {
            // Clear customer-specific settings to test direct access
            localStorage.removeItem('customer_shop_id');
            localStorage.removeItem('customer_shop_slug');
            localStorage.removeItem('shopSlug');

            // Launch customer app without parameters (will use supabase_shop_id if available)
            window.location.href = 'customer-app.html';
        }

        // Check shop on load
        setTimeout(checkShop, 500);
    </script>
</body>
</html>