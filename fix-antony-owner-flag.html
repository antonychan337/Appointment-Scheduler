<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Antony Owner Flag</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration -->
    <script src="supabase-config.js"></script>
    <!-- Supabase Bridge -->
    <script src="supabase-bridge.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2C3E50;
        }
        .barber-card {
            margin: 15px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        .barber-name {
            font-weight: bold;
            font-size: 20px;
            color: #2C3E50;
            margin-bottom: 15px;
        }
        .property {
            margin: 8px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .property-label {
            font-weight: 600;
            color: #666;
        }
        .true {
            color: #4caf50;
            font-weight: bold;
        }
        .false {
            color: #f44336;
            font-weight: bold;
        }
        .problem {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        button {
            background: #2C3E50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #34495e;
        }
        .fix-button {
            background: #f44336;
        }
        .fix-button:hover {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Staff Owner Flags</h1>

        <button onclick="checkAllBarbers()">Check All Staff Members</button>
        <button onclick="fixAllNonOwners()">Fix All Non-Owners</button>

        <div id="results"></div>
    </div>

    <script>
        async function initialize() {
            await SharedData.initialize();
            console.log('SharedData initialized');
            checkAllBarbers();
        }

        async function checkAllBarbers() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>Checking all staff members...</h2>';

            try {
                const currentShopId = SharedData.getCurrentShopId();

                // Get all barbers from database
                const { data, error } = await supabaseClient
                    .from('barbers')
                    .select('*')
                    .eq('shop_id', currentShopId)
                    .order('display_order');

                if (error) throw error;

                let html = '';
                let hasProblems = false;

                for (const barber of data) {
                    const isNameOwner = barber.name.toLowerCase() === 'owner';
                    const hasProblem = !isNameOwner && barber.is_owner;

                    if (hasProblem) hasProblems = true;

                    html += `<div class="barber-card">`;
                    html += `<div class="barber-name">${barber.name}</div>`;
                    html += `<div class="property">`;
                    html += `<span class="property-label">ID:</span>`;
                    html += `<span>${barber.id}</span>`;
                    html += `</div>`;
                    html += `<div class="property">`;
                    html += `<span class="property-label">Is Owner (in DB):</span>`;
                    html += `<span class="${barber.is_owner}">${barber.is_owner}</span>`;
                    html += `</div>`;
                    html += `<div class="property">`;
                    html += `<span class="property-label">Uses Store Hours (in DB):</span>`;
                    html += `<span class="${barber.uses_store_hours}">${barber.uses_store_hours}</span>`;
                    html += `</div>`;

                    if (hasProblem) {
                        html += `<div class="problem">`;
                        html += `‚ö†Ô∏è PROBLEM: ${barber.name} is incorrectly marked as owner!`;
                        html += `<br><button class="fix-button" onclick="fixBarber('${barber.id}', '${barber.name}')">Fix ${barber.name}</button>`;
                        html += `</div>`;
                    } else if (isNameOwner && barber.is_owner) {
                        html += `<div class="success">‚úÖ Correctly marked as owner</div>`;
                    } else if (!isNameOwner && !barber.is_owner) {
                        html += `<div class="success">‚úÖ Correctly marked as staff</div>`;
                    }

                    html += `</div>`;
                }

                if (hasProblems) {
                    html = '<div class="problem">‚ö†Ô∏è Found staff members incorrectly marked as owners!</div>' + html;
                } else {
                    html = '<div class="success">‚úÖ All staff members have correct owner flags</div>' + html;
                }

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<div class="problem">Error: ${error.message}</div>`;
            }
        }

        async function fixBarber(barberId, barberName) {
            const results = document.getElementById('results');

            try {
                const currentShopId = SharedData.getCurrentShopId();

                // Fix the is_owner flag to false for this barber
                const { error } = await supabaseClient
                    .from('barbers')
                    .update({
                        is_owner: false,
                        uses_store_hours: false  // Also ensure they can have custom hours
                    })
                    .eq('id', barberId)
                    .eq('shop_id', currentShopId);

                if (error) throw error;

                alert(`‚úÖ Fixed ${barberName} - no longer marked as owner`);

                // Refresh the list
                checkAllBarbers();

            } catch (error) {
                alert(`Error fixing ${barberName}: ${error.message}`);
            }
        }

        async function fixAllNonOwners() {
            const results = document.getElementById('results');

            try {
                const currentShopId = SharedData.getCurrentShopId();

                // Get all barbers
                const { data, error: fetchError } = await supabaseClient
                    .from('barbers')
                    .select('*')
                    .eq('shop_id', currentShopId);

                if (fetchError) throw fetchError;

                let fixedCount = 0;

                for (const barber of data) {
                    const isNameOwner = barber.name.toLowerCase() === 'owner';

                    // If name is not "Owner" but is_owner is true, fix it
                    if (!isNameOwner && barber.is_owner) {
                        const { error } = await supabaseClient
                            .from('barbers')
                            .update({
                                is_owner: false,
                                uses_store_hours: false  // Allow custom hours
                            })
                            .eq('id', barber.id)
                            .eq('shop_id', currentShopId);

                        if (!error) {
                            fixedCount++;
                            console.log(`Fixed ${barber.name}`);
                        }
                    }
                }

                if (fixedCount > 0) {
                    alert(`‚úÖ Fixed ${fixedCount} staff member(s)`);
                } else {
                    alert('No staff members needed fixing');
                }

                // Refresh the list
                checkAllBarbers();

            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(initialize, 500);
        });
    </script>
</body>
</html>